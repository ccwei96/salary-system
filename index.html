<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
:root {
  /* Light Theme - Clean & Modern */
  --bg-main: #f8fafc;
  --bg-sidebar: #ffffff;
  --bg-card: #ffffff;
  --bg-elevated: #f1f5f9;
  --bg-input: #f8fafc;
  
  /* Vibrant Gradient Colors */
  --gradient-coral: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 50%, #ffa8a8 100%);
  --gradient-green: linear-gradient(135deg, #10b981 0%, #34d399 50%, #6ee7b7 100%);
  --gradient-blue: linear-gradient(135deg, #3b82f6 0%, #60a5fa 50%, #93c5fd 100%);
  --gradient-purple: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 50%, #c4b5fd 100%);
  --gradient-orange: linear-gradient(135deg, #f97316 0%, #fb923c 50%, #fdba74 100%);
  --gradient-pink: linear-gradient(135deg, #ec4899 0%, #f472b6 50%, #f9a8d4 100%);
  --gradient-teal: linear-gradient(135deg, #14b8a6 0%, #2dd4bf 50%, #5eead4 100%);
  --gradient-yellow: linear-gradient(135deg, #eab308 0%, #facc15 50%, #fde047 100%);
  
  /* Soft Background Gradients */
  --gradient-coral-soft: linear-gradient(135deg, #fff5f5 0%, #ffe3e3 100%);
  --gradient-green-soft: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
  --gradient-blue-soft: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
  --gradient-purple-soft: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
  --gradient-yellow-soft: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%);
  --gradient-orange-soft: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
  
  /* Status Colors */
  --success: #10b981;
  --success-bg: #ecfdf5;
  --warning: #f59e0b;
  --warning-bg: #fffbeb;
  --error: #ef4444;
  --error-bg: #fef2f2;
  --info: #3b82f6;
  --info-bg: #eff6ff;
  
  /* Text */
  --text-primary: #1e293b;
  --text-secondary: #64748b;
  --text-muted: #94a3b8;
  --text-inverse: #ffffff;
  
  /* Borders */
  --border: #e2e8f0;
  --border-light: #f1f5f9;
  
  /* Shadows */
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
  --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
  --shadow-card: 0 2px 8px rgba(0, 0, 0, 0.06);
  --shadow-stat: 0 8px 24px rgba(0, 0, 0, 0.12);
  
  /* Radius */
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  --radius-2xl: 24px;
  --radius-full: 9999px;
  
  /* Sidebar */
  --sidebar-width: 260px;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  font-size: 14px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg-main);
  color: var(--text-primary);
  line-height: 1.6;
  min-height: 100vh;
}

.mono {
  font-family: 'JetBrains Mono', monospace;
}

/* ========== Scrollbar ========== */
::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}
::-webkit-scrollbar-track {
  background: transparent;
}
::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 3px;
}
::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

/* ========== Loading ========== */
.loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(8px);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 16px;
  z-index: 99999;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}
.loading-overlay.show {
  opacity: 1;
  visibility: visible;
}
.loading-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--info);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
.loading-text {
  color: var(--text-secondary);
  font-size: 14px;
  font-weight: 500;
}

/* ========== Toast ========== */
.toast-container {
  position: fixed;
  top: 24px;
  right: 24px;
  z-index: 99999;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.toast {
  padding: 14px 18px;
  background: white;
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 14px;
  font-weight: 500;
  min-width: 280px;
  max-width: 400px;
  animation: toast-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  border-left: 4px solid;
}
.toast.success { border-left-color: var(--success); }
.toast.error { border-left-color: var(--error); }
.toast.warning { border-left-color: var(--warning); }
.toast.info { border-left-color: var(--info); }
.toast-icon {
  width: 28px;
  height: 28px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
}
.toast.success .toast-icon { background: var(--success-bg); }
.toast.error .toast-icon { background: var(--error-bg); }
.toast.warning .toast-icon { background: var(--warning-bg); }
.toast.info .toast-icon { background: var(--info-bg); }
.toast-close {
  margin-left: auto;
  cursor: pointer;
  opacity: 0.4;
  padding: 4px;
  transition: opacity 0.2s;
}
.toast-close:hover { opacity: 1; }
@keyframes toast-in {
  from { opacity: 0; transform: translateX(20px) scale(0.9); }
  to { opacity: 1; transform: translateX(0) scale(1); }
}

/* ========== Login ========== */
#login-section {
  display: none;
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  align-items: center;
  justify-content: center;
  padding: 24px;
  position: relative;
  overflow: hidden;
}
#login-section::before {
  content: '';
  position: absolute;
  width: 600px;
  height: 600px;
  background: rgba(255,255,255,0.1);
  border-radius: 50%;
  top: -200px;
  right: -200px;
}
#login-section::after {
  content: '';
  position: absolute;
  width: 400px;
  height: 400px;
  background: rgba(255,255,255,0.05);
  border-radius: 50%;
  bottom: -100px;
  left: -100px;
}
.login-container {
  width: 100%;
  max-width: 420px;
  position: relative;
  z-index: 1;
  animation: fade-up 0.6s ease-out;
}
@keyframes fade-up {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}
.login-card {
  background: white;
  border-radius: var(--radius-2xl);
  padding: 48px 40px;
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
}
.login-brand {
  text-align: center;
  margin-bottom: 36px;
}
.login-logo {
  width: 72px;
  height: 72px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: var(--radius-xl);
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 20px;
  font-size: 32px;
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
}
.login-title {
  font-size: 26px;
  font-weight: 800;
  color: var(--text-primary);
  margin-bottom: 6px;
}
.login-subtitle {
  color: var(--text-muted);
  font-size: 14px;
}

/* ========== Form Elements ========== */
.form-group {
  margin-bottom: 20px;
}
.form-label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 8px;
}
.form-input, .form-select {
  width: 100%;
  padding: 12px 16px;
  background: var(--bg-input);
  border: 2px solid var(--border);
  border-radius: var(--radius-md);
  color: var(--text-primary);
  font-size: 14px;
  font-family: inherit;
  font-weight: 500;
  outline: none;
  transition: all 0.2s ease;
}
.form-input:hover, .form-select:hover {
  border-color: #cbd5e1;
}
.form-input:focus, .form-select:focus {
  border-color: var(--info);
  background: white;
  box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}
.form-input::placeholder {
  color: var(--text-muted);
}
.form-select {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 14px center;
  padding-right: 44px;
}
.form-hint {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 6px;
}

/* ========== Buttons ========== */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 12px 20px;
  border-radius: var(--radius-md);
  border: none;
  font-size: 14px;
  font-weight: 600;
  font-family: inherit;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}
.btn:active { transform: scale(0.98); }
.btn-block { width: 100%; }
.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  box-shadow: 0 4px 14px rgba(102, 126, 234, 0.4);
}
.btn-primary:hover {
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
  transform: translateY(-2px);
}
.btn-secondary {
  background: var(--bg-elevated);
  color: var(--text-primary);
  border: 1px solid var(--border);
}
.btn-secondary:hover {
  background: var(--border-light);
  border-color: #cbd5e1;
}
.btn-success {
  background: var(--gradient-green);
  color: white;
  box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);
}
.btn-success:hover {
  box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
  transform: translateY(-2px);
}
.btn-danger {
  background: var(--gradient-coral);
  color: white;
}
.btn-purple {
  background: var(--gradient-purple);
  color: white;
  box-shadow: 0 4px 14px rgba(139, 92, 246, 0.3);
}
.btn-purple:hover {
  box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
  transform: translateY(-2px);
}
.btn-ghost {
  background: transparent;
  color: var(--text-secondary);
  padding: 10px 14px;
}
.btn-ghost:hover {
  background: var(--bg-elevated);
  color: var(--text-primary);
}
.btn-sm {
  padding: 8px 14px;
  font-size: 13px;
}
.btn-xs {
  padding: 6px 10px;
  font-size: 12px;
  border-radius: var(--radius-sm);
}
.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}
.btn.loading { color: transparent; }
.btn.loading::after {
  content: '';
  position: absolute;
  width: 18px;
  height: 18px;
  border: 2px solid transparent;
  border-top-color: currentColor;
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
.btn-primary.loading::after { border-top-color: white; }
.btn-group {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

/* ========== Layout ========== */
#app-section {
  display: none;
  min-height: 100vh;
}
.app-layout {
  display: flex;
  min-height: 100vh;
}

/* ========== Sidebar ========== */
.sidebar {
  width: var(--sidebar-width);
  background: var(--bg-sidebar);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  position: fixed;
  left: 0;
  top: 0;
  bottom: 0;
  z-index: 100;
}
.sidebar-header {
  padding: 20px;
  border-bottom: 1px solid var(--border-light);
}
.sidebar-brand {
  display: flex;
  align-items: center;
  gap: 12px;
}
.sidebar-logo {
  width: 42px;
  height: 42px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}
.sidebar-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
}
.sidebar-nav {
  flex: 1;
  padding: 16px 12px;
  overflow-y: auto;
}
.nav-section {
  margin-bottom: 24px;
}
.nav-section-title {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 0 12px;
  margin-bottom: 8px;
}
.nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 11px 14px;
  border-radius: var(--radius-md);
  color: var(--text-secondary);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  margin-bottom: 4px;
}
.nav-item:hover {
  background: var(--bg-elevated);
  color: var(--text-primary);
}
.nav-item.active {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
  color: #667eea;
}
.nav-item-icon {
  font-size: 18px;
  width: 24px;
  text-align: center;
}
.nav-item-badge {
  margin-left: auto;
  background: var(--error);
  color: white;
  font-size: 11px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: var(--radius-full);
}
.sidebar-footer {
  padding: 16px;
  border-top: 1px solid var(--border-light);
}
.user-card {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: var(--radius-md);
  background: var(--bg-elevated);
  margin-bottom: 12px;
}
.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: var(--radius-md);
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 16px;
  color: white;
}
.user-info { flex: 1; min-width: 0; }
.user-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.user-role {
  font-size: 12px;
  color: var(--text-muted);
}
.user-actions {
  display: flex;
  gap: 8px;
}
.user-action-btn {
  flex: 1;
  padding: 10px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: white;
  color: var(--text-secondary);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}
.user-action-btn:hover {
  border-color: #cbd5e1;
  color: var(--text-primary);
}
.user-action-btn.logout {
  color: var(--error);
  border-color: rgba(239, 68, 68, 0.3);
}
.user-action-btn.logout:hover {
  background: var(--error-bg);
  border-color: var(--error);
}

/* ========== Main Content ========== */
.main-content {
  flex: 1;
  margin-left: var(--sidebar-width);
  padding: 28px 32px;
}
.page-header {
  margin-bottom: 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.page-header-left {}
.page-title {
  font-size: 26px;
  font-weight: 800;
  color: var(--text-primary);
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.page-subtitle {
  color: var(--text-secondary);
  font-size: 14px;
}
.page-header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}
.month-selector {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  background: white;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  font-size: 14px;
  color: var(--text-secondary);
}

/* ========== Stat Cards - Vibrant ========== */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin-bottom: 28px;
}
.stat-card {
  border-radius: var(--radius-xl);
  padding: 24px;
  color: white;
  position: relative;
  overflow: hidden;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: var(--shadow-stat);
}
.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 32px rgba(0, 0, 0, 0.18);
}
.stat-card.coral { background: var(--gradient-coral); }
.stat-card.green { background: var(--gradient-green); }
.stat-card.blue { background: var(--gradient-blue); }
.stat-card.purple { background: var(--gradient-purple); }
.stat-card.orange { background: var(--gradient-orange); }
.stat-card.pink { background: var(--gradient-pink); }
.stat-card.teal { background: var(--gradient-teal); }
.stat-card.yellow { background: var(--gradient-yellow); color: #713f12; }
.stat-card::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 100%;
  height: 100%;
  background: rgba(255,255,255,0.1);
  border-radius: 50%;
}
.stat-card-inner {
  position: relative;
  z-index: 1;
  display: flex;
  align-items: flex-start;
  gap: 16px;
}
.stat-icon {
  width: 48px;
  height: 48px;
  border-radius: var(--radius-md);
  background: rgba(255,255,255,0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  flex-shrink: 0;
}
.stat-content {}
.stat-value {
  font-size: 32px;
  font-weight: 800;
  line-height: 1.1;
  margin-bottom: 4px;
}
.stat-value.animate-number {
  transition: transform 0.3s ease;
}
.stat-label {
  font-size: 14px;
  opacity: 0.9;
  font-weight: 500;
}

/* ========== 骨架屏加载 ========== */
.skeleton {
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: skeleton-loading 1.5s infinite;
  border-radius: 8px;
}
@keyframes skeleton-loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
.skeleton-card {
  background: white;
  border-radius: 16px;
  padding: 20px;
  border: 1px solid #E5E7EB;
}
.skeleton-avatar {
  width: 56px;
  height: 56px;
  border-radius: 50%;
}
.skeleton-text {
  height: 14px;
  margin-bottom: 8px;
}
.skeleton-text.short { width: 60%; }
.skeleton-text.medium { width: 80%; }
.skeleton-text.long { width: 100%; }
.skeleton-stat {
  height: 32px;
  width: 80px;
  margin-bottom: 8px;
}

/* ========== 可搜索下拉框 ========== */
.searchable-select-wrapper {
  position: relative;
}
.searchable-select-input {
  width: 100%;
  padding: 12px 40px 12px 14px;
  border: 2px solid var(--border);
  border-radius: var(--radius-md);
  font-size: 14px;
  cursor: pointer;
  background: white;
  transition: all 0.2s;
}
.searchable-select-input:focus {
  border-color: var(--primary);
  outline: none;
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}
.searchable-select-input::placeholder {
  color: #9CA3AF;
}
.searchable-select-arrow {
  position: absolute;
  right: 14px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  color: #6B7280;
  transition: transform 0.2s;
}
.searchable-select-wrapper.open .searchable-select-arrow {
  transform: translateY(-50%) rotate(180deg);
}
.searchable-select-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 2px solid var(--primary);
  border-radius: var(--radius-md);
  margin-top: 4px;
  max-height: 280px;
  overflow-y: auto;
  z-index: 1000;
  box-shadow: var(--shadow-lg);
  display: none;
}
.searchable-select-wrapper.open .searchable-select-dropdown {
  display: block;
}
.searchable-select-option {
  padding: 12px 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: background 0.15s;
}
.searchable-select-option:hover {
  background: var(--bg-secondary);
}
.searchable-select-option.selected {
  background: var(--primary-light);
  color: var(--primary);
}
.searchable-select-option-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
  font-size: 14px;
  flex-shrink: 0;
}
.searchable-select-option-info {
  flex: 1;
  min-width: 0;
}
.searchable-select-option-name {
  font-weight: 600;
  font-size: 14px;
  color: var(--text-primary);
}
.searchable-select-option-sub {
  font-size: 12px;
  color: var(--text-secondary);
}
.searchable-select-empty {
  padding: 20px;
  text-align: center;
  color: var(--text-secondary);
  font-size: 14px;
}

/* ========== 页面过渡动画 ========== */
.page {
  animation: pageIn 0.3s ease-out;
}
@keyframes pageIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ========== 按钮涟漪效果 ========== */
.btn {
  position: relative;
  overflow: hidden;
}
.btn::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: width 0.4s ease, height 0.4s ease;
}
.btn:active::after {
  width: 200px;
  height: 200px;
}

/* ========== 成功动画 ========== */
.success-animation-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}
.success-animation-overlay.show {
  opacity: 1;
  visibility: visible;
}
.success-animation-box {
  background: white;
  border-radius: 20px;
  padding: 40px 60px;
  text-align: center;
  transform: scale(0.8);
  transition: transform 0.3s;
}
.success-animation-overlay.show .success-animation-box {
  transform: scale(1);
}
.success-checkmark {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(135deg, #10B981 0%, #059669 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 20px;
  animation: checkPop 0.5s ease;
}
@keyframes checkPop {
  0% { transform: scale(0); }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); }
}
.success-checkmark svg {
  width: 40px;
  height: 40px;
  stroke: white;
  stroke-width: 3;
  fill: none;
  stroke-dasharray: 50;
  stroke-dashoffset: 50;
  animation: checkDraw 0.5s ease 0.3s forwards;
}
@keyframes checkDraw {
  to { stroke-dashoffset: 0; }
}
.success-text {
  font-size: 24px;
  font-weight: 700;
  color: #1F2937;
  margin-bottom: 8px;
}
.success-subtext {
  font-size: 16px;
  color: #6B7280;
}

/* ========== 撒花效果 ========== */
.confetti {
  position: absolute;
  width: 10px;
  height: 10px;
  opacity: 0;
}
.confetti.active {
  animation: confettiFall 1s ease-out forwards;
}
@keyframes confettiFall {
  0% {
    opacity: 1;
    transform: translateY(0) rotate(0deg);
  }
  100% {
    opacity: 0;
    transform: translateY(100px) rotate(720deg);
  }
}

/* ========== 排序指示器 ========== */
.sortable-header {
  cursor: pointer;
  user-select: none;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}
.sortable-header:hover {
  color: var(--primary);
}
.sort-indicator {
  font-size: 10px;
  opacity: 0.5;
}
.sort-indicator.active {
  opacity: 1;
  color: var(--primary);
}

/* ========== 分页器 ========== */
.pagination {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin-top: 20px;
  padding: 16px;
}
.pagination-btn {
  min-width: 36px;
  height: 36px;
  border: 1px solid var(--border);
  background: white;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.pagination-btn:hover:not(:disabled) {
  border-color: var(--primary);
  color: var(--primary);
}
.pagination-btn.active {
  background: var(--primary);
  border-color: var(--primary);
  color: white;
}
.pagination-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
.pagination-info {
  font-size: 14px;
  color: var(--text-secondary);
  margin: 0 12px;
}

/* ========== 快捷金额按钮 ========== */
.quick-amount-btns {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-top: 8px;
}
.quick-amount-btn {
  padding: 4px 10px;
  border: 1px solid #E5E7EB;
  background: linear-gradient(180deg, #FFFFFF 0%, #F9FAFB 100%);
  border-radius: 16px;
  font-size: 12px;
  font-weight: 500;
  color: #4B5563;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}
.quick-amount-btn:hover {
  border-color: #3B82F6;
  color: #3B82F6;
  background: linear-gradient(180deg, #EFF6FF 0%, #DBEAFE 100%);
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(59,130,246,0.15);
}
.quick-amount-btn:active {
  transform: translateY(0);
}
.quick-amount-btn.set-btn {
  background: linear-gradient(180deg, #F0FDF4 0%, #DCFCE7 100%);
  border-color: #86EFAC;
  color: #059669;
}
.quick-amount-btn.set-btn:hover {
  background: linear-gradient(180deg, #DCFCE7 0%, #BBF7D0 100%);
  border-color: #22C55E;
}
.quick-amount-btn.clear-btn {
  background: linear-gradient(180deg, #FEF2F2 0%, #FEE2E2 100%);
  border-color: #FECACA;
  color: #DC2626;
}
.quick-amount-btn.clear-btn:hover {
  background: linear-gradient(180deg, #FEE2E2 0%, #FECACA 100%);
  border-color: #F87171;
}

/* ========== 表单实时验证 ========== */
.form-input.error {
  border-color: #EF4444;
  background: #FEF2F2;
}
.form-input.success {
  border-color: #10B981;
}
.form-error-msg {
  color: #EF4444;
  font-size: 12px;
  margin-top: 4px;
  display: none;
}
.form-group.has-error .form-error-msg {
  display: block;
}

/* ========== 入职天数标签 ========== */
.days-badge {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 10px;
  background: #EFF6FF;
  color: #3B82F6;
}
.days-badge.new {
  background: #D1FAE5;
  color: #059669;
}

/* ========== 刷新按钮旋转 ========== */
.refresh-btn.spinning {
  animation: spin 1s linear infinite;
}
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* ========== 空状态引导 ========== */
.empty-state-action {
  margin-top: 16px;
}
.empty-state-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}
.empty-state-btn:hover {
  background: var(--primary-hover);
  transform: translateY(-2px);
}

/* ========== 提醒卡片优化 ========== */
.alert-cards-grid {
  align-items: stretch;
}
.alert-card {
  display: flex;
  flex-direction: column;
  min-height: 360px;
  max-height: 400px;
}
.alert-card-body {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 0 !important;
  min-height: 200px;
  max-height: 240px;
}
.alert-card-scroll {
  flex: 1;
  max-height: 220px;
  overflow-y: auto;
  padding: 12px 16px;
}
.alert-card-scroll::-webkit-scrollbar {
  width: 4px;
}
.alert-card-scroll::-webkit-scrollbar-track {
  background: #F3F4F6;
  border-radius: 4px;
}
.alert-card-scroll::-webkit-scrollbar-thumb {
  background: #D1D5DB;
  border-radius: 4px;
}
.alert-card-scroll::-webkit-scrollbar-thumb:hover {
  background: #9CA3AF;
}

/* 提醒卡片空状态 - 统一美化样式 */
.alert-card-empty {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 32px 16px;
  text-align: center;
  background: linear-gradient(180deg, #F0FDF4 0%, #DCFCE7 100%);
  border-radius: 12px;
  margin: 12px 16px;
}
.alert-card-empty.warning-empty {
  background: linear-gradient(180deg, #FEF3C7 0%, #FDE68A 100%);
}
.alert-card-empty.info-empty {
  background: linear-gradient(180deg, #EFF6FF 0%, #DBEAFE 100%);
}
.alert-card-empty.neutral-empty {
  background: linear-gradient(180deg, #F9FAFB 0%, #F3F4F6 100%);
}
.alert-empty-icon {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  margin-bottom: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
.alert-empty-text {
  font-size: 15px;
  font-weight: 600;
  color: #059669;
  margin-bottom: 4px;
}
.alert-card-empty.warning-empty .alert-empty-text {
  color: #B45309;
}
.alert-card-empty.info-empty .alert-empty-text {
  color: #1D4ED8;
}
.alert-card-empty.neutral-empty .alert-empty-text {
  color: #374151;
}
.alert-empty-subtext {
  font-size: 13px;
  color: #6B7280;
}

/* 提醒卡片底部汇总 */
.alert-card-footer {
  padding: 12px 16px;
  background: linear-gradient(180deg, #F9FAFB 0%, #F3F4F6 100%);
  border-top: 1px solid var(--border-light);
  border-radius: 0 0 var(--radius-xl) var(--radius-xl);
  font-size: 12px;
  color: var(--text-secondary);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
}
.alert-summary-item {
  display: flex;
  align-items: center;
  gap: 4px;
}
.alert-summary-value {
  font-weight: 600;
  color: var(--text-primary);
}
.alert-summary-total {
  font-weight: 700;
  color: #059669;
  font-size: 13px;
}

/* 离职员工灰色头像 */
.alert-item-avatar.left-staff {
  background: linear-gradient(135deg, #9CA3AF 0%, #6B7280 100%) !important;
  opacity: 0.8;
}

/* 提醒卡片项悬停效果 */
.alert-item {
  transition: transform 0.2s, box-shadow 0.2s;
}
.alert-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* ========== Cards ========== */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-xl);
  margin-bottom: 24px;
  box-shadow: var(--shadow-card);
}
.card-header {
  padding: 20px 24px;
  border-bottom: 1px solid var(--border-light);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 16px;
}
.card-header.clickable-card-header {
  cursor: pointer;
  transition: background 0.2s;
  border-radius: var(--radius-xl) var(--radius-xl) 0 0;
}
.card-header.clickable-card-header:hover {
  background: var(--bg-secondary);
}
.card-header-left {
  display: flex;
  align-items: center;
  gap: 14px;
}
.card-icon {
  width: 44px;
  height: 44px;
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}
.card-icon.coral { background: var(--gradient-coral-soft); }
.card-icon.green { background: var(--gradient-green-soft); }
.card-icon.blue { background: var(--gradient-blue-soft); }
.card-icon.purple { background: var(--gradient-purple-soft); }
.card-icon.yellow { background: var(--gradient-yellow-soft); }
.card-icon.orange { background: var(--gradient-orange-soft); }
.card-title {
  font-size: 16px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 2px;
}
.card-subtitle {
  font-size: 13px;
  color: var(--text-muted);
}
.card-body {
  padding: 24px;
}

/* ========== Badges ========== */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 5px 12px;
  border-radius: var(--radius-full);
  font-size: 12px;
  font-weight: 600;
}
.badge-draft {
  background: var(--gradient-purple-soft);
  color: #7c3aed;
}
.badge-pending {
  background: var(--gradient-yellow-soft);
  color: #b45309;
}
.badge-paid, .badge-success {
  background: var(--gradient-green-soft);
  color: #059669;
}
.badge-active {
  background: var(--gradient-green-soft);
  color: #059669;
}
.badge-left {
  background: var(--bg-elevated);
  color: var(--text-muted);
}
.badge-cash {
  background: var(--gradient-purple-soft);
  color: #7c3aed;
}
.badge-transfer {
  background: var(--gradient-blue-soft);
  color: #2563eb;
}
.badge-manager {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}
.badge-error {
  background: var(--error-bg);
  color: var(--error);
}
.badge-warning {
  background: #FEF3C7;
  color: #D97706;
}
.badge-current {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-size: 10px;
  padding: 2px 8px;
}
.badge-info {
  background: var(--info-bg);
  color: var(--info);
}

/* ========== Staff Cards Grid ========== */
.staff-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 20px;
}
.staff-card {
  background: white;
  border: 1px solid var(--border);
  border-radius: var(--radius-xl);
  padding: 20px;
  transition: all 0.2s ease;
  position: relative;
}
.staff-card:hover {
  border-color: #cbd5e1;
  box-shadow: var(--shadow-md);
}
.staff-card-header {
  display: flex;
  align-items: center;
  gap: 14px;
  margin-bottom: 16px;
}
.staff-avatar {
  width: 48px;
  height: 48px;
  border-radius: var(--radius-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 18px;
  color: white;
  flex-shrink: 0;
}
.staff-avatar.teal { background: var(--gradient-teal); }
.staff-avatar.blue { background: var(--gradient-blue); }
.staff-avatar.purple { background: var(--gradient-purple); }
.staff-avatar.coral { background: var(--gradient-coral); }
.staff-avatar.orange { background: var(--gradient-orange); }
.staff-avatar.green { background: var(--gradient-green); }
.staff-name {
  font-size: 16px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 2px;
}
.staff-company {
  font-size: 13px;
  color: var(--text-muted);
}
.staff-card-info {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
  margin-bottom: 16px;
}
.staff-info-item {
  display: flex;
  align-items: center;
  gap: 8px;
}
.staff-info-icon {
  width: 32px;
  height: 32px;
  border-radius: var(--radius-sm);
  background: var(--bg-elevated);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
}
.staff-info-content {}
.staff-info-label {
  font-size: 11px;
  color: var(--text-muted);
}
.staff-info-value {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
}
.staff-info-value.salary {
  color: #059669;
}
.staff-bank-info {
  background: var(--bg-elevated);
  border-radius: var(--radius-md);
  padding: 12px 14px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.staff-bank-icon {
  font-size: 18px;
}
.staff-bank-details {
  flex: 1;
}
.staff-bank-name {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
}
.staff-bank-account {
  font-size: 12px;
  color: var(--text-muted);
  font-family: 'JetBrains Mono', monospace;
}
.staff-card-actions {
  display: flex;
  gap: 8px;
}
.staff-action-btn {
  flex: 1;
  padding: 10px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
  background: white;
  color: var(--text-secondary);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}
.staff-action-btn:hover {
  border-color: var(--info);
  color: var(--info);
  background: var(--info-bg);
}
.staff-action-btn.danger:hover {
  border-color: var(--error);
  color: var(--error);
  background: var(--error-bg);
}
.staff-action-btn.success {
  border-color: var(--success);
  color: var(--success);
}
.staff-action-btn.success:hover {
  background: var(--success-bg);
}

/* ========== Tables ========== */
.table-container {
  overflow-x: auto;
  border-radius: var(--radius-md);
  border: 1px solid var(--border);
}
table {
  width: 100%;
  border-collapse: collapse;
}
th {
  background: var(--bg-elevated);
  padding: 14px 16px;
  text-align: left;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  color: var(--text-secondary);
  white-space: nowrap;
}
td {
  padding: 14px 16px;
  border-top: 1px solid var(--border-light);
  font-size: 14px;
  vertical-align: middle;
}
tr { transition: background 0.2s; }
tbody tr:hover { background: rgba(0, 0, 0, 0.02); }
.td-mono {
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
}
.td-name {
  display: flex;
  align-items: center;
  gap: 12px;
}
.td-avatar {
  width: 36px;
  height: 36px;
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 14px;
  color: white;
  flex-shrink: 0;
}
.td-info {}
.td-main {
  font-weight: 600;
  color: var(--text-primary);
}
.td-sub {
  font-size: 12px;
  color: var(--text-muted);
}

/* ========== Table Row Highlights ========== */
.row-changed {
  background: var(--error-bg) !important;
}
.row-changed:hover {
  background: #fecaca !important;
}
.row-highlight {
  background: var(--warning-bg) !important;
}
.row-highlight:hover {
  background: #fef3c7 !important;
}

/* ========== Checkbox ========== */
.checkbox {
  width: 18px;
  height: 18px;
  border-radius: 5px;
  border: 2px solid #cbd5e1;
  background: white;
  cursor: pointer;
  appearance: none;
  transition: all 0.15s;
  position: relative;
}
.checkbox:hover { border-color: var(--info); }
.checkbox:checked {
  background: var(--info);
  border-color: var(--info);
}
.checkbox:checked::after {
  content: '';
  position: absolute;
  left: 5px;
  top: 2px;
  width: 4px;
  height: 8px;
  border: solid white;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

/* ========== Progress ========== */
.progress-container {
  margin-bottom: 20px;
}
.progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.progress-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
}
.progress-value {
  font-size: 14px;
  font-weight: 700;
  font-family: 'JetBrains Mono', monospace;
}
.progress-track {
  height: 10px;
  background: var(--bg-elevated);
  border-radius: 5px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  border-radius: 5px;
  transition: width 0.5s ease;
}
.progress-fill.green { background: var(--gradient-green); }
.progress-fill.blue { background: var(--gradient-blue); }
.progress-fill.coral { background: var(--gradient-coral); }

/* ========== Alert Cards ========== */
.alert-card {
  padding: 14px 16px;
  background: white;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 14px;
}
.alert-card:hover {
  border-color: #cbd5e1;
  transform: translateX(4px);
}
.alert-card.warning {
  border-left: 3px solid var(--warning);
  background: var(--warning-bg);
}
.alert-card.danger {
  border-left: 3px solid var(--error);
  background: var(--error-bg);
}
.alert-card.info {
  border-left: 3px solid var(--info);
  background: var(--info-bg);
}
.alert-card.success {
  border-left: 3px solid var(--success);
  background: var(--success-bg);
}
.alert-icon {
  font-size: 24px;
  flex-shrink: 0;
}
.alert-content { flex: 1; }
.alert-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 2px;
}
.alert-text {
  font-size: 13px;
  color: var(--text-secondary);
}

/* ========== Quick Actions ========== */
.quick-actions {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 16px;
}
.quick-action-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  padding: 24px 16px;
  background: white;
  border: 1px solid var(--border);
  border-radius: var(--radius-xl);
  cursor: pointer;
  transition: all 0.2s ease;
}
.quick-action-btn:hover {
  border-color: transparent;
  box-shadow: var(--shadow-md);
  transform: translateY(-4px);
}
.quick-action-icon {
  width: 52px;
  height: 52px;
  border-radius: var(--radius-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
}
.quick-action-icon.coral { background: var(--gradient-coral-soft); }
.quick-action-icon.green { background: var(--gradient-green-soft); }
.quick-action-icon.blue { background: var(--gradient-blue-soft); }
.quick-action-icon.purple { background: var(--gradient-purple-soft); }
.quick-action-icon.yellow { background: var(--gradient-yellow-soft); }
.quick-action-text {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
}

/* ========== Summary Bar ========== */
.summary-bar {
  display: flex;
  align-items: center;
  gap: 20px;
  padding: 12px 18px;
  background: var(--bg-elevated);
  border-radius: var(--radius-md);
  margin-left: auto;
  font-size: 13px;
}
.summary-item {
  display: flex;
  align-items: center;
  gap: 6px;
}
.summary-label {
  color: var(--text-muted);
}
.summary-value {
  font-family: 'JetBrains Mono', monospace;
  font-weight: 600;
}
.summary-value.green { color: #059669; }
.summary-value.purple { color: #7c3aed; }
.summary-value.blue { color: #2563eb; }

/* ========== Filters ========== */
.filter-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}
.filter-btn {
  padding: 8px 16px;
  border-radius: var(--radius-full);
  border: 1px solid var(--border);
  background: white;
  color: var(--text-secondary);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}
.filter-btn:hover {
  border-color: #cbd5e1;
  color: var(--text-primary);
}
.filter-btn.active {
  background: var(--text-primary);
  border-color: var(--text-primary);
  color: white;
}
.search-input {
  padding: 10px 16px;
  padding-left: 40px;
  background: white;
  border: 1px solid var(--border);
  border-radius: var(--radius-full);
  font-size: 14px;
  width: 280px;
  outline: none;
  transition: all 0.2s;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' fill='%2394a3b8' viewBox='0 0 24 24'%3E%3Cpath d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z' stroke='%2394a3b8' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: 14px center;
}
.search-input:focus {
  border-color: var(--info);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* ========== Empty State ========== */
.empty-state {
  text-align: center;
  padding: 60px 24px;
}
.empty-icon {
  font-size: 56px;
  margin-bottom: 16px;
  opacity: 0.4;
}
.empty-text {
  font-size: 15px;
  color: var(--text-muted);
}

/* ========== Message ========== */
.message {
  padding: 12px 16px;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 500;
  margin-top: 16px;
  display: none;
}
.message.show { display: block; }
.message.success {
  background: var(--success-bg);
  color: var(--success);
  border: 1px solid rgba(16, 185, 129, 0.2);
}
.message.error {
  background: var(--error-bg);
  color: var(--error);
  border: 1px solid rgba(239, 68, 68, 0.2);
}

/* ========== Page Visibility ========== */
.page { display: none; }
.page.active {
  display: block;
  animation: fade-up 0.3s ease-out;
}

/* ========== Role Visibility ========== */
.role-admin, .role-accountant, .role-secretary { display: none !important; }
.role-admin-secretary, .role-admin-accountant { display: none !important; }
.role-secretary-accountant, .role-admin-secretary-accountant { display: none !important; }
.nav-section.role-admin, .nav-section.role-accountant, .nav-section.role-secretary { display: none !important; }
.nav-section.role-admin-accountant, .nav-section.role-admin-secretary { display: none !important; }
.nav-section.role-secretary-accountant, .nav-section.role-admin-secretary-accountant { display: none !important; }

body.is-admin .role-admin { display: block !important; }
body.is-admin .nav-item.role-admin, body.is-admin .nav-section.role-admin { display: flex !important; }
body.is-admin .nav-section.role-admin { display: block !important; }
body.is-admin .quick-action-btn.role-admin { display: flex !important; }
body.is-admin .stat-card.role-admin { display: block !important; }

body.is-accountant .role-accountant { display: block !important; }
body.is-accountant .nav-item.role-accountant, body.is-accountant .nav-section.role-accountant { display: flex !important; }
body.is-accountant .nav-section.role-accountant { display: block !important; }
body.is-accountant .quick-action-btn.role-accountant { display: flex !important; }

body.is-secretary .role-secretary { display: block !important; }
body.is-secretary .nav-item.role-secretary, body.is-secretary .nav-section.role-secretary { display: flex !important; }
body.is-secretary .nav-section.role-secretary { display: block !important; }
body.is-secretary .quick-action-btn.role-secretary { display: flex !important; }

body.is-admin .role-admin-accountant, body.is-accountant .role-admin-accountant { display: block !important; }
body.is-admin .nav-item.role-admin-accountant, body.is-accountant .nav-item.role-admin-accountant { display: flex !important; }
body.is-admin .nav-section.role-admin-accountant, body.is-accountant .nav-section.role-admin-accountant { display: block !important; }
body.is-admin .quick-action-btn.role-admin-accountant, body.is-accountant .quick-action-btn.role-admin-accountant { display: flex !important; }

body.is-admin .role-admin-secretary, body.is-secretary .role-admin-secretary { display: block !important; }
body.is-admin .nav-item.role-admin-secretary, body.is-secretary .nav-item.role-admin-secretary { display: flex !important; }
body.is-admin .nav-section.role-admin-secretary, body.is-secretary .nav-section.role-admin-secretary { display: block !important; }
body.is-admin .quick-action-btn.role-admin-secretary, body.is-secretary .quick-action-btn.role-admin-secretary { display: flex !important; }

/* secretary + accountant */
body.is-secretary .role-secretary-accountant, body.is-accountant .role-secretary-accountant { display: block !important; }
body.is-secretary .nav-item.role-secretary-accountant, body.is-accountant .nav-item.role-secretary-accountant { display: flex !important; }
body.is-secretary .nav-section.role-secretary-accountant, body.is-accountant .nav-section.role-secretary-accountant { display: block !important; }
body.is-secretary .quick-action-btn.role-secretary-accountant, body.is-accountant .quick-action-btn.role-secretary-accountant { display: flex !important; }

/* admin + secretary + accountant */
body.is-admin .role-admin-secretary-accountant, body.is-secretary .role-admin-secretary-accountant, body.is-accountant .role-admin-secretary-accountant { display: block !important; }
body.is-admin .nav-item.role-admin-secretary-accountant, body.is-secretary .nav-item.role-admin-secretary-accountant, body.is-accountant .nav-item.role-admin-secretary-accountant { display: flex !important; }
body.is-admin .nav-section.role-admin-secretary-accountant, body.is-secretary .nav-section.role-admin-secretary-accountant, body.is-accountant .nav-section.role-admin-secretary-accountant { display: block !important; }
body.is-admin .quick-action-btn.role-admin-secretary-accountant, body.is-secretary .quick-action-btn.role-admin-secretary-accountant, body.is-accountant .quick-action-btn.role-admin-secretary-accountant { display: flex !important; }

/* 会计只读模式 - 隐藏操作按钮 */
body.is-accountant .staff-card-actions { display: none !important; }
body.is-accountant .btn-add-staff { display: none !important; }
body.is-accountant #page-staff .page-header-right { display: none !important; }

/* ========== Modals ========== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  padding: 24px;
}
.modal-overlay.show {
  display: flex;
  animation: fade-in 0.2s ease;
}
@keyframes fade-in {
  from { opacity: 0; }
  to { opacity: 1; }
}
.modal {
  background: white;
  border-radius: var(--radius-2xl);
  width: 100%;
  max-width: 480px;
  box-shadow: var(--shadow-lg);
  animation: modal-in 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  max-height: 90vh;
  overflow-y: auto;
}
.modal.modal-lg {
  max-width: 640px;
}
.modal.modal-xl {
  max-width: 800px;
}
@keyframes modal-in {
  from { opacity: 0; transform: scale(0.95) translateY(10px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}
.modal-header {
  padding: 24px 24px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border-light);
  position: sticky;
  top: 0;
  background: white;
  z-index: 1;
}
.modal-title {
  font-size: 18px;
  font-weight: 700;
}
.modal-close {
  width: 32px;
  height: 32px;
  border-radius: var(--radius-sm);
  background: transparent;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: all 0.2s;
}
.modal-close:hover {
  background: var(--bg-elevated);
  color: var(--text-primary);
}
.modal-body { padding: 24px; }
.modal-footer {
  padding: 20px 24px 24px;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  border-top: 1px solid var(--border-light);
}

/* ========== Confirm Dialog ========== */
.confirm-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 99998;
  padding: 24px;
}
.confirm-overlay.show {
  display: flex;
  animation: fade-in 0.2s ease;
}
.confirm-dialog {
  background: white;
  border-radius: var(--radius-2xl);
  width: 100%;
  max-width: 400px;
  box-shadow: var(--shadow-lg);
  animation: modal-in 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  text-align: center;
  padding: 32px 28px 28px;
}
.confirm-icon {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  margin: 0 auto 20px;
}
.confirm-icon.warning {
  background: var(--warning-bg);
  border: 2px solid rgba(245, 158, 11, 0.3);
}
.confirm-icon.danger {
  background: var(--error-bg);
  border: 2px solid rgba(239, 68, 68, 0.3);
}
.confirm-icon.info {
  background: var(--info-bg);
  border: 2px solid rgba(59, 130, 246, 0.3);
}
.confirm-icon.success {
  background: var(--success-bg);
  border: 2px solid rgba(16, 185, 129, 0.3);
}
.confirm-icon.logout {
  background: var(--warning-bg);
  border: 2px solid rgba(245, 158, 11, 0.3);
}
.confirm-icon.submit {
  background: var(--info-bg);
  border: 2px solid rgba(59, 130, 246, 0.3);
}
.confirm-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 8px;
}
.confirm-message {
  font-size: 14px;
  color: var(--text-secondary);
  line-height: 1.6;
  margin-bottom: 24px;
}
.confirm-actions {
  display: flex;
  gap: 12px;
}
.confirm-actions .btn { flex: 1; }

/* ========== Grid ========== */
.grid { display: grid; gap: 16px; }
.grid-2 { grid-template-columns: repeat(2, 1fr); }
.grid-3 { grid-template-columns: repeat(3, 1fr); }
.grid-4 { grid-template-columns: repeat(4, 1fr); }
.grid-5 { grid-template-columns: repeat(5, 1fr); }

/* ========== Info Box ========== */
.info-box {
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 16px;
  margin-bottom: 16px;
}
.info-box-title {
  font-size: 13px;
  font-weight: 700;
  color: var(--text-secondary);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.info-box .info-item {
  margin-bottom: 8px;
}
.info-box .info-item:last-child {
  margin-bottom: 0;
}

/* ========== Info Grid ========== */
.info-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}
.info-item {
  padding: 14px;
  background: var(--bg-elevated);
  border-radius: var(--radius-md);
}
.info-label {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.3px;
  margin-bottom: 4px;
}
.info-value {
  font-size: 14px;
  font-weight: 600;
}
.info-value.accent { color: #059669; }
.info-value.warning { color: var(--warning); }
.info-value.error { color: var(--error); }

/* ========== Warning Banner ========== */
.warning-banner {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 18px;
  background: var(--warning-bg);
  border: 1px solid rgba(245, 158, 11, 0.3);
  border-radius: var(--radius-md);
  margin-bottom: 20px;
}
.warning-banner-icon {
  font-size: 20px;
  flex-shrink: 0;
}
.warning-banner-text {
  font-size: 14px;
  color: #92400e;
  flex: 1;
}
.warning-banner-link {
  color: #b45309;
  font-weight: 600;
  cursor: pointer;
  text-decoration: underline;
}

/* ========== Password Strength ========== */
.password-strength {
  margin-top: 8px;
  height: 4px;
  background: var(--bg-elevated);
  border-radius: 2px;
  overflow: hidden;
}
.password-strength-bar {
  height: 100%;
  width: 0%;
  transition: all 0.3s ease;
  border-radius: 2px;
}
.password-strength-bar.weak { width: 33%; background: var(--error); }
.password-strength-bar.medium { width: 66%; background: var(--warning); }
.password-strength-bar.strong { width: 100%; background: var(--success); }
.password-strength-text {
  font-size: 11px;
  margin-top: 4px;
  color: var(--text-muted);
}

/* ========== Tabs ========== */
.tabs {
  display: flex;
  gap: 4px;
  padding: 4px;
  background: var(--bg-elevated);
  border-radius: var(--radius-full);
  margin-bottom: 20px;
  width: fit-content;
}
.tab {
  padding: 10px 20px;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-secondary);
  background: transparent;
  border: none;
  border-radius: var(--radius-full);
  cursor: pointer;
  transition: all 0.2s;
}
.tab:hover {
  color: var(--text-primary);
}
.tab.active {
  background: white;
  color: var(--text-primary);
  box-shadow: var(--shadow-sm);
}

/* ========== Bank Summary ========== */
.bank-group {
  margin-bottom: 20px;
}
.bank-group-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: var(--bg-elevated);
  border-radius: var(--radius-md) var(--radius-md) 0 0;
  border: 1px solid var(--border);
  border-bottom: none;
}
.bank-group-title {
  font-size: 14px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}
.bank-group-total {
  font-family: 'JetBrains Mono', monospace;
  font-weight: 700;
  color: #059669;
}
.bank-group-body {
  border: 1px solid var(--border);
  border-radius: 0 0 var(--radius-md) var(--radius-md);
}
.bank-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border-light);
}
.bank-item:last-child {
  border-bottom: none;
}
.bank-item-info {}
.bank-item-name {
  font-size: 14px;
  font-weight: 500;
}
.bank-item-account {
  font-size: 12px;
  color: var(--text-muted);
  font-family: 'JetBrains Mono', monospace;
}
.bank-item-amount {
  font-family: 'JetBrains Mono', monospace;
  font-weight: 600;
  color: var(--text-primary);
}

/* ========== Radio Group ========== */
.radio-group {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}
.radio-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  background: var(--bg-input);
  border: 2px solid var(--border);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all 0.2s;
}
.radio-item:hover {
  border-color: #cbd5e1;
}
.radio-item.selected,
.radio-item:has(input:checked) {
  border-color: var(--info);
  background: var(--info-bg);
}
.radio-item input[type="radio"] {
  margin: 0;
}
.radio-item-label {
  font-size: 14px;
  font-weight: 500;
}

/* ========== Responsive ========== */
@media (max-width: 1400px) {
  .grid-5 {
    grid-template-columns: repeat(3, 1fr);
  }
}
@media (max-width: 1200px) {
  .stats-grid, .grid-4, .grid-5 {
    grid-template-columns: repeat(2, 1fr);
  }
}
@media (max-width: 768px) {
  .sidebar {
    transform: translateX(-100%);
  }
  .main-content {
    margin-left: 0;
    padding: 20px;
  }
  .stats-grid, .grid-2, .grid-3, .grid-4, .grid-5 {
    grid-template-columns: 1fr;
  }
  .page-title {
    font-size: 22px;
  }
  .staff-grid {
    grid-template-columns: 1fr;
  }
  .info-grid {
    grid-template-columns: 1fr;
  }
  .filter-bar {
    flex-direction: column;
    align-items: stretch;
  }
  .search-input {
    width: 100%;
  }
}
</style>
<!-- ========== HTML BODY 结构 ========== -->
<!-- 把这部分放在 </style> 之后，<script> 之前 -->

</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loading-text">加载中...</div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- 成功动画 -->
  <div class="success-animation-overlay" id="success-animation">
    <div class="success-animation-box">
      <div class="success-checkmark">
        <svg viewBox="0 0 24 24">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
      </div>
      <div class="success-text" id="success-text">发放成功！</div>
      <div class="success-subtext" id="success-subtext">已成功处理 3 条记录</div>
    </div>
  </div>

  <!-- Login Section -->
  <div id="login-section">
    <div class="login-container">
      <div class="login-card">
        <div class="login-brand">
          <div class="login-logo">💰</div>
          <h1 class="login-title">薪资管理系统</h1>
          <p class="login-subtitle">Salary Management System</p>
        </div>
        <form onsubmit="event.preventDefault(); App.handleLogin();">
          <div class="form-group">
            <label class="form-label">用户名</label>
            <input class="form-input" id="login-username" placeholder="请输入用户名" autocomplete="username">
          </div>
          <div class="form-group">
            <label class="form-label">密码</label>
            <input class="form-input" id="login-password" type="password" placeholder="请输入密码" autocomplete="current-password">
          </div>
          <button type="submit" class="btn btn-primary btn-block" id="login-btn">
            登录系统
          </button>
          <div class="message" id="login-message"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- App Section -->
  <div id="app-section">
    <div class="app-layout">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-brand">
            <div class="sidebar-logo">💰</div>
            <div class="sidebar-title">薪资管理</div>
          </div>
        </div>

        <nav class="sidebar-nav">
          <div class="nav-section">
            <div class="nav-section-title">概览</div>
            <div class="nav-item active" data-page="dashboard">
              <span class="nav-item-icon">📊</span>
              <span>仪表板</span>
            </div>
          </div>

          <div class="nav-section role-admin-secretary">
            <div class="nav-section-title">工资管理</div>
            <div class="nav-item" data-page="salary">
              <span class="nav-item-icon">💵</span>
              <span>员工工资录入</span>
            </div>
            <div class="nav-item" data-page="drafts">
              <span class="nav-item-icon">📝</span>
              <span>草稿管理</span>
              <span class="nav-item-badge" id="draft-badge" style="display:none;">0</span>
            </div>
          </div>

          <div class="nav-section role-admin-accountant">
            <div class="nav-section-title">支付管理</div>
            <div class="nav-item" data-page="payments">
              <span class="nav-item-icon">💳</span>
              <span>员工出粮</span>
            </div>
            <div class="nav-item role-admin-accountant" data-page="mgr-payments">
              <span class="nav-item-icon">👔</span>
              <span>主管出粮</span>
            </div>
          </div>

          <div class="nav-section role-admin-secretary">
            <div class="nav-section-title">人员管理</div>
            <div class="nav-item role-secretary" data-page="staff">
              <span class="nav-item-icon">👥</span>
              <span>员工管理</span>
            </div>
            <div class="nav-item role-admin" data-page="managers">
              <span class="nav-item-icon">👔</span>
              <span>主管管理</span>
            </div>
          </div>

          <div class="nav-section">
            <div class="nav-section-title">其他</div>
            <div class="nav-item" data-page="history">
              <span class="nav-item-icon">📜</span>
              <span>历史记录</span>
            </div>
          </div>

          <div class="nav-section role-admin">
            <div class="nav-section-title">系统管理</div>
            <div class="nav-item" data-page="users">
              <span class="nav-item-icon">🔐</span>
              <span>账号管理</span>
            </div>
            <div class="nav-item" data-page="logs">
              <span class="nav-item-icon">📋</span>
              <span>操作日志</span>
            </div>
          </div>
        </nav>

        <div class="sidebar-footer">
          <div class="user-card">
            <div class="user-avatar" id="user-avatar">A</div>
            <div class="user-info">
              <div class="user-name" id="user-name">用户</div>
              <div class="user-role" id="user-role">角色</div>
            </div>
          </div>
          <div class="user-actions">
            <button class="user-action-btn" onclick="App.openPasswordModal()">
              🔑 改密
            </button>
            <button class="user-action-btn logout" onclick="App.handleLogout()">
              🚪 登出
            </button>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- ==================== Dashboard Page ==================== -->
        <div class="page active" id="page-dashboard">
          <div class="page-header">
            <div class="page-header-left">
              <h1 class="page-title">👋 仪表板</h1>
              <p class="page-subtitle">欢迎回来，这是今日的系统概览</p>
            </div>
            <div class="page-header-right" style="display: flex; align-items: center; gap: 12px;">
              <button class="btn btn-secondary" onclick="App.refreshDashboard()" id="dashboard-refresh-btn" style="display: flex; align-items: center; gap: 6px;">
                <span class="refresh-btn" id="refresh-icon">🔄</span> 刷新
              </button>
              <div class="month-selector">
                📅 <span id="current-month-display">2025年12月</span>
              </div>
            </div>
          </div>

          <!-- Admin/Accountant Stats -->
          <div id="accountant-stats-section" style="display:none;">
            <div class="stats-grid">
              <div class="stat-card coral" onclick="App.navigateTo('staff')">
                <div class="stat-card-inner">
                  <div class="stat-icon">👥</div>
                  <div class="stat-content">
                    <div class="stat-value" id="stat-emp-count">0</div>
                    <div class="stat-label">在职员工</div>
                  </div>
                </div>
              </div>
              <div class="stat-card green" onclick="App.navigateTo('payments')">
                <div class="stat-card-inner">
                  <div class="stat-icon">💰</div>
                  <div class="stat-content">
                    <div class="stat-value" id="stat-pending-salary">RM 0</div>
                    <div class="stat-label">待发工资</div>
                  </div>
                </div>
              </div>
              <div class="stat-card blue">
                <div class="stat-card-inner">
                  <div class="stat-icon">🏦</div>
                  <div class="stat-content">
                    <div class="stat-value" id="stat-bank-total">RM 0</div>
                    <div class="stat-label">待汇款</div>
                  </div>
                </div>
              </div>
              <div class="stat-card purple">
                <div class="stat-card-inner">
                  <div class="stat-icon">💵</div>
                  <div class="stat-content">
                    <div class="stat-value" id="stat-cash-total">RM 0</div>
                    <div class="stat-label">待发现金</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Progress Section -->
            <div class="card">
              <div class="card-header">
                <div class="card-header-left">
                  <div class="card-icon blue">📈</div>
                  <div>
                    <div class="card-title">本月发放进度</div>
                    <div class="card-subtitle" id="payment-progress-month">2025-12</div>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="progress-container">
                  <div class="progress-header">
                    <span class="progress-title">员工工资</span>
                    <span class="progress-value" id="emp-progress-text">0/0</span>
                  </div>
                  <div class="progress-track">
                    <div class="progress-fill green" id="emp-progress-bar" style="width: 0%;"></div>
                  </div>
                </div>
                <div class="progress-container">
                  <div class="progress-header">
                    <span class="progress-title">主管工资</span>
                    <span class="progress-value" id="mgr-progress-text">0/0</span>
                  </div>
                  <div class="progress-track">
                    <div class="progress-fill blue" id="mgr-progress-bar" style="width: 0%;"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Alerts -->
            <div class="grid grid-5 alert-cards-grid">
              <div class="card alert-card">
                <div class="card-header clickable-card-header" onclick="App.showAlertDetail('bank-change')">
                  <div class="card-header-left">
                    <div class="card-icon coral">🏦</div>
                    <div>
                      <div class="card-title">银行资料变更</div>
                      <div class="card-subtitle">近14天内有变更</div>
                    </div>
                  </div>
                  <span class="badge badge-error" id="bank-change-count">0</span>
                </div>
                <div class="card-body alert-card-body">
                  <div class="alert-card-scroll" id="bank-change-list"></div>
                  <div class="alert-card-empty" id="bank-change-empty" style="display:none;">
                    <div class="alert-empty-icon">✓</div>
                    <div class="alert-empty-text">没有银行变更</div>
                    <div class="alert-empty-subtext">近14天内无资料变更</div>
                  </div>
                </div>
                <div class="alert-card-footer" id="bank-change-summary" style="display:none;"></div>
              </div>

              <div class="card alert-card">
                <div class="card-header clickable-card-header" onclick="App.showAlertDetail('debt')">
                  <div class="card-header-left">
                    <div class="card-icon yellow">💸</div>
                    <div>
                      <div class="card-title">欠款待扣</div>
                      <div class="card-subtitle">还有未扣完的分期</div>
                    </div>
                  </div>
                  <span class="badge badge-pending" id="debt-alert-count">0</span>
                </div>
                <div class="card-body alert-card-body">
                  <div class="alert-card-scroll" id="debt-alert-list"></div>
                  <div class="alert-card-empty" id="debt-alert-empty" style="display:none;">
                    <div class="alert-empty-icon">✓</div>
                    <div class="alert-empty-text">没有欠款</div>
                    <div class="alert-empty-subtext">所有人员无待扣款项</div>
                  </div>
                </div>
                <div class="alert-card-footer" id="debt-alert-summary" style="display:none;"></div>
              </div>

              <div class="card alert-card">
                <div class="card-header clickable-card-header" onclick="App.showAlertDetail('new-staff')">
                  <div class="card-header-left">
                    <div class="card-icon green">🆕</div>
                    <div>
                      <div class="card-title">新员工提醒</div>
                      <div class="card-subtitle">近30天内入职</div>
                    </div>
                  </div>
                  <span class="badge badge-success" id="new-staff-count">0</span>
                </div>
                <div class="card-body alert-card-body">
                  <div class="alert-card-scroll" id="new-staff-list"></div>
                  <div class="alert-card-empty neutral-empty" id="new-staff-empty" style="display:none;">
                    <div class="alert-empty-icon">📭</div>
                    <div class="alert-empty-text">没有新员工</div>
                    <div class="alert-empty-subtext">近30天内无人入职</div>
                  </div>
                </div>
                <div class="alert-card-footer" id="new-staff-summary" style="display:none;"></div>
              </div>

              <div class="card alert-card">
                <div class="card-header clickable-card-header" onclick="App.showAlertDetail('left-staff')">
                  <div class="card-header-left">
                    <div class="card-icon coral">👋</div>
                    <div>
                      <div class="card-title">离职员工提醒</div>
                      <div class="card-subtitle">近30天内离职</div>
                    </div>
                  </div>
                  <span class="badge badge-error" id="left-staff-count">0</span>
                </div>
                <div class="card-body alert-card-body">
                  <div class="alert-card-scroll" id="left-staff-list"></div>
                  <div class="alert-card-empty" id="left-staff-empty" style="display:none;">
                    <div class="alert-empty-icon">✓</div>
                    <div class="alert-empty-text">团队稳定</div>
                    <div class="alert-empty-subtext">近30天无人离职</div>
                  </div>
                </div>
                <div class="alert-card-footer" id="left-staff-summary" style="display:none;"></div>
              </div>

              <div class="card alert-card">
                <div class="card-header clickable-card-header" onclick="App.showAlertDetail('salary-adjust')">
                  <div class="card-header-left">
                    <div class="card-icon blue">💰</div>
                    <div>
                      <div class="card-title">加薪通知</div>
                      <div class="card-subtitle" id="salary-notify-month">近30天调薪</div>
                    </div>
                  </div>
                  <span class="badge badge-info" id="salary-notify-count">0</span>
                </div>
                <div class="card-body alert-card-body">
                  <div class="alert-card-scroll" id="salary-notify-list"></div>
                  <div class="alert-card-empty info-empty" id="salary-notify-empty" style="display:none;">
                    <div class="alert-empty-icon">📊</div>
                    <div class="alert-empty-text">暂无调薪</div>
                    <div class="alert-empty-subtext">近30天无调薪记录</div>
                  </div>
                </div>
                <div class="alert-card-footer" id="salary-notify-summary" style="display:none;"></div>
              </div>
            </div>

            <!-- Secretary Stats -->
            <div class="card" style="margin-top: 20px;">
              <div class="card-header">
                <div class="card-header-left">
                  <div class="card-icon purple">📊</div>
                  <div>
                    <div class="card-title">各书记员工统计</div>
                    <div class="card-subtitle">点击卡片查看详细信息</div>
                  </div>
                </div>
                <div class="card-header-right">
                  <span class="badge badge-info" id="total-secretary-count">0 位书记</span>
                </div>
              </div>
              <div class="card-body">
                <div class="stats-grid" id="secretary-stats-grid" style="grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px;"></div>
                <div class="empty-state" id="secretary-stats-empty" style="display:none;">
                  <div class="empty-icon">📭</div>
                  <div class="empty-text">暂无数据</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Secretary Stats -->
          <div class="role-secretary">
            <div class="stats-grid">
              <div class="stat-card coral" onclick="App.navigateTo('staff')">
                <div class="stat-card-inner">
                  <div class="stat-icon">👥</div>
                  <div class="stat-content">
                    <div class="stat-value" id="stat-my-staff">0</div>
                    <div class="stat-label">我的员工</div>
                  </div>
                </div>
              </div>
              <div class="stat-card green" onclick="App.navigateTo('drafts')">
                <div class="stat-card-inner">
                  <div class="stat-icon">📝</div>
                  <div class="stat-content">
                    <div class="stat-value" id="stat-my-drafts">0</div>
                    <div class="stat-label">待提交草稿</div>
                  </div>
                </div>
              </div>
              <div class="stat-card blue">
                <div class="stat-card-inner">
                  <div class="stat-icon">✅</div>
                  <div class="stat-content">
                    <div class="stat-value" id="stat-my-submitted">0</div>
                    <div class="stat-label">已提交</div>
                  </div>
                </div>
              </div>
              <div class="stat-card purple">
                <div class="stat-card-inner">
                  <div class="stat-icon">💰</div>
                  <div class="stat-content">
                    <div class="stat-value" id="stat-my-total">RM 0</div>
                    <div class="stat-label">月工资总额</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Entry Progress -->
            <div class="card">
              <div class="card-header">
                <div class="card-header-left">
                  <div class="card-icon green">📈</div>
                  <div>
                    <div class="card-title">本月录入进度</div>
                    <div class="card-subtitle" id="entry-progress-month">2025-12</div>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="progress-container">
                  <div class="progress-header">
                    <span class="progress-title">已录入员工</span>
                    <span class="progress-value" id="entry-progress-text">0/0</span>
                  </div>
                  <div class="progress-track">
                    <div class="progress-fill green" id="entry-progress-bar" style="width: 0%;"></div>
                  </div>
                </div>
                <p style="font-size: 13px; color: var(--text-muted); margin-top: 12px;">
                  💡 还有 <strong id="entry-not-entered">0</strong> 位员工未录入本月工资
                </p>
              </div>
            </div>

            <!-- Secretary Debt Alerts -->
            <div class="card">
              <div class="card-header">
                <div class="card-header-left">
                  <div class="card-icon yellow">💸</div>
                  <div>
                    <div class="card-title">员工欠款提醒</div>
                    <div class="card-subtitle">分期扣款中的员工</div>
                  </div>
                </div>
                <span class="badge badge-pending" id="secretary-debt-count">0</span>
              </div>
              <div class="card-body" style="max-height: 220px; overflow-y: auto;">
                <div id="secretary-debt-list"></div>
                <div class="empty-state" id="secretary-debt-empty" style="display:none; padding: 24px;">
                  <div class="empty-icon" style="font-size: 36px;">✅</div>
                  <div class="empty-text">没有欠款员工</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="card" style="margin-top: 20px;">
            <div class="card-header">
              <div class="card-header-left">
                <div class="card-icon orange">⚡</div>
                <div>
                  <div class="card-title">快捷操作</div>
                  <div class="card-subtitle">常用功能快速入口</div>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="quick-actions">
                <div class="quick-action-btn role-admin-secretary" onclick="App.navigateTo('salary')">
                  <div class="quick-action-icon coral">➕</div>
                  <div class="quick-action-text">录入工资</div>
                </div>
                <div class="quick-action-btn role-secretary" onclick="App.navigateTo('staff')">
                  <div class="quick-action-icon green">👤</div>
                  <div class="quick-action-text">添加员工</div>
                </div>
                <div class="quick-action-btn role-admin" onclick="App.navigateTo('managers')">
                  <div class="quick-action-icon purple">👔</div>
                  <div class="quick-action-text">添加主管</div>
                </div>
                <div class="quick-action-btn role-admin-accountant" onclick="App.navigateTo('payments')">
                  <div class="quick-action-icon blue">💳</div>
                  <div class="quick-action-text">员工出粮</div>
                </div>
                <div class="quick-action-btn role-admin-accountant" onclick="App.showBankSummary()">
                  <div class="quick-action-icon yellow">📋</div>
                  <div class="quick-action-text">汇款汇总</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== Salary Entry Page ==================== -->
        <div class="page" id="page-salary">
          <div class="page-header">
            <div class="page-header-left">
              <h1 class="page-title">💵 工资录入</h1>
              <p class="page-subtitle" id="salary-page-subtitle">录入员工月度工资</p>
            </div>
          </div>

          <div class="grid grid-2">
            <!-- Left: Form -->
            <div class="card">
              <div class="card-header">
                <div class="card-header-left">
                  <div class="card-icon coral">📝</div>
                  <div>
                    <div class="card-title">工资信息</div>
                    <div class="card-subtitle">填写工资详情</div>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="grid grid-2">
                  <div class="form-group">
                    <label class="form-label">月份 *</label>
                    <input class="form-input" id="salary-month" placeholder="YYYY-MM" maxlength="7">
                  </div>
                  <div class="form-group">
                    <label class="form-label">日期 *</label>
                    <input class="form-input" id="salary-date" type="date">
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label"><span id="staff-type-label">员工</span> *</label>
                  <!-- 可搜索下拉框 -->
                  <div class="searchable-select-wrapper" id="staff-select-wrapper">
                    <input type="text" class="searchable-select-input" id="staff-select-input" 
                           placeholder="🔍 输入姓名搜索..." autocomplete="off"
                           onfocus="App.openStaffDropdown()" 
                           oninput="App.filterStaffDropdown()">
                    <span class="searchable-select-arrow">▼</span>
                    <div class="searchable-select-dropdown" id="staff-select-dropdown"></div>
                  </div>
                  <input type="hidden" id="salary-staff" value="">
                </div>

                <!-- Staff Info Card -->
                <div id="staff-info-card" style="display: none;"></div>

                <!-- Current Debt Info -->
                <div id="current-debt-info" class="info-box" style="display: none; background: var(--warning-bg); border-color: rgba(245, 158, 11, 0.3);">
                  <div class="info-box-title" style="color: #92400e;">💸 欠款分期信息</div>
                  <div class="info-grid">
                    <div class="info-item" style="background: white;">
                      <div class="info-label">每月扣款</div>
                      <div class="info-value" id="current-monthly-ded">RM 0</div>
                    </div>
                    <div class="info-item" style="background: white;">
                      <div class="info-label">剩余欠款</div>
                      <div class="info-value" id="current-debt-remaining">RM 0</div>
                    </div>
                    <div class="info-item" style="background: white;">
                      <div class="info-label">已还金额</div>
                      <div class="info-value" id="current-debt-progress">RM 0 / RM 0</div>
                    </div>
                    <div class="info-item" style="background: white;">
                      <div class="info-label">欠款原因</div>
                      <div class="info-value" id="current-debt-reason">-</div>
                    </div>
                  </div>
                </div>

                <div class="grid grid-2">
                  <div class="form-group">
                    <label class="form-label">基本工资 (RM) *</label>
                    <input class="form-input" id="salary-basic" type="number" step="0.01" placeholder="0.00" oninput="App.validateSalaryInput(this)">
                    <div class="form-error-msg">请输入有效的工资金额</div>
                    <div class="quick-amount-btns">
                      <button type="button" class="quick-amount-btn" onclick="App.addQuickAmount('salary-basic', 100)">+100</button>
                      <button type="button" class="quick-amount-btn" onclick="App.addQuickAmount('salary-basic', 500)">+500</button>
                      <button type="button" class="quick-amount-btn" onclick="App.addQuickAmount('salary-basic', 1000)">+1K</button>
                      <button type="button" class="quick-amount-btn set-btn" onclick="App.setQuickAmount('salary-basic', 2500)">2.5K</button>
                      <button type="button" class="quick-amount-btn set-btn" onclick="App.setQuickAmount('salary-basic', 3000)">3K</button>
                      <button type="button" class="quick-amount-btn clear-btn" onclick="App.setQuickAmount('salary-basic', 0)">清零</button>
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-label">手动扣款 (RM)</label>
                    <input class="form-input" id="salary-deduction" type="number" step="0.01" placeholder="0.00" value="0" oninput="App.validateSalaryInput(this)">
                    <div class="form-error-msg">请输入有效的扣款金额</div>
                    <div class="quick-amount-btns">
                      <button type="button" class="quick-amount-btn" onclick="App.addQuickAmount('salary-deduction', 50)">+50</button>
                      <button type="button" class="quick-amount-btn" onclick="App.addQuickAmount('salary-deduction', 100)">+100</button>
                      <button type="button" class="quick-amount-btn" onclick="App.addQuickAmount('salary-deduction', 200)">+200</button>
                      <button type="button" class="quick-amount-btn clear-btn" onclick="App.setQuickAmount('salary-deduction', 0)">清零</button>
                    </div>
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">手动扣款类型</label>
                  <div class="radio-group">
                    <label class="radio-item selected">
                      <input type="radio" name="deduction-type" value="none" checked onchange="App.onDeductionTypeChange()">
                      <span class="radio-item-label">无手动扣款</span>
                    </label>
                    <label class="radio-item">
                      <input type="radio" name="deduction-type" value="once" onchange="App.onDeductionTypeChange()">
                      <span class="radio-item-label">一次性扣款</span>
                    </label>
                  </div>
                  <div style="font-size: 12px; color: #6B7280; margin-top: 6px;">
                    💡 分期扣款请点击上方「💸 设置欠款」按钮设置，系统会自动扣除
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">备注</label>
                  <input class="form-input" id="salary-remark" placeholder="可选备注信息">
                </div>

                <div class="message" id="salary-message"></div>

                <div class="btn-group" style="margin-top: 20px;">
                  <button class="btn btn-primary" id="btn-add-salary" onclick="App.handleAddSalary()">
                    💾 保存草稿
                  </button>
                  <button class="btn btn-success" id="btn-batch-salary" onclick="App.handleBatchSalary()">
                    ⚡ 一键批量录入
                  </button>
                </div>
              </div>
            </div>

            <!-- Right: Preview -->
            <div>
              <div class="card" id="salary-preview" style="display: none; border: 2px solid #10B981;">
                <div class="card-header" style="background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%); border-bottom: none;">
                  <div class="card-header-left">
                    <div class="card-icon" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%);">💰</div>
                    <div>
                      <div class="card-title">工资预览</div>
                      <div class="card-subtitle">实时计算结果</div>
                    </div>
                  </div>
                  <div id="preview-compare" style="display: none; text-align: right;">
                    <div style="font-size: 11px; color: #6B7280;">与上月对比</div>
                    <div id="preview-compare-text" style="font-size: 13px; font-weight: 600;"></div>
                  </div>
                </div>
                <div class="card-body" style="padding-top: 16px;">
                  <!-- 工资明细 -->
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div style="background: #F9FAFB; padding: 12px; border-radius: 10px; border: 1px solid #E5E7EB;">
                      <div style="font-size: 11px; color: #6B7280; margin-bottom: 4px;">月薪标准</div>
                      <div style="font-size: 16px; font-weight: 700; color: #374151;" id="preview-salary">RM 0</div>
                    </div>
                    <div style="background: #F0FDF4; padding: 12px; border-radius: 10px; border: 1px solid #BBF7D0;">
                      <div style="font-size: 11px; color: #059669; margin-bottom: 4px;">本月基本</div>
                      <div style="font-size: 16px; font-weight: 700; color: #059669;" id="preview-basic">RM 0</div>
                    </div>
                  </div>

                  <!-- 扣款明细 -->
                  <div id="preview-deductions" style="display: none; background: #FEF2F2; padding: 12px; border-radius: 10px; margin-bottom: 16px; border: 1px solid #FECACA;">
                    <div style="font-size: 12px; font-weight: 600; color: #991B1B; margin-bottom: 8px;">📉 扣款明细</div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                      <span style="font-size: 13px; color: #6B7280;">自动扣款（欠款）</span>
                      <span style="font-size: 13px; font-weight: 600; color: #DC2626;" id="preview-auto-ded">-</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                      <span style="font-size: 13px; color: #6B7280;">手动扣款</span>
                      <span style="font-size: 13px; font-weight: 600; color: #DC2626;" id="preview-manual-ded">-</span>
                    </div>
                  </div>

                  <!-- 无扣款时显示 -->
                  <div id="preview-no-deduction" style="background: #F9FAFB; padding: 10px 12px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <span>✓</span>
                    <span style="font-size: 13px; color: #6B7280;">无扣款项目</span>
                  </div>

                  <div id="preview-prorata" class="alert-card info" style="display: none; margin-bottom: 16px;">
                    <div class="alert-icon">📅</div>
                    <div class="alert-content">
                      <div class="alert-title">按比例计算</div>
                      <div class="alert-text" id="preview-prorata-text"></div>
                    </div>
                  </div>

                  <div id="preview-debt" class="alert-card warning" style="display: none; margin-bottom: 16px;">
                    <div class="alert-icon">💸</div>
                    <div class="alert-content">
                      <div class="alert-title">自动扣除欠款</div>
                      <div class="alert-text" id="preview-debt-text"></div>
                    </div>
                  </div>

                  <!-- 净工资 - 突出显示 -->
                  <div style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(16,185,129,0.3);">
                    <div style="font-size: 13px; color: rgba(255,255,255,0.9); margin-bottom: 4px;">净工资</div>
                    <div style="font-size: 32px; font-weight: 800; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.1);" id="preview-net">RM 0</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== Drafts Page ==================== -->
        <div class="page" id="page-drafts">
          <div class="page-header">
            <div class="page-header-left">
              <h1 class="page-title">📝 草稿管理</h1>
              <p class="page-subtitle">管理待提交的工资草稿</p>
            </div>
            <div class="page-header-right">
              <input class="form-input" id="draft-month" placeholder="YYYY-MM" style="width: 140px;" maxlength="7">
              <button class="btn btn-secondary" onclick="App.loadDrafts()">🔄 刷新</button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-header-left">
                <div class="card-icon purple">📋</div>
                <div>
                  <div class="card-title">草稿列表</div>
                  <div class="card-subtitle">待提交的工资记录</div>
                </div>
              </div>
              <div class="btn-group">
                <button class="btn btn-danger btn-sm" onclick="App.deleteSelectedDrafts()">🗑️ 删除选中</button>
                <button class="btn btn-success btn-sm" onclick="App.submitAllDrafts()">📤 提交全部</button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th><input type="checkbox" class="checkbox" id="draft-select-all" onchange="App.toggleDraftSelectAll()"></th>
                      <th>姓名</th>
                      <th>月份</th>
                      <th>基本工资</th>
                      <th>扣款</th>
                      <th>净工资</th>
                      <th>备注</th>
                      <th>状态</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="drafts-tbody"></tbody>
                </table>
              </div>
              <div class="empty-state" id="drafts-empty" style="display: none;">
                <div class="empty-icon">📭</div>
                <div class="empty-text">暂无草稿记录</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== Payments Page ==================== -->
        <div class="page" id="page-payments">
          <div class="page-header">
            <div class="page-header-left">
              <h1 class="page-title" id="payments-page-title">💳 员工出粮</h1>
              <p class="page-subtitle" id="payments-page-subtitle">处理员工工资发放</p>
            </div>
            <div class="page-header-right">
              <input class="form-input" id="emp-payment-month" placeholder="YYYY-MM" style="width:140px;" maxlength="7">
              <button class="btn btn-secondary" onclick="App.loadEmployeePayments()">🔄 加载</button>
            </div>
          </div>

          <!-- 高级筛选 -->
          <div style="display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; align-items: center;">
            <select class="form-select" id="emp-company-filter" onchange="App.filterPayments()" style="width: 180px; padding: 8px 12px;">
              <option value="">🏢 全部公司</option>
            </select>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="color: #6B7280; font-size: 13px;">💰 金额:</span>
              <input type="number" class="form-input" id="emp-amount-min" placeholder="最低" style="width: 100px; padding: 8px;" oninput="App.filterPayments()">
              <span style="color: #9CA3AF;">-</span>
              <input type="number" class="form-input" id="emp-amount-max" placeholder="最高" style="width: 100px; padding: 8px;" oninput="App.filterPayments()">
            </div>
            <button class="btn btn-secondary" onclick="App.clearPaymentFilters()" style="padding: 8px 12px; font-size: 13px;">清除筛选</button>
          </div>

          <!-- Filter Stats -->
          <div class="filter-bar">
            <button class="filter-btn active" data-filter="all" onclick="App.filterPayments('all')">全部 (<span id="emp-all-count">0</span>)</button>
            <button class="filter-btn" data-filter="same" onclick="App.filterPayments('same')">同额 (<span id="emp-same-count">0</span>)</button>
            <button class="filter-btn" data-filter="change" onclick="App.filterPayments('change')">变化 (<span id="emp-change-count">0</span>)</button>
            <button class="filter-btn" data-filter="deduction" onclick="App.filterPayments('deduction')">扣款 (<span id="emp-deduction-count">0</span>)</button>
            <button class="filter-btn" data-filter="bank" onclick="App.filterPayments('bank')">银行变更 (<span id="emp-bank-count">0</span>)</button>
            <div class="summary-bar">
              <div class="summary-item">
                <span class="summary-label">🏦</span>
                <span class="summary-value blue" id="emp-bank-amount">RM 0</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">💵</span>
                <span class="summary-value purple" id="emp-cash-amount">RM 0</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">总计</span>
                <span class="summary-value green" id="emp-total-amount">RM 0</span>
              </div>
            </div>
          </div>

          <!-- 批量操作栏 -->
          <div id="accountant-batch-actions" style="display: none; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; justify-content: space-between; background: white; padding: 12px 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
              <div style="display: flex; align-items: center; gap: 12px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" class="checkbox" id="acc-select-all" onchange="App.toggleSelectAllCards()">
                  <span style="font-size: 14px; color: #374151;">全选</span>
                </label>
                <span style="color: #6B7280; font-size: 13px;">已选择 <strong id="acc-selected-count">0</strong> 人</span>
              </div>
              <div class="btn-group">
                <button class="btn btn-success" onclick="App.markSelectedCardsPaid('BANK')">🏦 选中汇款</button>
                <button class="btn btn-purple" onclick="App.markSelectedCardsPaid('CASH')">💵 选中现金</button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-header-left">
                <div class="card-icon blue">👥</div>
                <div>
                  <div class="card-title" id="emp-card-title">待发工资</div>
                  <div class="card-subtitle" id="emp-card-subtitle">员工待发放列表</div>
                </div>
              </div>
            </div>
            <div class="card-body">
              <!-- 卡片视图 -->
              <div class="staff-grid" id="emp-card-view"></div>
              
              <div class="empty-state" id="emp-payments-empty" style="display: none;">
                <div class="empty-icon">📭</div>
                <div class="empty-text">没有待发工资</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== Manager Payments Page ==================== -->
        <div class="page" id="page-mgr-payments">
          <div class="page-header">
            <div class="page-header-left">
              <h1 class="page-title">👔 主管出粮</h1>
              <p class="page-subtitle">处理主管工资发放</p>
            </div>
            <div class="page-header-right">
              <input class="form-input" id="mgr-payment-month" placeholder="YYYY-MM" style="width:140px;" maxlength="7">
              <button class="btn btn-secondary" onclick="App.loadManagerPayments()">🔄 加载</button>
            </div>
          </div>

          <!-- 批量操作栏 -->
          <div id="mgr-batch-actions" style="margin-bottom: 16px;">
            <div style="display: flex; align-items: center; justify-content: space-between; background: white; padding: 12px 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
              <div style="display: flex; align-items: center; gap: 12px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" class="checkbox" id="mgr-select-all-cards" onchange="App.toggleSelectAllMgrCards()">
                  <span style="font-size: 14px; color: #374151;">全选</span>
                </label>
                <span style="color: #6B7280; font-size: 13px;">已选择 <strong id="mgr-selected-count">0</strong> 人</span>
              </div>
              <div class="btn-group">
                <button class="btn btn-success" onclick="App.markSelectedMgrCardsPaid('BANK')">🏦 选中汇款</button>
                <button class="btn btn-purple" onclick="App.markSelectedMgrCardsPaid('CASH')">💵 选中现金</button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-header-left">
                <div class="card-icon purple">👔</div>
                <div>
                  <div class="card-title" id="mgr-card-title">主管待发工资</div>
                  <div class="card-subtitle" id="mgr-card-subtitle">主管待发放列表</div>
                </div>
              </div>
            </div>
            <div class="card-body">
              <!-- 卡片视图 -->
              <div class="staff-grid" id="mgr-card-view"></div>
              
              <div class="empty-state" id="mgr-payments-empty" style="display: none;">
                <div class="empty-icon">📭</div>
                <div class="empty-text">没有待发工资</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== Staff Management Page ==================== -->
        <div class="page" id="page-staff">
          <div class="page-header">
            <div class="page-header-left">
              <h1 class="page-title">👥 员工管理</h1>
              <p class="page-subtitle">管理您的员工信息</p>
            </div>
            <div class="page-header-right">
              <button class="btn btn-primary" onclick="App.showAddStaffModal()">
                ➕ 添加员工
              </button>
            </div>
          </div>

          <!-- Stats -->
          <div class="stats-grid">
            <div class="stat-card coral">
              <div class="stat-card-inner">
                <div class="stat-icon">👥</div>
                <div class="stat-content">
                  <div class="stat-value animate-number" id="staff-total-count">0</div>
                  <div class="stat-label">在职员工</div>
                </div>
              </div>
            </div>
            <div class="stat-card green">
              <div class="stat-card-inner">
                <div class="stat-icon">💰</div>
                <div class="stat-content">
                  <div class="stat-value animate-number" id="staff-salary-total">RM 0</div>
                  <div class="stat-label">月工资总额</div>
                </div>
              </div>
            </div>
            <div class="stat-card blue">
              <div class="stat-card-inner">
                <div class="stat-icon">💸</div>
                <div class="stat-content">
                  <div class="stat-value animate-number" id="staff-debt-count">0</div>
                  <div class="stat-label">有欠款人数</div>
                </div>
              </div>
            </div>
            <div class="stat-card purple">
              <div class="stat-card-inner">
                <div class="stat-icon">🚪</div>
                <div class="stat-content">
                  <div class="stat-value animate-number" id="staff-left-count">0</div>
                  <div class="stat-label">已离职</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Filters -->
          <div class="filter-bar" style="flex-wrap: wrap;">
            <input type="text" class="search-input" placeholder="搜索姓名、公司..." id="staff-search" oninput="App.filterStaffList()">
            <button class="filter-btn active" data-filter="all" onclick="App.setStaffFilter('all')">全部 (<span id="filter-all-count">0</span>)</button>
            <button class="filter-btn" data-filter="active" onclick="App.setStaffFilter('active')">在职 (<span id="filter-active-count">0</span>)</button>
            <button class="filter-btn" data-filter="left" onclick="App.setStaffFilter('left')">离职 (<span id="filter-left-count">0</span>)</button>
            <button class="filter-btn" data-filter="debt" onclick="App.setStaffFilter('debt')">💸 欠款 (<span id="filter-debt-count">0</span>)</button>
            <div style="margin-left: auto; display: flex; gap: 8px; align-items: center;">
              <span style="color: #6B7280; font-size: 13px;">排序:</span>
              <button class="filter-btn active" id="staff-sort-name" onclick="App.sortStaffList('name')">姓名</button>
              <button class="filter-btn" id="staff-sort-salary" onclick="App.sortStaffList('salary')">月薪</button>
              <button class="filter-btn" id="staff-sort-date" onclick="App.sortStaffList('date')">入职日期</button>
            </div>
          </div>

          <!-- Staff Grid -->
          <div class="staff-grid" id="staff-grid"></div>
          
          <!-- 分页器 -->
          <div class="pagination" id="staff-pagination" style="display: none;"></div>

          <div class="empty-state" id="staff-empty" style="display: none;">
            <div class="empty-icon">👥</div>
            <div class="empty-text" id="staff-empty-text">暂无员工数据</div>
            <div class="empty-state-action">
              <button class="empty-state-btn" onclick="App.showAddStaffModal()">➕ 添加第一位员工</button>
            </div>
          </div>
        </div>

        <!-- ==================== Managers Page ==================== -->
        <div class="page" id="page-managers">
          <div class="page-header">
            <div class="page-header-left">
              <h1 class="page-title">👔 主管管理</h1>
              <p class="page-subtitle">管理主管信息</p>
            </div>
            <div class="page-header-right">
              <button class="btn btn-primary" onclick="App.showAddManagerModal()">
                ➕ 添加主管
              </button>
            </div>
          </div>

          <!-- Stats -->
          <div class="stats-grid">
            <div class="stat-card purple">
              <div class="stat-card-inner">
                <div class="stat-icon">👔</div>
                <div class="stat-content">
                  <div class="stat-value animate-number" id="manager-total-count">0</div>
                  <div class="stat-label">在职主管</div>
                </div>
              </div>
            </div>
            <div class="stat-card green">
              <div class="stat-card-inner">
                <div class="stat-icon">💰</div>
                <div class="stat-content">
                  <div class="stat-value animate-number" id="manager-salary-total">RM 0</div>
                  <div class="stat-label">月工资总额</div>
                </div>
              </div>
            </div>
            <div class="stat-card blue">
              <div class="stat-card-inner">
                <div class="stat-icon">💸</div>
                <div class="stat-content">
                  <div class="stat-value animate-number" id="manager-debt-count">0</div>
                  <div class="stat-label">有欠款人数</div>
                </div>
              </div>
            </div>
            <div class="stat-card coral">
              <div class="stat-card-inner">
                <div class="stat-icon">🚪</div>
                <div class="stat-content">
                  <div class="stat-value animate-number" id="manager-left-count">0</div>
                  <div class="stat-label">已离职</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Filters -->
          <div class="filter-bar" style="flex-wrap: wrap;">
            <input type="text" class="search-input" placeholder="搜索姓名..." id="manager-search" oninput="App.filterManagerList()">
            <button class="filter-btn active" data-filter="all" onclick="App.setManagerFilter('all')">全部 (<span id="mgr-filter-all-count">0</span>)</button>
            <button class="filter-btn" data-filter="active" onclick="App.setManagerFilter('active')">在职 (<span id="mgr-filter-active-count">0</span>)</button>
            <button class="filter-btn" data-filter="left" onclick="App.setManagerFilter('left')">离职 (<span id="mgr-filter-left-count">0</span>)</button>
            <button class="filter-btn" data-filter="debt" onclick="App.setManagerFilter('debt')">💸 欠款 (<span id="mgr-filter-debt-count">0</span>)</button>
            <div style="margin-left: auto; display: flex; gap: 8px; align-items: center;">
              <span style="color: #6B7280; font-size: 13px;">排序:</span>
              <button class="filter-btn active" id="mgr-sort-name" onclick="App.sortManagerList('name')">姓名</button>
              <button class="filter-btn" id="mgr-sort-salary" onclick="App.sortManagerList('salary')">月薪</button>
              <button class="filter-btn" id="mgr-sort-date" onclick="App.sortManagerList('date')">入职日期</button>
            </div>
          </div>

          <div class="staff-grid" id="manager-grid"></div>
          
          <!-- 分页器 -->
          <div class="pagination" id="manager-pagination" style="display: none;"></div>

          <div class="empty-state" id="manager-empty" style="display: none;">
            <div class="empty-icon">👔</div>
            <div class="empty-text" id="manager-empty-text">暂无主管数据</div>
            <div class="empty-state-action">
              <button class="empty-state-btn" onclick="App.showAddManagerModal()">➕ 添加第一位主管</button>
            </div>
          </div>
        </div>

        <!-- ==================== Users Management Page ==================== -->
        <div class="page" id="page-users">
          <div class="page-header">
            <div class="page-header-left">
              <h1 class="page-title">🔐 账号管理</h1>
              <p class="page-subtitle">管理系统用户账号</p>
            </div>
            <div class="page-header-right">
              <button class="btn btn-primary" onclick="App.showAddUserModal()">
                ➕ 添加用户
              </button>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-header-left">
                <div class="card-icon purple">👤</div>
                <div>
                  <div class="card-title">用户账号 (<span id="user-count">0</span>)</div>
                  <div class="card-subtitle">系统登录账号列表</div>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>用户名</th>
                      <th>显示名称</th>
                      <th>角色</th>
                      <th>状态</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody id="users-tbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== History Page ==================== -->
        <div class="page" id="page-history">
          <div class="page-header">
            <div class="page-header-left">
              <h1 class="page-title">📜 历史记录</h1>
              <p class="page-subtitle">查看最近100条操作记录</p>
            </div>
            <div class="page-header-right">
              <button class="btn btn-secondary" onclick="App.loadHistory()">🔄 刷新</button>
            </div>
          </div>

          <div class="filter-bar" style="margin-bottom: 16px;">
            <select class="form-select" id="history-action-filter" style="width: 180px;" onchange="App.loadHistory()">
              <option value="">全部操作</option>
              <option value="LOGIN">登录</option>
              <option value="ADD_SALARY">录入工资</option>
              <option value="UPDATE_DRAFT">编辑草稿</option>
              <option value="DELETE_DRAFT">删除草稿</option>
              <option value="SUBMIT_DRAFTS">提交草稿</option>
              <option value="BATCH_SUBMIT">批量提交</option>
              <option value="MARK_PAID">标记发放</option>
              <option value="ADD_STAFF">添加员工</option>
              <option value="ADD_MANAGER">添加主管</option>
              <option value="UPDATE_STAFF">编辑员工</option>
              <option value="UPDATE_MANAGER">编辑主管</option>
              <option value="SET_LEAVE">设置离职</option>
              <option value="UPDATE_DEBT">设置欠款</option>
              <option value="CHANGE_PASSWORD">修改密码</option>
            </select>
            <input class="search-input" id="history-search" placeholder="搜索关键词..." style="flex: 1;" oninput="App.loadHistory()">
          </div>

          <div class="card">
            <div class="card-body" style="padding: 0;">
              <div id="history-list" style="max-height: 600px; overflow-y: auto;"></div>
              <div class="empty-state" id="history-empty" style="display: none;">
                <div class="empty-icon">📜</div>
                <div class="empty-text">暂无历史记录</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ==================== Logs Page ==================== -->
        <div class="page" id="page-logs">
          <div class="page-header">
            <div class="page-header-left">
              <h1 class="page-title">📋 操作日志</h1>
              <p class="page-subtitle">查看系统操作记录</p>
            </div>
          </div>

          <div class="filter-bar">
            <select class="form-select" id="log-action-filter" style="width: 180px;" onchange="App.loadLogs()">
              <option value="">全部操作</option>
              <option value="LOGIN">登录</option>
              <option value="ADD_SALARY">录入工资</option>
              <option value="UPDATE_DRAFT">编辑草稿</option>
              <option value="DELETE_DRAFT">删除草稿</option>
              <option value="SUBMIT_DRAFTS">提交草稿</option>
              <option value="MARK_PAID">标记发放</option>
              <option value="ADD_STAFF">添加员工</option>
              <option value="SET_LEAVE">设置离职</option>
              <option value="SET_DEBT">设置欠款</option>
              <option value="CREATE_USER">创建账号</option>
              <option value="CHANGE_PASSWORD">修改密码</option>
            </select>
            <input class="search-input" id="log-search" placeholder="搜索操作员、目标..." oninput="App.loadLogs()">
            <button class="btn btn-secondary" onclick="App.loadLogs()">🔄 刷新</button>
          </div>

          <div class="card">
            <div class="card-body">
              <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                <table>
                  <thead>
                    <tr>
                      <th>时间</th>
                      <th>操作</th>
                      <th>操作员</th>
                      <th>目标</th>
                      <th>详情</th>
                    </tr>
                  </thead>
                  <tbody id="logs-tbody"></tbody>
                </table>
              </div>
              <div class="empty-state" id="logs-empty" style="display: none;">
                <div class="empty-icon">📋</div>
                <div class="empty-text">暂无日志记录</div>
              </div>
            </div>
          </div>
        </div>

      </main>
    </div>
  </div>

  <!-- ==================== MODALS ==================== -->

  <!-- Confirm Dialog -->
  <div class="confirm-overlay" id="confirm-overlay">
    <div class="confirm-dialog">
      <div class="confirm-icon warning" id="confirm-icon">⚠️</div>
      <div class="confirm-title" id="confirm-title">确认操作</div>
      <div class="confirm-message" id="confirm-message">您确定要执行此操作吗？</div>
      <div class="confirm-actions">
        <button class="btn btn-secondary" id="confirm-cancel">取消</button>
        <button class="btn btn-primary" id="confirm-ok">确定</button>
      </div>
    </div>
  </div>

  <!-- Add Staff Modal -->
  <div class="modal-overlay" id="add-staff-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">➕ 添加员工</h3>
        <button class="modal-close" onclick="App.closeModal('add-staff-modal')">✕</button>
      </div>
      <div class="modal-body">
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">员工姓名 *</label>
            <input class="form-input" id="new-staff-name" placeholder="员工姓名">
          </div>
          <div class="form-group">
            <label class="form-label">公司名称</label>
            <input class="form-input" id="new-staff-company" placeholder="公司名称">
          </div>
        </div>
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">月薪 (RM)</label>
            <input class="form-input" id="new-staff-salary" type="number" step="0.01" placeholder="0.00">
          </div>
          <div class="form-group">
            <label class="form-label">入职日期</label>
            <input class="form-input" id="new-staff-joindate" type="date">
          </div>
        </div>
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">付款方式</label>
            <select class="form-select" id="new-staff-payment">
              <option value="BANK">银行汇款</option>
              <option value="CASH">现金</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">银行户名</label>
            <input class="form-input" id="new-staff-bankholder" placeholder="Bank Holder">
          </div>
        </div>
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">银行类型</label>
            <input class="form-input" id="new-staff-banktype" placeholder="如 MAYBANK">
          </div>
          <div class="form-group">
            <label class="form-label">银行账号</label>
            <input class="form-input" id="new-staff-bankaccount" placeholder="账号">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="App.closeModal('add-staff-modal')">取消</button>
        <button class="btn btn-primary" id="btn-save-staff" onclick="App.saveNewStaff()">保存员工</button>
      </div>
    </div>
  </div>

  <!-- Edit Staff Modal -->
  <div class="modal-overlay" id="edit-staff-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">✏️ 编辑员工信息</h3>
        <button class="modal-close" onclick="App.closeModal('edit-staff-modal')">✕</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-staff-original-name">
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">员工姓名</label>
            <input class="form-input" id="edit-staff-name" disabled style="background: #f3f4f6;">
          </div>
          <div class="form-group">
            <label class="form-label">公司名称</label>
            <input class="form-input" id="edit-staff-company" placeholder="公司名称">
          </div>
        </div>
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">月薪 (RM)</label>
            <input class="form-input" id="edit-staff-salary" type="number" step="0.01" placeholder="0.00">
          </div>
          <div class="form-group">
            <label class="form-label">付款方式</label>
            <select class="form-select" id="edit-staff-payment">
              <option value="BANK">银行汇款</option>
              <option value="CASH">现金</option>
            </select>
          </div>
        </div>
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">银行户名</label>
            <input class="form-input" id="edit-staff-bankholder" placeholder="Bank Holder">
          </div>
          <div class="form-group">
            <label class="form-label">银行类型</label>
            <input class="form-input" id="edit-staff-banktype" placeholder="如 MAYBANK">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">银行账号</label>
          <input class="form-input" id="edit-staff-bankaccount" placeholder="账号">
        </div>
        <div class="alert alert-info" style="margin-top: 12px;">
          <span>💡</span>
          <span>修改银行信息后，会计将收到变更提醒</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="App.closeModal('edit-staff-modal')">取消</button>
        <button class="btn btn-primary" id="btn-update-staff" onclick="App.saveStaffEdit()">💾 保存修改</button>
      </div>
    </div>
  </div>

  <!-- Staff Leave Modal -->
  <div class="modal-overlay" id="staff-leave-modal">
    <div class="modal" style="max-width: 520px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);">
        <h3 class="modal-title">🚪 员工离职确认</h3>
        <button class="modal-close" onclick="App.closeModal('staff-leave-modal')">✕</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="leave-staff-name">
        <input type="hidden" id="leave-staff-salary">
        <input type="hidden" id="leave-staff-type" value="STAFF">
        
        <!-- 员工信息显示 -->
        <div style="background: linear-gradient(135deg, #FEF2F2 0%, #FEE2E2 100%); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div id="leave-staff-avatar" style="width: 48px; height: 48px; border-radius: 50%; background: #EF4444; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 600;">?</div>
            <div>
              <div style="font-weight: 600; font-size: 16px;" id="leave-display-name">-</div>
              <div style="font-size: 13px; color: #6B7280;" id="leave-display-company">-</div>
            </div>
          </div>
          <div style="display: flex; gap: 20px; margin-top: 12px; font-size: 14px;">
            <span>💰 月薪: <strong style="color: #059669;">RM <span id="leave-display-salary">0</span></strong></span>
            <span id="leave-display-bank"></span>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">📅 离职日期 *</label>
          <input class="form-input" id="leave-date" type="date" required onchange="App.calculateLeaveSalary()">
        </div>
        
        <div class="form-group">
          <label class="form-label">📝 离职原因</label>
          <textarea class="form-input" id="leave-reason" rows="2" placeholder="可选填写离职原因..."></textarea>
        </div>
        
        <div style="border-top: 1px solid #E5E7EB; padding-top: 16px; margin-top: 16px;">
          <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <span>💵</span>
            <span>最后一笔工资</span>
            <span id="leave-calc-info" style="font-weight: 400; font-size: 12px; color: #6B7280; margin-left: auto;"></span>
          </div>
          
          <div class="grid grid-2">
            <div class="form-group">
              <label class="form-label">工资月份 *</label>
              <input class="form-input" id="leave-salary-month" type="month" required onchange="App.calculateLeaveSalary()">
            </div>
            <div class="form-group">
              <label class="form-label">发放方式 *</label>
              <select class="form-input" id="leave-payment-method">
                <option value="BANK">🏦 银行汇款</option>
                <option value="CASH">💵 现金</option>
              </select>
            </div>
          </div>
          
          <div class="grid grid-2">
            <div class="form-group">
              <label class="form-label">基本工资 (RM)</label>
              <input class="form-input" id="leave-basic-salary" type="number" step="0.01" min="0" oninput="App.updateLeaveNetSalary()">
            </div>
            <div class="form-group">
              <label class="form-label">扣款 (RM)</label>
              <input class="form-input" id="leave-deduction" type="number" step="0.01" min="0" value="0" oninput="App.updateLeaveNetSalary()">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">扣款/备注原因</label>
            <input class="form-input" id="leave-remark" type="text" placeholder="离职最后工资">
          </div>
          
          <div style="background: #ECFDF5; padding: 12px 16px; border-radius: 8px; margin-top: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: #065F46; font-weight: 500;">实发工资</span>
              <span style="color: #059669; font-size: 20px; font-weight: 700;">RM <span id="leave-net-salary">0</span></span>
            </div>
          </div>
        </div>
        
        <div class="alert alert-warning" style="margin-top: 16px;">
          <span>⚠️</span>
          <span>确认后将：1) 设置员工为离职状态 2) 自动创建最后工资草稿</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="App.closeModal('staff-leave-modal')">取消</button>
        <button class="btn btn-danger" onclick="App.confirmLeave()">🚪 确认离职并创建工资</button>
      </div>
    </div>
  </div>

  <!-- Adjust Salary Modal -->
  <div class="modal-overlay" id="adjust-salary-modal">
    <div class="modal" style="max-width: 480px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);">
        <h3 class="modal-title">📈 调整薪资</h3>
        <button class="modal-close" onclick="App.closeModal('adjust-salary-modal')">✕</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="adjust-salary-name">
        <input type="hidden" id="adjust-salary-type">
        
        <!-- 员工信息显示 -->
        <div style="background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div id="adjust-salary-avatar" style="width: 48px; height: 48px; border-radius: 50%; background: #059669; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 600;">?</div>
            <div>
              <div style="font-weight: 600; font-size: 16px;" id="adjust-salary-display-name">-</div>
              <div style="font-size: 13px; color: #6B7280;" id="adjust-salary-display-company">-</div>
            </div>
          </div>
        </div>
        
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">当前月薪</label>
            <div style="background: #F3F4F6; padding: 12px 16px; border-radius: 8px; font-size: 18px; font-weight: 600; color: #6B7280;">
              RM <span id="adjust-salary-current">0</span>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">新月薪 (RM) *</label>
            <input class="form-input" id="adjust-salary-new" type="number" step="0.01" min="0" required oninput="App.updateAdjustSalaryDiff()" style="font-size: 18px; font-weight: 600;">
          </div>
        </div>
        
        <!-- 调薪幅度显示 -->
        <div id="adjust-salary-diff-box" style="background: #EFF6FF; padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; display: none;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="color: #1E40AF; font-weight: 500;">调薪幅度</span>
            <span id="adjust-salary-diff" style="font-size: 16px; font-weight: 700;">-</span>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">生效日期 *</label>
          <input class="form-input" id="adjust-salary-date" type="date" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">调薪原因 *</label>
          <input class="form-input" id="adjust-salary-reason" type="text" required placeholder="如：年度调薪、升职加薪、试用期转正">
        </div>
        
        <div class="alert alert-info" style="margin-top: 16px;">
          <span>💡</span>
          <span>调薪后，新月薪将立即生效。旧薪资会保存在记录中。</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="App.closeModal('adjust-salary-modal')">取消</button>
        <button class="btn btn-success" onclick="App.saveAdjustSalary()">📈 确认调薪</button>
      </div>
    </div>
  </div>

  <!-- Set Debt Modal -->
  <div class="modal-overlay" id="set-debt-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">💸 设置欠款</h3>
        <button class="modal-close" onclick="App.closeModal('set-debt-modal')">✕</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="debt-staff-name">
        <input type="hidden" id="debt-staff-type" value="STAFF">
        
        <div class="alert alert-warning" style="margin-bottom: 16px;">
          <span>⚠️</span>
          <span>设置欠款后，系统将在每月工资中自动扣除</span>
        </div>
        
        <div style="background: #F3F4F6; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
          <div style="font-weight: 600; margin-bottom: 8px;">👤 <span id="debt-display-name">-</span></div>
          <div style="display: flex; gap: 20px; font-size: 14px; color: #666;">
            <span>当前欠款: <strong style="color: #EF4444;">RM <span id="debt-current-total">0</span></strong></span>
            <span>已还: <strong style="color: #10B981;">RM <span id="debt-current-paid">0</span></strong></span>
            <span>剩余: <strong style="color: #F59E0B;">RM <span id="debt-current-remaining">0</span></strong></span>
          </div>
        </div>
        
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">欠款总额 (RM) *</label>
            <input class="form-input" id="debt-total" type="number" step="0.01" min="0" placeholder="0.00">
            <small style="color: #666;">设为 0 表示无欠款</small>
          </div>
          <div class="form-group">
            <label class="form-label">每月扣款 (RM) *</label>
            <input class="form-input" id="debt-monthly" type="number" step="0.01" min="0" placeholder="0.00">
            <small style="color: #666;">每月自动从工资扣除</small>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">欠款原因</label>
          <input class="form-input" id="debt-reason" placeholder="如：预支工资、借款等">
        </div>
        
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="debt-reset-paid" style="width: 18px; height: 18px;">
            <span>重置已还金额为 0（重新计算欠款）</span>
          </label>
        </div>
        
        <div id="debt-preview" style="background: #EFF6FF; padding: 12px; border-radius: 8px; margin-top: 12px; display: none;">
          <div style="font-weight: 600; color: #1D4ED8; margin-bottom: 4px;">📊 还款预览</div>
          <div style="font-size: 14px; color: #374151;" id="debt-preview-text"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="App.closeModal('set-debt-modal')">取消</button>
        <button class="btn btn-primary" id="btn-save-debt" onclick="App.saveDebtSettings()">💾 保存</button>
      </div>
    </div>
  </div>

  <!-- Add Manager Modal -->
  <div class="modal-overlay" id="add-manager-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">👔 添加主管</h3>
        <button class="modal-close" onclick="App.closeModal('add-manager-modal')">✕</button>
      </div>
      <div class="modal-body">
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">主管姓名 *</label>
            <input class="form-input" id="new-manager-name" placeholder="主管姓名">
          </div>
          <div class="form-group">
            <label class="form-label">公司名称</label>
            <input class="form-input" id="new-manager-company" placeholder="公司名称">
          </div>
        </div>
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">月薪 (RM)</label>
            <input class="form-input" id="new-manager-salary" type="number" step="0.01" placeholder="0.00">
          </div>
          <div class="form-group">
            <label class="form-label">入职日期</label>
            <input class="form-input" id="new-manager-joindate" type="date">
          </div>
        </div>
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">付款方式</label>
            <select class="form-select" id="new-manager-payment">
              <option value="BANK">银行汇款</option>
              <option value="CASH">现金</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">银行户名</label>
            <input class="form-input" id="new-manager-bankholder" placeholder="Bank Holder">
          </div>
        </div>
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">银行类型</label>
            <input class="form-input" id="new-manager-banktype" placeholder="如 MAYBANK">
          </div>
          <div class="form-group">
            <label class="form-label">银行账号</label>
            <input class="form-input" id="new-manager-bankaccount" placeholder="账号">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="App.closeModal('add-manager-modal')">取消</button>
        <button class="btn btn-primary" id="btn-save-manager" onclick="App.saveNewManager()">保存主管</button>
      </div>
    </div>
  </div>

  <!-- Edit Manager Modal -->
  <div class="modal-overlay" id="edit-manager-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">✏️ 编辑主管信息</h3>
        <button class="modal-close" onclick="App.closeModal('edit-manager-modal')">✕</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-manager-original-name">
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">主管姓名</label>
            <input class="form-input" id="edit-manager-name" disabled style="background: #f3f4f6;">
          </div>
          <div class="form-group">
            <label class="form-label">公司名称</label>
            <input class="form-input" id="edit-manager-company" placeholder="公司名称">
          </div>
        </div>
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">月薪 (RM)</label>
            <input class="form-input" id="edit-manager-salary" type="number" step="0.01" placeholder="0.00">
          </div>
          <div class="form-group">
            <label class="form-label">付款方式</label>
            <select class="form-select" id="edit-manager-payment">
              <option value="BANK">银行汇款</option>
              <option value="CASH">现金</option>
            </select>
          </div>
        </div>
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">银行户名</label>
            <input class="form-input" id="edit-manager-bankholder" placeholder="Bank Holder">
          </div>
          <div class="form-group">
            <label class="form-label">银行类型</label>
            <input class="form-input" id="edit-manager-banktype" placeholder="如 MAYBANK">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">银行账号</label>
          <input class="form-input" id="edit-manager-bankaccount" placeholder="账号">
        </div>
        <div class="alert alert-info" style="margin-top: 12px;">
          <span>💡</span>
          <span>修改银行信息后，系统将自动记录变更</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="App.closeModal('edit-manager-modal')">取消</button>
        <button class="btn btn-primary" id="btn-update-manager" onclick="App.saveManagerEdit()">💾 保存修改</button>
      </div>
    </div>
  </div>

  <!-- Reset Password Modal -->
  <div class="modal-overlay" id="reset-password-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">🔑 重置密码</h3>
        <button class="modal-close" onclick="App.closeModal('reset-password-modal')">✕</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="reset-password-username">
        <div class="alert alert-warning" style="margin-bottom: 16px;">
          <span>⚠️</span>
          <span>重置后用户需要使用新密码登录</span>
        </div>
        <div style="background: #F3F4F6; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
          <div style="font-weight: 600;">👤 用户: <span id="reset-password-display">-</span></div>
        </div>
        <div class="form-group">
          <label class="form-label">新密码 *</label>
          <input class="form-input" id="new-password" type="password" placeholder="输入新密码 (至少6位)">
        </div>
        <div class="form-group">
          <label class="form-label">确认密码 *</label>
          <input class="form-input" id="confirm-password" type="password" placeholder="再次输入新密码">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="App.closeModal('reset-password-modal')">取消</button>
        <button class="btn btn-primary" id="btn-reset-password" onclick="App.confirmResetPassword()">🔑 确认重置</button>
      </div>
    </div>
  </div>

  <!-- Add User Modal -->
  <div class="modal-overlay" id="add-user-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">➕ 添加用户</h3>
        <button class="modal-close" onclick="App.closeModal('add-user-modal')">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">用户名 *</label>
          <input class="form-input" id="user-username" placeholder="3-20位字母数字下划线">
        </div>
        <div class="form-group">
          <label class="form-label">初始密码 *</label>
          <input class="form-input" id="user-password" type="password" placeholder="至少6个字符">
        </div>
        <div class="form-group">
          <label class="form-label">显示名称</label>
          <input class="form-input" id="user-display" placeholder="可选，默认使用用户名">
        </div>
        <div class="form-group">
          <label class="form-label">角色 *</label>
          <select class="form-select" id="new-user-role">
            <option value="SECRETARY">书记</option>
            <option value="ACCOUNTANT">会计</option>
            <option value="ADMIN">管理员</option>
          </select>
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="user-require-pwd-change" checked>
            <span>首次登录需更换密码</span>
          </label>
        </div>
        <div class="message" id="user-message"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="App.closeModal('add-user-modal')">取消</button>
        <button class="btn btn-primary" onclick="App.handleAddUser()">创建账号</button>
      </div>
    </div>
  </div>

  <!-- Edit Draft Modal -->
  <div class="modal-overlay" id="edit-draft-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">✏️ 编辑草稿</h3>
        <button class="modal-close" onclick="App.closeEditModal()">✕</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-row-index">
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">姓名</label>
            <input class="form-input" id="edit-salary-staff-name" readonly style="background: var(--bg-elevated);">
          </div>
          <div class="form-group">
            <label class="form-label">月份</label>
            <input class="form-input" id="edit-month" readonly style="background: var(--bg-elevated);">
          </div>
        </div>
        <div class="grid grid-2">
          <div class="form-group">
            <label class="form-label">基本工资 (RM) *</label>
            <input class="form-input" id="edit-basic-salary" type="number" step="0.01">
          </div>
          <div class="form-group">
            <label class="form-label">扣款 (RM)</label>
            <input class="form-input" id="edit-deduction" type="number" step="0.01" value="0">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">备注</label>
          <input class="form-input" id="edit-remark" placeholder="可选备注">
        </div>
        <div class="form-group">
          <label class="form-label">净工资</label>
          <input class="form-input" id="edit-net-salary" readonly style="background: var(--success-bg); color: #059669; font-weight: 700;">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="App.closeEditModal()">取消</button>
        <button class="btn btn-primary" id="btn-save-draft" onclick="App.saveDraftEdit()">💾 保存修改</button>
      </div>
    </div>
  </div>

  <!-- Password Change Modal -->
  <div class="modal-overlay" id="password-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="password-modal-title">🔐 更换密码</h3>
        <button class="modal-close" id="password-modal-close" onclick="App.closePasswordModal()">✕</button>
      </div>
      <div class="modal-body">
        <div class="form-group" id="old-password-group">
          <label class="form-label">当前密码</label>
          <input class="form-input" id="change-old-password" type="password" placeholder="请输入当前密码">
        </div>
        <div class="form-group">
          <label class="form-label">新密码 *</label>
          <input class="form-input" id="change-new-password" type="password" placeholder="请输入新密码（至少6位）" oninput="App.checkPasswordStrength()">
          <div class="password-strength">
            <div class="password-strength-bar" id="password-strength-bar"></div>
          </div>
          <div class="password-strength-text" id="password-strength-text"></div>
        </div>
        <div class="form-group">
          <label class="form-label">确认新密码 *</label>
          <input class="form-input" id="change-confirm-password" type="password" placeholder="请再次输入新密码">
        </div>
        <div class="message" id="password-change-message"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="password-cancel-btn" onclick="App.closePasswordModal()">取消</button>
        <button class="btn btn-primary" onclick="App.handleChangePassword()">确认更换</button>
      </div>
    </div>
  </div>

  <!-- Bank Summary Modal -->
  <div class="modal-overlay" id="bank-summary-modal">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h3 class="modal-title" id="bank-summary-title">📋 银行汇款汇总</h3>
        <button class="modal-close" onclick="App.closeBankSummaryModal()">✕</button>
      </div>
      <div class="modal-body" id="bank-summary-content" style="max-height: 60vh; overflow-y: auto;">
        <!-- Content will be rendered here -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="App.copyBankSummary()">📋 复制</button>
        <button class="btn btn-primary" onclick="App.closeBankSummaryModal()">关闭</button>
      </div>
    </div>
  </div>

  <!-- Bank Change Detail Modal -->
  <div class="modal-overlay" id="bank-change-detail-modal">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h3 class="modal-title">🏦 银行资料变更详情</h3>
        <button class="modal-close" onclick="App.closeBankChangeDetailModal()">✕</button>
      </div>
      <div class="modal-body" id="bank-change-detail-content">
        <!-- Content will be rendered here -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="App.closeBankChangeDetailModal()">关闭</button>
      </div>
    </div>
  </div>

  <!-- Alert Detail Modal (通用提醒详情模态框) -->
  <div class="modal-overlay" id="alert-detail-modal">
    <div class="modal modal-lg">
      <div class="modal-header" id="alert-detail-header">
        <h3 class="modal-title" id="alert-detail-title">📋 详情</h3>
        <button class="modal-close" onclick="App.closeModal('alert-detail-modal')">✕</button>
      </div>
      <div class="modal-body" id="alert-detail-content" style="max-height: 60vh; overflow-y: auto;">
        <!-- Content will be rendered here -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="App.closeModal('alert-detail-modal')">关闭</button>
      </div>
    </div>
  </div>

  <!-- Secretary Detail Modal -->
  <div class="modal-overlay" id="secretary-detail-modal">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h3 class="modal-title" id="secretary-detail-title">👤 书记详情</h3>
        <button class="modal-close" onclick="App.closeSecretaryDetailModal()">✕</button>
      </div>
      <div class="modal-body" id="secretary-detail-content" style="max-height: 60vh; overflow-y: auto;">
        <!-- Content will be rendered here -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="App.filterStaffBySecretary()">📋 查看员工列表</button>
        <button class="btn btn-primary" onclick="App.closeSecretaryDetailModal()">关闭</button>
      </div>
    </div>
  </div>
<script>
// ========== Custom Confirm Dialog ==========
let _confirmResolve = null;

function showConfirm(options) {
  return new Promise((resolve) => {
    _confirmResolve = resolve;
    const overlay = document.getElementById('confirm-overlay');
    const icon = document.getElementById('confirm-icon');
    const title = document.getElementById('confirm-title');
    const message = document.getElementById('confirm-message');
    const okBtn = document.getElementById('confirm-ok');
    const cancelBtn = document.getElementById('confirm-cancel');
    
    title.textContent = options.title || '确认操作';
    message.textContent = options.message || '您确定要执行此操作吗？';
    okBtn.textContent = options.okText || '确定';
    cancelBtn.textContent = options.cancelText || '取消';
    
    const type = options.type || 'warning';
    const icons = { warning: '⚠️', danger: '🗑️', info: 'ℹ️', success: '✓', logout: '🚪', submit: '📤' };
    icon.textContent = icons[type] || '⚠️';
    icon.className = 'confirm-icon ' + type;
    okBtn.className = 'btn ' + (type === 'danger' ? 'btn-danger' : 'btn-primary');
    
    overlay.classList.add('show');
    setTimeout(() => okBtn.focus(), 100);
  });
}

function hideConfirm(result) {
  document.getElementById('confirm-overlay').classList.remove('show');
  if (_confirmResolve) { _confirmResolve(result); _confirmResolve = null; }
}

// 绑定确认对话框事件
document.addEventListener('DOMContentLoaded', function() {
  const okBtn = document.getElementById('confirm-ok');
  const cancelBtn = document.getElementById('confirm-cancel');
  const overlay = document.getElementById('confirm-overlay');
  
  if (okBtn) okBtn.addEventListener('click', () => hideConfirm(true));
  if (cancelBtn) cancelBtn.addEventListener('click', () => hideConfirm(false));
  if (overlay) {
    overlay.addEventListener('click', function(e) {
      if (e.target === this) hideConfirm(false);
    });
  }
  
  document.addEventListener('keydown', function(e) {
    const confirmOverlay = document.getElementById('confirm-overlay');
    if (confirmOverlay && confirmOverlay.classList.contains('show')) {
      if (e.key === 'Escape') hideConfirm(false);
      if (e.key === 'Enter') hideConfirm(true);
    }
  });
});

// ========== 完整的 App 模块 ==========
const App = (function() {
  'use strict';
  
  // ========== 私有变量 ==========
  let _currentUser = null;
  let _staffList = [];
  let _employeeList = [];
  let _managerList = [];
  let _draftList = [];
  let _employeePendingData = [];
  let _managerPendingData = [];
  let _bankChangeAlerts = [];
  let _debtAlerts = [];
  let _newStaffAlerts = [];
  let _leftStaffAlerts = [];
  let _salaryAdjustAlerts = [];
  let _logList = [];
  let _staffFilter = 'all';
  let _managerFilter = 'all';
  let _isFirstLoginPasswordChange = false;
  const _debounceTimers = {};

  // ========== 工具函数 ==========
  function escapeHtml(s) {
    if (s == null) return '';
    return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
  }

  // 数字滚动动画
  function animateNumber(elementId, targetValue, prefix = '', suffix = '', duration = 800) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    // 解析目标数值
    let target = targetValue;
    if (typeof targetValue === 'string') {
      target = parseFloat(targetValue.replace(/[^0-9.-]/g, '')) || 0;
    }
    
    const startValue = 0;
    const startTime = performance.now();
    
    function update(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      
      // 使用 easeOutExpo 缓动函数
      const easeProgress = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
      const currentValue = startValue + (target - startValue) * easeProgress;
      
      // 格式化显示
      if (target >= 1000) {
        element.textContent = prefix + Math.round(currentValue).toLocaleString() + suffix;
      } else {
        element.textContent = prefix + Math.round(currentValue) + suffix;
      }
      
      if (progress < 1) {
        requestAnimationFrame(update);
      }
    }
    
    requestAnimationFrame(update);
  }

  // 骨架屏模板
  function createSkeletonCard() {
    return `
      <div class="skeleton-card">
        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
          <div class="skeleton skeleton-avatar"></div>
          <div style="flex: 1;">
            <div class="skeleton skeleton-text short"></div>
            <div class="skeleton skeleton-text medium"></div>
          </div>
        </div>
        <div class="skeleton skeleton-text long"></div>
        <div class="skeleton skeleton-text medium"></div>
      </div>
    `;
  }

  // 显示骨架屏
  function showSkeleton(containerId, count = 6) {
    const container = document.getElementById(containerId);
    if (!container) return;
    let html = '';
    for (let i = 0; i < count; i++) {
      html += createSkeletonCard();
    }
    container.innerHTML = html;
  }

  // 隐藏骨架屏（由实际内容替换）
  function hideSkeleton(containerId) {
    // 骨架屏会被实际内容替换，此函数仅作为语义化调用
  }

  // 成功动画
  function showSuccessAnimation(title, subtitle) {
    const overlay = document.getElementById('success-animation');
    const textEl = document.getElementById('success-text');
    const subEl = document.getElementById('success-subtext');
    
    if (textEl) textEl.textContent = title || '操作成功！';
    if (subEl) subEl.textContent = subtitle || '';
    if (overlay) {
      overlay.classList.add('show');
      // 自动关闭
      setTimeout(() => {
        overlay.classList.remove('show');
      }, 2000);
    }
  }

  // 刷新仪表板
  function refreshDashboard() {
    const icon = document.getElementById('refresh-icon');
    if (icon) icon.classList.add('spinning');
    
    loadDashboard();
    
    setTimeout(() => {
      if (icon) icon.classList.remove('spinning');
      showToast('刷新成功', 'success');
    }, 1000);
  }

  // 快捷金额操作
  function addQuickAmount(inputId, amount) {
    const input = document.getElementById(inputId);
    if (!input) return;
    const current = parseFloat(input.value) || 0;
    input.value = current + amount;
    previewSalary();
  }

  function setQuickAmount(inputId, amount) {
    const input = document.getElementById(inputId);
    if (!input) return;
    input.value = amount;
    previewSalary();
  }

  // 表单实时验证
  function validateSalaryInput(input) {
    const value = parseFloat(input.value);
    const formGroup = input.closest('.form-group');
    
    if (isNaN(value) || value < 0) {
      input.classList.add('error');
      input.classList.remove('success');
      if (formGroup) formGroup.classList.add('has-error');
    } else {
      input.classList.remove('error');
      input.classList.add('success');
      if (formGroup) formGroup.classList.remove('has-error');
    }
    
    previewSalary();
  }

  // 排序相关
  let _staffSortBy = 'name';
  let _staffSortOrder = 'asc';
  let _managerSortBy = 'name';
  let _managerSortOrder = 'asc';

  function sortStaffList(sortBy) {
    if (_staffSortBy === sortBy) {
      _staffSortOrder = _staffSortOrder === 'asc' ? 'desc' : 'asc';
    } else {
      _staffSortBy = sortBy;
      _staffSortOrder = 'asc';
    }
    renderStaffList();
  }

  function sortManagerList(sortBy) {
    if (_managerSortBy === sortBy) {
      _managerSortOrder = _managerSortOrder === 'asc' ? 'desc' : 'asc';
    } else {
      _managerSortBy = sortBy;
      _managerSortOrder = 'asc';
    }
    renderManagerList();
  }

  // 分页相关
  let _staffCurrentPage = 1;
  let _managerCurrentPage = 1;
  const _pageSize = 20;

  function setStaffPage(page) {
    _staffCurrentPage = page;
    renderStaffList();
  }

  function setManagerPage(page) {
    _managerCurrentPage = page;
    renderManagerList();
  }

  function renderPagination(containerId, currentPage, totalPages, setPageFn) {
    const container = document.getElementById(containerId);
    if (!container || totalPages <= 1) {
      if (container) container.style.display = 'none';
      return;
    }
    
    container.style.display = 'flex';
    
    let html = '';
    
    // 上一页
    html += `<button class="pagination-btn" onclick="App.${setPageFn}(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>◀</button>`;
    
    // 页码
    const maxVisible = 5;
    let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let end = Math.min(totalPages, start + maxVisible - 1);
    if (end - start < maxVisible - 1) {
      start = Math.max(1, end - maxVisible + 1);
    }
    
    if (start > 1) {
      html += `<button class="pagination-btn" onclick="App.${setPageFn}(1)">1</button>`;
      if (start > 2) html += `<span class="pagination-info">...</span>`;
    }
    
    for (let i = start; i <= end; i++) {
      html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="App.${setPageFn}(${i})">${i}</button>`;
    }
    
    if (end < totalPages) {
      if (end < totalPages - 1) html += `<span class="pagination-info">...</span>`;
      html += `<button class="pagination-btn" onclick="App.${setPageFn}(${totalPages})">${totalPages}</button>`;
    }
    
    // 下一页
    html += `<button class="pagination-btn" onclick="App.${setPageFn}(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>▶</button>`;
    
    // 页码信息
    html += `<span class="pagination-info">第 ${currentPage}/${totalPages} 页</span>`;
    
    container.innerHTML = html;
  }

  // 计算入职天数
  function calculateDaysFromJoin(createdAt) {
    if (!createdAt) return null;
    try {
      const joinDate = new Date(createdAt);
      const now = new Date();
      const diffTime = now - joinDate;
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      return diffDays;
    } catch (e) {
      return null;
    }
  }

  // 清除出粮筛选
  function clearPaymentFilters() {
    const companyFilter = document.getElementById('emp-company-filter');
    const minFilter = document.getElementById('emp-amount-min');
    const maxFilter = document.getElementById('emp-amount-max');
    
    if (companyFilter) companyFilter.value = '';
    if (minFilter) minFilter.value = '';
    if (maxFilter) maxFilter.value = '';
    
    filterPayments('all');
  }

  // 键盘快捷键
  function initKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
      // Esc 关闭所有弹窗
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.show').forEach(modal => {
          modal.classList.remove('show');
        });
      }
      
      // Enter 在表单中提交
      if (e.key === 'Enter' && e.target.tagName === 'INPUT' && !e.shiftKey) {
        const form = e.target.closest('.card-body');
        if (form) {
          const submitBtn = form.querySelector('.btn-primary');
          if (submitBtn && !submitBtn.disabled) {
            e.preventDefault();
            submitBtn.click();
          }
        }
      }
    });
  }

  function debounce(fn, wait, key) {
    key = key || 'default';
    return function() {
      const args = arguments, ctx = this;
      clearTimeout(_debounceTimers[key]);
      _debounceTimers[key] = setTimeout(() => fn.apply(ctx, args), wait);
    };
  }

  function getCurrentMonth() {
    const now = new Date();
    return now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
  }

  function formatDate(dateStr) {
    if (!dateStr) return '-';
    try {
      const d = new Date(dateStr);
      return d.toLocaleDateString('zh-CN');
    } catch (e) {
      return dateStr;
    }
  }

  function getAvatarColor(name) {
    const colors = ['coral', 'green', 'blue', 'purple', 'orange', 'teal'];
    const hash = (name || 'A').charCodeAt(0) % colors.length;
    return colors[hash];
  }

  // ========== Loading & Toast ==========
  function showLoading(text) {
    const overlay = document.getElementById('loading-overlay');
    const textEl = document.getElementById('loading-text');
    if (textEl) textEl.textContent = text || '加载中...';
    if (overlay) overlay.classList.add('show');
  }

  function hideLoading() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) overlay.classList.remove('show');
  }

  function setBtnLoading(id, loading) {
    const btn = document.getElementById(id);
    if (!btn) return;
    btn.classList.toggle('loading', loading);
    btn.disabled = loading;
  }

  function showToast(message, type) {
    type = type || 'success';
    const container = document.getElementById('toast-container');
    if (!container) return;
    
    const toast = document.createElement('div');
    toast.className = 'toast ' + type;
    const icons = { success: '✓', error: '✕', warning: '⚠', info: 'ℹ' };
    toast.innerHTML = `
      <div class="toast-icon">${icons[type] || '•'}</div>
      <span>${escapeHtml(message)}</span>
      <span class="toast-close" onclick="this.parentElement.remove()">✕</span>
    `;
    container.appendChild(toast);
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateX(20px)';
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  function showMessage(id, msg, type) {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = msg;
    el.className = 'message show ' + type;
    setTimeout(() => el.classList.remove('show'), 6000);
  }

  function showError(e, context) {
    let msg = '操作失败';
    if (typeof e === 'string') msg = e;
    else if (e && e.message) msg = e.message;
    if (context) msg = context + '：' + msg;
    showToast(msg, 'error');
    console.error('[Error]', context, e);
  }

  // ========== Modal 管理 ==========
  function showModal(id) {
    const modal = document.getElementById(id);
    if (modal) modal.classList.add('show');
  }

  function closeModal(id) {
    const modal = document.getElementById(id);
    if (modal) modal.classList.remove('show');
  }

  // ========== 验证函数 ==========
  function validateStaffForm(isManager) {
    const nameEl = document.getElementById('new-staff-name');
    const name = nameEl ? nameEl.value.trim() : '';
    
    if (!name) { showToast('姓名不能为空', 'error'); return false; }
    if (name.length > 50) { showToast('姓名不能超过50字符', 'error'); return false; }
    return true;
  }

  function validateSalaryForm() {
    const month = document.getElementById('salary-month').value.trim();
    const date = document.getElementById('salary-date').value;
    const staff = document.getElementById('salary-staff').value;
    const basic = document.getElementById('salary-basic').value;
    
    if (!month || !/^\d{4}-\d{2}$/.test(month)) { showToast('月份格式不正确 (YYYY-MM)', 'error'); return false; }
    if (!date) { showToast('请选择日期', 'error'); return false; }
    if (!staff) { showToast('请选择员工/主管', 'error'); return false; }
    if (!basic || isNaN(basic) || Number(basic) < 0) { showToast('基本工资不合理', 'error'); return false; }
    return true;
  }

  function validateUserForm() {
    const username = document.getElementById('user-username').value.trim();
    const password = document.getElementById('user-password').value.trim();
    
    if (!username || username.length < 3 || !/^[a-zA-Z0-9_]+$/.test(username)) {
      showToast('用户名格式不正确（3-20位字母数字下划线）', 'error'); return false;
    }
    if (!password || password.length < 6) { showToast('密码至少6个字符', 'error'); return false; }
    return true;
  }

  // ========== 初始化 ==========
  function init() {
    document.getElementById('login-section').style.display = 'flex';
    
    // 绑定导航点击
    document.querySelectorAll('.nav-item[data-page]').forEach(item => {
      item.addEventListener('click', function() { navigateTo(this.dataset.page); });
    });
    
    // 登录回车
    document.addEventListener('keydown', e => {
      if (e.key === 'Enter' && document.getElementById('login-section').style.display !== 'none') {
        handleLogin();
      }
    });
    
    // 工资页面输入事件
    const salaryBasic = document.getElementById('salary-basic');
    const salaryDeduction = document.getElementById('salary-deduction');
    if (salaryBasic) salaryBasic.addEventListener('input', debounce(previewSalary, 300, 'preview'));
    if (salaryDeduction) salaryDeduction.addEventListener('input', debounce(previewSalary, 300, 'preview'));
    
    // 欠款表单事件
    const debtTotal = document.getElementById('debt-total');
    const debtMonthly = document.getElementById('debt-monthly');
    const debtReset = document.getElementById('debt-reset-paid');
    if (debtTotal) debtTotal.addEventListener('input', updateDebtPreview);
    if (debtMonthly) debtMonthly.addEventListener('input', updateDebtPreview);
    if (debtReset) debtReset.addEventListener('change', updateDebtPreview);
    
    // Radio group 样式
    document.querySelectorAll('.radio-item input[type="radio"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const group = this.closest('.radio-group');
        if (group) {
          group.querySelectorAll('.radio-item').forEach(item => {
            item.classList.toggle('selected', item.contains(this) && this.checked);
          });
        }
      });
    });
    
    // 初始化键盘快捷键
    initKeyboardShortcuts();
  }

  function initApp() {
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('app-section').style.display = 'block';
    
    const displayName = _currentUser.displayName || _currentUser.username;
    document.getElementById('user-name').textContent = escapeHtml(displayName);
    document.getElementById('user-avatar').textContent = displayName.charAt(0).toUpperCase();
    
    const roleNames = { ADMIN: '管理员', SECRETARY: '书记', ACCOUNTANT: '会计' };
    document.getElementById('user-role').textContent = roleNames[_currentUser.role] || _currentUser.role;
    
    // 设置角色CSS class
    document.body.classList.add('is-' + _currentUser.role.toLowerCase());
    
    // 显示对应角色的仪表板区域
    const accStats = document.getElementById('accountant-stats-section');
    if (accStats && (_currentUser.role === 'ADMIN' || _currentUser.role === 'ACCOUNTANT')) {
      accStats.style.display = 'block';
    }
    
    // 更新当前月份显示
    const now = new Date();
    const monthDisplay = document.getElementById('current-month-display');
    if (monthDisplay) {
      monthDisplay.textContent = now.getFullYear() + '年' + (now.getMonth() + 1) + '月';
    }
    
    // 加载数据
    setTimeout(() => {
      loadStaffList();
      loadDashboard();
    }, 100);
    
    // 首次登录强制改密
    if (_currentUser.mustChangePassword) {
      setTimeout(() => openPasswordModal(true), 500);
    } else {
      showToast('欢迎回来，' + displayName, 'success');
    }
  }

  // ========== 登录/登出 ==========
  function handleLogin() {
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value.trim();
    
    if (!username || !password) {
      showMessage('login-message', '请输入账号和密码', 'error');
      return;
    }
    
    setBtnLoading('login-btn', true);
    
    google.script.run
      .withSuccessHandler(function(r) {
        setBtnLoading('login-btn', false);
        if (!r.success) {
          showMessage('login-message', r.message || '登录失败', 'error');
          return;
        }
        _currentUser = r.user;
        initApp();
      })
      .withFailureHandler(function(e) {
        setBtnLoading('login-btn', false);
        showError(e, '登录');
      })
      .login(username, password);
  }

  async function handleLogout() {
    const confirmed = await showConfirm({
      type: 'logout',
      title: '确认登出',
      message: '您确定要退出系统吗？',
      okText: '登出',
      cancelText: '取消'
    });
    if (!confirmed) return;
    
    // 清理状态
    _currentUser = null;
    _staffList = [];
    _employeeList = [];
    _managerList = [];
    _draftList = [];
    _employeePendingData = [];
    _managerPendingData = [];
    
    document.body.classList.remove('is-admin', 'is-secretary', 'is-accountant');
    const accStats = document.getElementById('accountant-stats-section');
    if (accStats) accStats.style.display = 'none';
    
    document.getElementById('login-username').value = '';
    document.getElementById('login-password').value = '';
    document.getElementById('app-section').style.display = 'none';
    document.getElementById('login-section').style.display = 'flex';
    
    // 重置导航
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    const dashNav = document.querySelector('.nav-item[data-page="dashboard"]');
    if (dashNav) dashNav.classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const dashPage = document.getElementById('page-dashboard');
    if (dashPage) dashPage.classList.add('active');
    
    showToast('已登出', 'info');
  }

  // ========== 页面导航 ==========
  function navigateTo(pageId) {
    document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.page === pageId));
    document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id === 'page-' + pageId));
    
    // 根据页面加载数据
    switch(pageId) {
      case 'payments':
        const empMonth = document.getElementById('emp-payment-month');
        if (empMonth && !empMonth.value) empMonth.value = getCurrentMonth();
        loadEmployeePayments();
        break;
      case 'mgr-payments':
        const mgrMonth = document.getElementById('mgr-payment-month');
        if (mgrMonth && !mgrMonth.value) mgrMonth.value = getCurrentMonth();
        loadManagerPayments();
        break;
      case 'drafts':
        const draftMonth = document.getElementById('draft-month');
        if (draftMonth && !draftMonth.value) draftMonth.value = getCurrentMonth();
        loadDrafts();
        break;
      case 'salary':
        updateSalaryPageForRole();
        autoFillSalaryDate();
        break;
      case 'logs':
        loadLogs();
        break;
      case 'history':
        loadHistory();
        break;
      case 'staff':
        loadStaffPage();
        break;
      case 'managers':
        loadManagersPage();
        break;
      case 'users':
        loadUsersPage();
        break;
    }
  }

  // ========== 员工/主管列表加载 ==========
  function loadStaffList() {
    const user = { username: _currentUser.username, role: _currentUser.role, displayName: _currentUser.displayName };
    
    if (user.role === 'ADMIN') {
      // 管理员加载主管列表
      google.script.run
        .withSuccessHandler(function(list) {
          _managerList = (list || []).filter(s => s.status !== 'LEFT');
          fillStaffSelect('salary-staff', _managerList);
        })
        .withFailureHandler(function(e) { showError(e, '加载主管列表'); })
        .getManagerList(user);
    }
    
    // 加载员工列表（书记和管理员需要）
    google.script.run
      .withSuccessHandler(function(list) {
        _staffList = list || [];
        _employeeList = _staffList.filter(s => (s.status || s.Status || '') !== 'LEFT');
        
        if (_currentUser.role === 'SECRETARY') {
          fillStaffSelect('salary-staff', _employeeList);
        }
        
        const myStaffEl = document.getElementById('stat-my-staff');
        if (myStaffEl) myStaffEl.textContent = _employeeList.length;
      })
      .withFailureHandler(function(e) { showError(e, '加载员工列表'); })
      .getStaffList(user);
  }

  function fillStaffSelect(selectId, list) {
    // 对于salary-staff，使用可搜索下拉框
    if (selectId === 'salary-staff') {
      _staffSelectList = list; // 保存列表供搜索使用
      renderStaffDropdown(list);
      return;
    }
    
    // 其他select保持原有方式
    const select = document.getElementById(selectId);
    if (!select) return;
    select.innerHTML = '<option value="">请选择</option>';
    list.forEach(item => {
      const opt = document.createElement('option');
      opt.value = item.staffName;
      let label = item.staffName;
      if (item.salary) label += ' (RM ' + Number(item.salary).toFixed(0) + ')';
      const monthlyDed = Number(item.monthlyDeduction) || 0;
      if (monthlyDed > 0) label += ' 📅扣' + monthlyDed.toFixed(0);
      const debtRemaining = Number(item.debtRemaining) || 0;
      if (debtRemaining > 0) label += ' 💸欠' + debtRemaining.toFixed(0);
      if (item.bankChanged) label += ' ⚠️';
      opt.textContent = label;
      select.appendChild(opt);
    });
  }
  
  // 可搜索下拉框相关函数
  let _staffSelectList = [];
  
  function renderStaffDropdown(list) {
    const dropdown = document.getElementById('staff-select-dropdown');
    if (!dropdown) return;
    
    if (!list || list.length === 0) {
      dropdown.innerHTML = '<div class="searchable-select-empty">暂无数据</div>';
      return;
    }
    
    dropdown.innerHTML = list.map(item => {
      const color = getAvatarColor(item.staffName);
      const monthlyDed = Number(item.monthlyDeduction) || 0;
      const debtRemaining = Number(item.debtRemaining) || 0;
      
      let subInfo = 'RM ' + Number(item.salary || 0).toLocaleString();
      if (monthlyDed > 0) subInfo += ' · 📅扣' + monthlyDed;
      if (debtRemaining > 0) subInfo += ' · 💸欠' + debtRemaining.toLocaleString();
      if (item.bankChanged) subInfo += ' · ⚠️变更';
      
      return `
        <div class="searchable-select-option" onclick="App.selectStaffOption('${escapeHtml(item.staffName)}')">
          <div class="searchable-select-option-avatar" style="background: var(--gradient-${color});">
            ${(item.staffName || '?').charAt(0).toUpperCase()}
          </div>
          <div class="searchable-select-option-info">
            <div class="searchable-select-option-name">${escapeHtml(item.staffName)}</div>
            <div class="searchable-select-option-sub">${subInfo}</div>
          </div>
        </div>
      `;
    }).join('');
  }
  
  function openStaffDropdown() {
    const wrapper = document.getElementById('staff-select-wrapper');
    if (wrapper) wrapper.classList.add('open');
    filterStaffDropdown();
  }
  
  function closeStaffDropdown() {
    const wrapper = document.getElementById('staff-select-wrapper');
    if (wrapper) wrapper.classList.remove('open');
  }
  
  function filterStaffDropdown() {
    const input = document.getElementById('staff-select-input');
    const keyword = input ? input.value.trim().toLowerCase() : '';
    
    const filtered = keyword 
      ? _staffSelectList.filter(item => (item.staffName || '').toLowerCase().includes(keyword))
      : _staffSelectList;
    
    renderStaffDropdown(filtered);
  }
  
  function selectStaffOption(name) {
    const input = document.getElementById('staff-select-input');
    const hidden = document.getElementById('salary-staff');
    
    if (input) input.value = name;
    if (hidden) hidden.value = name;
    
    closeStaffDropdown();
    onStaffSelect(); // 触发选择事件
  }
  
  // 点击页面其他地方关闭下拉框
  document.addEventListener('click', function(e) {
    const wrapper = document.getElementById('staff-select-wrapper');
    if (wrapper && !wrapper.contains(e.target)) {
      closeStaffDropdown();
    }
  });

  // ========== 仪表板 ==========
  function loadDashboard() {
    const month = getCurrentMonth();
    
    if (_currentUser.role === 'ADMIN' || _currentUser.role === 'ACCOUNTANT') {
      const progressMonth = document.getElementById('payment-progress-month');
      if (progressMonth) progressMonth.textContent = month;
      
      // 获取待发数据
      google.script.run
        .withSuccessHandler(function(r) {
          if (!r.success) return;
          
          // 更新统计卡片
          const statEmp = document.getElementById('stat-emp-count');
          const statBank = document.getElementById('stat-bank-total');
          const statCash = document.getElementById('stat-cash-total');
          const statPending = document.getElementById('stat-pending-salary');
          
          if (statEmp) statEmp.textContent = r.stats?.employeeCount || 0;
          if (statBank) statBank.textContent = 'RM ' + (r.stats?.bankTotal || 0).toFixed(0);
          if (statCash) statCash.textContent = 'RM ' + (r.stats?.cashTotal || 0).toFixed(0);
          if (statPending) statPending.textContent = 'RM ' + ((r.stats?.bankTotal || 0) + (r.stats?.cashTotal || 0)).toFixed(0);
          
          // 进度条
          const empPending = r.employeePending?.length || 0;
          const empPaid = r.employeePaid?.length || 0;
          const empTotal = empPending + empPaid;
          const empPercent = empTotal > 0 ? Math.round((empPaid / empTotal) * 100) : 0;
          
          const empProgressText = document.getElementById('emp-progress-text');
          const empProgressBar = document.getElementById('emp-progress-bar');
          if (empProgressText) empProgressText.textContent = empPaid + '/' + empTotal;
          if (empProgressBar) empProgressBar.style.width = empPercent + '%';
          
          const mgrPending = r.managerPending?.length || 0;
          const mgrPaid = r.managerPaid?.length || 0;
          const mgrTotal = mgrPending + mgrPaid;
          const mgrPercent = mgrTotal > 0 ? Math.round((mgrPaid / mgrTotal) * 100) : 0;
          
          const mgrProgressText = document.getElementById('mgr-progress-text');
          const mgrProgressBar = document.getElementById('mgr-progress-bar');
          if (mgrProgressText) mgrProgressText.textContent = mgrPaid + '/' + mgrTotal;
          if (mgrProgressBar) mgrProgressBar.style.width = mgrPercent + '%';
          
          // 书记统计
          renderSecretaryStats(r.stats?.staffBySecretary || {});
        })
        .getPendingPayments(_currentUser, month);
      
      // 银行变更提醒
      google.script.run
        .withSuccessHandler(function(r) {
          const list = document.getElementById('bank-change-list');
          const empty = document.getElementById('bank-change-empty');
          const badge = document.getElementById('bank-change-count');
          const summary = document.getElementById('bank-change-summary');
          if (badge) badge.textContent = r.count || 0;
          
          if (!r.success || !r.alerts || r.alerts.length === 0) {
            if (list) list.innerHTML = '';
            if (empty) empty.style.display = 'flex';
            if (summary) summary.style.display = 'none';
            return;
          }
          
          if (empty) empty.style.display = 'none';
          _bankChangeAlerts = r.alerts;
          
          if (list) {
            list.innerHTML = r.alerts.map((a, index) => `
              <div class="alert-card danger alert-item" onclick="App.showBankChangeDetail(${index})">
                <div class="alert-icon">${a.type === 'MANAGER' ? '👔' : '👤'}</div>
                <div class="alert-content">
                  <div class="alert-title">${escapeHtml(a.name)}</div>
                  <div class="alert-text">${escapeHtml(a.oldBankType || '无')} → ${escapeHtml(a.bankType)} · ${escapeHtml(a.changedAt || '')}</div>
                </div>
                <span style="color: var(--text-muted); font-size: 12px;">→</span>
              </div>
            `).join('');
          }
          
          // 显示汇总
          if (summary) {
            const mgrCount = r.alerts.filter(a => a.type === 'MANAGER').length;
            const staffCount = r.alerts.length - mgrCount;
            summary.innerHTML = `
              <span class="alert-summary-item">👥 员工 <span class="alert-summary-value">${staffCount}</span></span>
              <span class="alert-summary-item">👔 主管 <span class="alert-summary-value">${mgrCount}</span></span>
            `;
            summary.style.display = 'flex';
          }
        })
        .getBankChangeAlerts(_currentUser);
      
      // 欠款提醒
      google.script.run
        .withSuccessHandler(function(r) {
          const list = document.getElementById('debt-alert-list');
          const empty = document.getElementById('debt-alert-empty');
          const badge = document.getElementById('debt-alert-count');
          const summary = document.getElementById('debt-alert-summary');
          if (badge) badge.textContent = r.count || 0;
          
          // 保存数据供详情页面使用
          _debtAlerts = r.alerts || [];
          
          if (!r.success || !r.alerts || r.alerts.length === 0) {
            if (list) list.innerHTML = '';
            if (empty) empty.style.display = 'flex';
            if (summary) summary.style.display = 'none';
            return;
          }
          
          if (empty) empty.style.display = 'none';
          if (list) {
            list.innerHTML = r.alerts.map(a => `
              <div class="alert-card warning alert-item">
                <div class="alert-icon">${a.type === 'MANAGER' ? '👔' : '👤'}</div>
                <div class="alert-content">
                  <div class="alert-title">${escapeHtml(a.name)}</div>
                  <div class="alert-text">剩余 RM ${a.remaining.toFixed(0)} (每月扣 RM ${a.monthlyDeduction.toFixed(0)})</div>
                </div>
              </div>
            `).join('');
          }
          
          // 显示汇总
          if (summary) {
            const totalRemaining = r.alerts.reduce((sum, a) => sum + (a.remaining || 0), 0);
            const totalMonthly = r.alerts.reduce((sum, a) => sum + (a.monthlyDeduction || 0), 0);
            summary.innerHTML = `
              <span class="alert-summary-item">共 <span class="alert-summary-value">${r.alerts.length}</span> 人</span>
              <span class="alert-summary-item">总欠款 <span class="alert-summary-total">RM ${totalRemaining.toLocaleString()}</span></span>
            `;
            summary.style.display = 'flex';
          }
        })
        .getDebtAlerts(_currentUser);
      
      // 新员工提醒
      google.script.run
        .withSuccessHandler(function(r) {
          const list = document.getElementById('new-staff-list');
          const empty = document.getElementById('new-staff-empty');
          const badge = document.getElementById('new-staff-count');
          const summary = document.getElementById('new-staff-summary');
          if (badge) badge.textContent = r.count || 0;
          
          // 保存数据供详情页面使用
          _newStaffAlerts = r.alerts || [];
          
          if (!r.success || !r.alerts || r.alerts.length === 0) {
            if (list) list.innerHTML = '';
            if (empty) empty.style.display = 'flex';
            if (summary) summary.style.display = 'none';
            return;
          }
          
          if (empty) empty.style.display = 'none';
          if (list) {
            list.innerHTML = r.alerts.map(a => {
              const bankInfo = a.paymentMethod === 'CASH' 
                ? '💵 现金' 
                : (a.bankType ? `🏦 ${escapeHtml(a.bankType)} · ${escapeHtml(a.bankHolder || '-')} · ${escapeHtml(a.bankAccount || '')}` : '🏦 未设置');
              
              return `
                <div class="alert-card success alert-item">
                  <div class="alert-icon">${a.type === 'MANAGER' ? '👔' : '👤'}</div>
                  <div class="alert-content">
                    <div class="alert-title">${escapeHtml(a.name)}${a.type === 'MANAGER' ? ' <span style="font-size:10px;background:#8B5CF6;color:white;padding:1px 4px;border-radius:3px;">主管</span>' : ''}</div>
                    <div class="alert-text">
                      ${a.company ? escapeHtml(a.company) + ' · ' : ''}RM ${Number(a.salary || 0).toLocaleString()}
                    </div>
                    <div class="alert-text" style="font-size: 11px; color: #6B7280; margin-top: 2px;">
                      ${bankInfo}
                    </div>
                  </div>
                  <span class="badge badge-success" style="font-size: 10px;">${a.daysAgo}天前</span>
                </div>
              `;
            }).join('');
          }
          
          // 显示汇总
          if (summary) {
            const totalSalary = r.alerts.reduce((sum, a) => sum + (Number(a.salary) || 0), 0);
            const mgrCount = r.alerts.filter(a => a.type === 'MANAGER').length;
            summary.innerHTML = `
              <span class="alert-summary-item">共 <span class="alert-summary-value">${r.alerts.length}</span> 人</span>
              <span class="alert-summary-item">月薪合计 <span class="alert-summary-total">RM ${totalSalary.toLocaleString()}</span></span>
            `;
            summary.style.display = 'flex';
          }
        })
        .getNewStaffAlerts(_currentUser);
      
      // 离职员工提醒
      google.script.run
        .withSuccessHandler(function(r) {
          const list = document.getElementById('left-staff-list');
          const empty = document.getElementById('left-staff-empty');
          const badge = document.getElementById('left-staff-count');
          const summary = document.getElementById('left-staff-summary');
          if (badge) badge.textContent = r.count || 0;
          
          // 保存数据供详情页面使用
          _leftStaffAlerts = r.alerts || [];
          
          if (!r.success || !r.alerts || r.alerts.length === 0) {
            if (list) list.innerHTML = '';
            if (empty) empty.style.display = 'flex';
            if (summary) summary.style.display = 'none';
            return;
          }
          
          if (empty) empty.style.display = 'none';
          if (list) {
            list.innerHTML = r.alerts.map(a => {
              const bankInfo = a.paymentMethod === 'CASH' 
                ? '💵 现金' 
                : (a.bankType ? `🏦 ${escapeHtml(a.bankType)} · ${escapeHtml(a.bankHolder || '-')} · ${escapeHtml(a.bankAccount || '')}` : '🏦 未设置');
              
              return `
                <div class="alert-card danger alert-item" style="opacity: 0.85;">
                  <div class="alert-icon" style="filter: grayscale(100%); opacity: 0.7;">${a.type === 'MANAGER' ? '👔' : '👤'}</div>
                  <div class="alert-content">
                    <div class="alert-title" style="color: #6B7280;">${escapeHtml(a.name)}${a.type === 'MANAGER' ? ' <span style="font-size:10px;background:#9CA3AF;color:white;padding:1px 4px;border-radius:3px;">主管</span>' : ''}</div>
                    <div class="alert-text" style="color: #9CA3AF;">
                      ${a.company ? escapeHtml(a.company) + ' · ' : ''}RM ${Number(a.salary || 0).toLocaleString()}
                    </div>
                    <div class="alert-text" style="font-size: 11px; color: #9CA3AF; margin-top: 2px;">
                      ${bankInfo}
                    </div>
                  </div>
                  <span class="badge badge-error" style="font-size: 10px; opacity: 0.8;">${a.daysAgo}天前</span>
                </div>
              `;
            }).join('');
          }
          
          // 显示汇总
          if (summary) {
            const totalSalary = r.alerts.reduce((sum, a) => sum + (Number(a.salary) || 0), 0);
            summary.innerHTML = `
              <span class="alert-summary-item">共 <span class="alert-summary-value">${r.alerts.length}</span> 人离职</span>
              <span class="alert-summary-item">月薪损失 <span class="alert-summary-value" style="color:#DC2626;">RM ${totalSalary.toLocaleString()}</span></span>
            `;
            summary.style.display = 'flex';
          }
        })
        .getLeftStaffAlerts(_currentUser);
      
      // 加薪通知（近30天的调薪记录）
      google.script.run
        .withSuccessHandler(function(r) {
          const list = document.getElementById('salary-notify-list');
          const empty = document.getElementById('salary-notify-empty');
          const badge = document.getElementById('salary-notify-count');
          const monthLabel = document.getElementById('salary-notify-month');
          const summary = document.getElementById('salary-notify-summary');
          
          if (badge) badge.textContent = r.count || 0;
          if (monthLabel) monthLabel.textContent = '近30天调薪';
          
          // 保存数据供详情页面使用
          _salaryAdjustAlerts = r.list || [];
          
          if (!r.success || !r.list || r.list.length === 0) {
            if (list) list.innerHTML = '';
            if (empty) empty.style.display = 'flex';
            if (summary) summary.style.display = 'none';
            return;
          }
          
          if (empty) empty.style.display = 'none';
          if (list) {
            list.innerHTML = r.list.map(a => {
              const diffColor = a.diff > 0 ? '#059669' : '#DC2626';
              const diffSign = a.diff > 0 ? '+' : '';
              
              return `
                <div class="alert-card success alert-item">
                  <div class="alert-icon">${a.isManager ? '👔' : '👤'}</div>
                  <div class="alert-content">
                    <div class="alert-title">
                      ${escapeHtml(a.staffName)}
                      ${a.isManager ? ' <span style="font-size:10px;background:#8B5CF6;color:white;padding:1px 4px;border-radius:3px;">主管</span>' : ''}
                    </div>
                    <div class="alert-text">
                      RM ${Number(a.oldSalary || 0).toLocaleString()} → <strong style="color:${diffColor};">RM ${Number(a.newSalary || 0).toLocaleString()}</strong>
                      <span style="color:${diffColor}; font-size: 11px;">(${diffSign}${a.percent}%)</span>
                    </div>
                    <div class="alert-text" style="font-size: 11px; color: #6B7280; margin-top: 2px;">
                      ${escapeHtml(a.changeNote || '-')}
                    </div>
                  </div>
                  <span class="badge badge-success" style="font-size: 10px;">${a.daysAgo === 0 ? '今天' : a.daysAgo + '天前'}</span>
                </div>
              `;
            }).join('');
          }
          
          // 显示汇总
          if (summary) {
            const totalIncrease = r.list.reduce((sum, a) => sum + (a.diff > 0 ? a.diff : 0), 0);
            const avgPercent = r.list.length > 0 
              ? (r.list.reduce((sum, a) => sum + parseFloat(a.percent || 0), 0) / r.list.length).toFixed(1)
              : 0;
            summary.innerHTML = `
              <span class="alert-summary-item">共 <span class="alert-summary-value">${r.list.length}</span> 人调薪</span>
              <span class="alert-summary-item">平均涨幅 <span class="alert-summary-total">${avgPercent}%</span></span>
            `;
            summary.style.display = 'flex';
          }
        })
        .getSalaryNotifyAlerts(_currentUser, getCurrentMonth());
    }
    
    // 书记仪表板
    if (_currentUser.role === 'SECRETARY') {
      const entryMonth = document.getElementById('entry-progress-month');
      if (entryMonth) entryMonth.textContent = month;
      
      google.script.run
        .withSuccessHandler(function(r) {
          if (!r.success) return;
          const percent = r.progressPercent || 0;
          const entryText = document.getElementById('entry-progress-text');
          const entryBar = document.getElementById('entry-progress-bar');
          const notEntered = document.getElementById('entry-not-entered');
          
          if (entryText) entryText.textContent = r.enteredCount + '/' + r.totalPeople;
          if (entryBar) entryBar.style.width = percent + '%';
          if (notEntered) notEntered.textContent = r.notEnteredCount;
        })
        .getSalaryEntryProgress(_currentUser, month);
      
      // 书记的欠款提醒
      google.script.run
        .withSuccessHandler(function(r) {
          const list = document.getElementById('secretary-debt-list');
          const empty = document.getElementById('secretary-debt-empty');
          const badge = document.getElementById('secretary-debt-count');
          if (badge) badge.textContent = r.count || 0;
          
          if (!r.success || !r.alerts || r.alerts.length === 0) {
            if (list) list.innerHTML = '';
            if (empty) empty.style.display = 'block';
            return;
          }
          
          if (empty) empty.style.display = 'none';
          if (list) {
            list.innerHTML = r.alerts.map(a => `
              <div class="alert-card warning">
                <div class="alert-icon">👤</div>
                <div class="alert-content">
                  <div class="alert-title">${escapeHtml(a.name)}</div>
                  <div class="alert-text">剩余 RM ${a.remaining.toFixed(2)} (每月扣 RM ${a.monthlyDeduction.toFixed(2)})</div>
                </div>
              </div>
            `).join('');
          }
        })
        .getDebtAlerts(_currentUser);
      
      // 书记统计
      google.script.run
        .withSuccessHandler(function(r) {
          if (!r.success) return;
          const drafts = document.getElementById('stat-my-drafts');
          const submitted = document.getElementById('stat-my-submitted');
          const total = document.getElementById('stat-my-total');
          
          if (drafts) drafts.textContent = r.stats?.draftCount || 0;
          if (submitted) submitted.textContent = r.stats?.submittedCount || 0;
          if (total) {
            const sum = (r.stats?.staffBankTotal || 0) + (r.stats?.staffCashTotal || 0);
            total.textContent = 'RM ' + sum.toFixed(0);
          }
        })
        .getDashboardStats(_currentUser, month);
    }
  }

  // 保存书记统计数据供详情使用
  let _secretaryStatsData = {};
  let _currentSecretaryName = '';
  
  function renderSecretaryStats(staffBySecretary, salaryProgress) {
    const grid = document.getElementById('secretary-stats-grid');
    const empty = document.getElementById('secretary-stats-empty');
    const countBadge = document.getElementById('total-secretary-count');
    if (!grid) return;
    
    _secretaryStatsData = staffBySecretary;
    
    const entries = Object.entries(staffBySecretary);
    if (entries.length === 0) {
      grid.innerHTML = '';
      if (empty) empty.style.display = 'block';
      if (countBadge) countBadge.textContent = '0 位书记';
      return;
    }
    
    if (empty) empty.style.display = 'none';
    if (countBadge) countBadge.textContent = entries.length + ' 位书记';
    entries.sort((a, b) => b[1] - a[1]);
    
    const colors = ['coral', 'blue', 'green', 'purple', 'orange', 'teal'];
    const totalStaff = entries.reduce((sum, e) => sum + e[1], 0);
    
    grid.innerHTML = entries.map((entry, index) => {
      const [secretary, count] = entry;
      const color = colors[index % colors.length];
      const percentage = totalStaff > 0 ? Math.round((count / totalStaff) * 100) : 0;
      
      // 获取该书记的工资录入进度（如果有的话）
      const progress = salaryProgress && salaryProgress[secretary] ? salaryProgress[secretary] : null;
      const enteredCount = progress ? progress.entered : 0;
      const progressPercent = progress ? Math.round((enteredCount / count) * 100) : 0;
      const progressColor = progressPercent >= 100 ? '#10B981' : progressPercent > 0 ? '#F59E0B' : '#EF4444';
      
      return `
        <div class="stat-card ${color}" style="padding: 16px; cursor: pointer; transition: all 0.2s; position: relative;" 
             onclick="App.showSecretaryDetail('${escapeHtml(secretary)}', ${count})"
             onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';"
             onmouseout="this.style.transform=''; this.style.boxShadow='';">
          <div class="stat-card-inner" style="gap: 12px; flex-direction: column; align-items: flex-start;">
            <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
              <div class="stat-icon" style="width: 40px; height: 40px; font-size: 18px;">👤</div>
              <div style="flex: 1;">
                <div class="stat-value" style="font-size: 28px; font-weight: 700;">${count}</div>
                <div class="stat-label" style="font-size: 13px; opacity: 0.9;">${escapeHtml(secretary)}</div>
              </div>
            </div>
            <div style="width: 100%; margin-top: 8px;">
              <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; opacity: 0.8;">
                <span>占比 ${percentage}%</span>
                <span>点击查看 →</span>
              </div>
              <div style="background: rgba(255,255,255,0.3); border-radius: 4px; height: 6px; overflow: hidden;">
                <div style="background: rgba(255,255,255,0.8); height: 100%; width: ${percentage}%; transition: width 0.5s;"></div>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }
  
  function showSecretaryDetail(secretaryName, staffCount) {
    _currentSecretaryName = secretaryName;
    
    const title = document.getElementById('secretary-detail-title');
    const content = document.getElementById('secretary-detail-content');
    
    if (title) title.textContent = '👤 ' + secretaryName + ' 的员工统计';
    
    if (content) {
      content.innerHTML = `
        <div style="text-align: center; padding: 20px;">
          <div class="loading-spinner"></div>
          <p style="margin-top: 10px; color: #666;">加载中...</p>
        </div>
      `;
    }
    
    showModal('secretary-detail-modal');
    
    // 加载该书记的详细数据
    loadSecretaryDetailData(secretaryName);
  }
  
  function loadSecretaryDetailData(secretaryName) {
    google.script.run
      .withSuccessHandler(function(result) {
        renderSecretaryDetailContent(secretaryName, result);
      })
      .withFailureHandler(function(e) {
        const content = document.getElementById('secretary-detail-content');
        if (content) {
          content.innerHTML = '<div style="color: #EF4444; text-align: center; padding: 20px;">加载失败: ' + e.message + '</div>';
        }
      })
      .getSecretaryStats(_currentUser, secretaryName);
  }
  
  function renderSecretaryDetailContent(secretaryName, data) {
    const content = document.getElementById('secretary-detail-content');
    if (!content) return;
    
    const staffList = data.staffList || [];
    const stats = data.stats || {};
    const currentMonth = data.currentMonth || '';
    
    const activeStaff = staffList.filter(s => s.status !== 'LEFT');
    const leftStaff = staffList.filter(s => s.status === 'LEFT');
    const totalSalary = activeStaff.reduce((sum, s) => sum + (Number(s.salary) || 0), 0);
    const withDebt = activeStaff.filter(s => (Number(s.debtRemaining) || 0) > 0);
    const enteredCount = stats.enteredCount || 0;
    const progressPercent = activeStaff.length > 0 ? Math.round((enteredCount / activeStaff.length) * 100) : 0;
    
    content.innerHTML = `
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; border-radius: 12px; text-align: center;">
          <div style="font-size: 28px; font-weight: 700;">${activeStaff.length}</div>
          <div style="font-size: 12px; opacity: 0.9;">在职员工</div>
        </div>
        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 16px; border-radius: 12px; text-align: center;">
          <div style="font-size: 28px; font-weight: 700;">RM ${totalSalary.toLocaleString()}</div>
          <div style="font-size: 12px; opacity: 0.9;">月薪总额</div>
        </div>
        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 16px; border-radius: 12px; text-align: center;">
          <div style="font-size: 28px; font-weight: 700;">${progressPercent}%</div>
          <div style="font-size: 12px; opacity: 0.9;">${currentMonth} 录入进度</div>
        </div>
        <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 16px; border-radius: 12px; text-align: center;">
          <div style="font-size: 28px; font-weight: 700;">${withDebt.length}</div>
          <div style="font-size: 12px; opacity: 0.9;">有欠款</div>
        </div>
      </div>
      
      <div style="background: #F3F4F6; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <span style="font-weight: 600; color: #374151;">📅 ${currentMonth || '本月'} 工资录入进度</span>
          <span style="color: ${progressPercent >= 100 ? '#10B981' : progressPercent > 0 ? '#F59E0B' : '#EF4444'}; font-weight: 600;">
            ${enteredCount} / ${activeStaff.length} 人
          </span>
        </div>
        <div style="background: #E5E7EB; border-radius: 8px; height: 12px; overflow: hidden;">
          <div style="background: ${progressPercent >= 100 ? '#10B981' : progressPercent > 0 ? '#F59E0B' : '#EF4444'}; height: 100%; width: ${progressPercent}%; transition: width 0.5s; border-radius: 8px;"></div>
        </div>
        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: #6B7280;">
          <span>已录入 ${enteredCount} 人</span>
          <span>未录入 ${activeStaff.length - enteredCount} 人</span>
        </div>
      </div>
      
      <div style="margin-top: 16px;">
        <h4 style="margin: 0 0 12px 0; color: #374151; font-size: 14px;">👥 员工列表 (${staffList.length})</h4>
        <div style="max-height: 250px; overflow-y: auto; border: 1px solid #E5E7EB; border-radius: 8px;">
          <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <thead style="background: #F9FAFB; position: sticky; top: 0;">
              <tr>
                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #E5E7EB;">姓名</th>
                <th style="padding: 10px; text-align: left; border-bottom: 1px solid #E5E7EB;">公司</th>
                <th style="padding: 10px; text-align: right; border-bottom: 1px solid #E5E7EB;">月薪</th>
                <th style="padding: 10px; text-align: center; border-bottom: 1px solid #E5E7EB;">状态</th>
              </tr>
            </thead>
            <tbody>
              ${staffList.map(s => `
                <tr style="border-bottom: 1px solid #F3F4F6;">
                  <td style="padding: 10px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <div style="width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">
                        ${(s.staffName || '?').charAt(0).toUpperCase()}
                      </div>
                      <span style="font-weight: 500;">${escapeHtml(s.staffName || '-')}</span>
                    </div>
                  </td>
                  <td style="padding: 10px; color: #6B7280;">${escapeHtml(s.companyName || '-')}</td>
                  <td style="padding: 10px; text-align: right; font-weight: 500;">RM ${Number(s.salary || 0).toLocaleString()}</td>
                  <td style="padding: 10px; text-align: center;">
                    <span style="padding: 2px 8px; border-radius: 4px; font-size: 11px; background: ${s.status === 'LEFT' ? '#FEE2E2' : '#D1FAE5'}; color: ${s.status === 'LEFT' ? '#DC2626' : '#059669'};">
                      ${s.status === 'LEFT' ? '已离职' : '在职'}
                    </span>
                    ${Number(s.debtRemaining || 0) > 0 ? '<span style="margin-left: 4px; padding: 2px 6px; border-radius: 4px; font-size: 10px; background: #FEF3C7; color: #D97706;">欠款</span>' : ''}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }
  
  function closeSecretaryDetailModal() {
    closeModal('secretary-detail-modal');
  }
  
  function filterStaffBySecretary() {
    closeModal('secretary-detail-modal');
    // 跳转到员工页面并筛选该书记的员工
    navigateTo('staff');
    // 可以在这里添加筛选逻辑
    showToast('已跳转到员工列表', 'info');
  }

  // ========== 工资录入 ==========
  function updateSalaryPageForRole() {
    const user = _currentUser;
    const subtitle = document.getElementById('salary-page-subtitle');
    const label = document.getElementById('staff-type-label');
    
    if (user.role === 'ADMIN') {
      if (subtitle) subtitle.textContent = '录入主管月度工资';
      if (label) label.textContent = '主管';
      fillStaffSelect('salary-staff', _managerList);
    } else {
      if (subtitle) subtitle.textContent = '录入员工月度工资';
      if (label) label.textContent = '员工';
      fillStaffSelect('salary-staff', _employeeList);
    }
  }

  function autoFillSalaryDate() {
    const now = new Date();
    const month = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
    const date = now.toISOString().split('T')[0];
    
    const monthInput = document.getElementById('salary-month');
    const dateInput = document.getElementById('salary-date');
    if (monthInput && !monthInput.value) monthInput.value = month;
    if (dateInput && !dateInput.value) dateInput.value = date;
  }

  function onStaffSelect() {
    const name = document.getElementById('salary-staff').value;
    const list = _currentUser.role === 'ADMIN' ? _managerList : _employeeList;
    const staff = list.find(x => x.staffName === name);
    
    if (staff) {
      const basicInput = document.getElementById('salary-basic');
      if (basicInput && staff.salary) basicInput.value = staff.salary;
      showStaffInfoCard(staff);
      showCurrentDebtInfo(staff);
    } else {
      hideStaffInfoCard();
      hideCurrentDebtInfo();
    }
    
    // 重置扣款类型
    const noDeduction = document.querySelector('input[name="deduction-type"][value="none"]');
    if (noDeduction) noDeduction.checked = true;
    onDeductionTypeChange();
    previewSalary();
  }

  function showStaffInfoCard(staff) {
    const infoDiv = document.getElementById('staff-info-card');
    if (!infoDiv) return;
    
    const monthlyDed = Number(staff.monthlyDeduction) || 0;
    const debtRemaining = Number(staff.debtRemaining) || 0;
    const isManager = _currentUser.role === 'ADMIN'; // ADMIN录入主管，其他角色录入员工
    const staffType = isManager ? 'MANAGER' : 'STAFF';
    const isActive = (staff.status || staff.Status || '').toUpperCase() !== 'LEFT';
    const editFn = isManager ? 'editManager' : 'editStaff';
    const debtFn = isManager ? 'setManagerDebt' : 'setDebt';
    const leaveFn = isManager ? 'setManagerLeave' : 'setLeave';
    
    // 计算入职天数
    const daysFromJoin = calculateDaysFromJoin(staff.createdAt);
    const daysText = daysFromJoin !== null 
      ? (daysFromJoin === 0 ? '今天入职' : '入职 ' + daysFromJoin + ' 天')
      : '';
    
    let html = `
      <div style="border-bottom: 1px solid #E5E7EB; padding-bottom: 12px; margin-bottom: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div>
            <div style="font-size: 16px; font-weight: 700; color: #1F2937; display: flex; align-items: center; gap: 8px;">
              ${escapeHtml(staff.staffName)}
              ${isManager ? '<span style="font-size: 11px; background: #8B5CF6; color: white; padding: 2px 8px; border-radius: 4px;">主管</span>' : ''}
              ${!isActive ? '<span style="font-size: 11px; background: #9CA3AF; color: white; padding: 2px 8px; border-radius: 4px;">已离职</span>' : ''}
            </div>
            <div style="font-size: 13px; color: #6B7280; margin-top: 4px;">
              ${staff.companyName ? escapeHtml(staff.companyName) : ''}
              ${staff.companyName && daysText ? ' · ' : ''}
              ${daysText}
            </div>
          </div>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 16px;">
        <div style="background: #F0FDF4; padding: 12px; border-radius: 8px;">
          <div style="font-size: 12px; color: #6B7280; margin-bottom: 4px;">当前月薪</div>
          <div style="font-size: 18px; font-weight: 700; color: #059669;">RM ${Number(staff.salary || 0).toLocaleString()}</div>
        </div>
        <div style="background: #F3F4F6; padding: 12px; border-radius: 8px;">
          <div style="font-size: 12px; color: #6B7280; margin-bottom: 4px;">付款方式</div>
          <div style="font-size: 14px; font-weight: 600; color: #374151;">${staff.paymentMethod === 'CASH' ? '💵 现金' : '🏦 银行汇款'}</div>
        </div>
        ${staff.paymentMethod === 'BANK' && staff.bankType ? `
          <div style="background: #EFF6FF; padding: 12px; border-radius: 8px; grid-column: span 2;">
            <div style="font-size: 12px; color: #6B7280; margin-bottom: 4px;">银行信息</div>
            <div style="font-size: 13px; font-weight: 600; color: #1D4ED8;">${escapeHtml(staff.bankType)}</div>
            <div style="font-size: 12px; color: #374151; margin-top: 2px;">户名: ${escapeHtml(staff.bankHolder || '-')}</div>
            <div style="font-size: 12px; color: #6B7280;">账号: ${escapeHtml(staff.bankAccount || '-')}</div>
          </div>
        ` : ''}
        ${debtRemaining > 0 ? `
          <div style="background: #FEF3C7; padding: 12px; border-radius: 8px;">
            <div style="font-size: 12px; color: #92400E; margin-bottom: 4px;">💸 欠款余额</div>
            <div style="font-size: 16px; font-weight: 700; color: #B45309;">RM ${debtRemaining.toLocaleString()}</div>
            <div style="font-size: 11px; color: #92400E;">每月扣 RM ${monthlyDed.toLocaleString()}</div>
          </div>
        ` : ''}
      </div>
      
      ${staff.bankChanged ? `
        <div style="background: #FEE2E2; border: 1px solid #FECACA; border-radius: 8px; padding: 10px 12px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
          <span>⚠️</span>
          <span style="color: #991B1B; font-size: 13px; font-weight: 500;">银行资料近期有变更，请核实后再发放</span>
        </div>
      ` : ''}
      
      <div style="display: flex; gap: 8px; flex-wrap: wrap; padding-top: 12px; border-top: 1px solid #E5E7EB;">
        <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="App.${editFn}('${escapeHtml(staff.staffName)}')">
          ✏️ 编辑资料
        </button>
        <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;" onclick="App.${debtFn}('${escapeHtml(staff.staffName)}')">
          💸 设置欠款
        </button>
        <button class="btn btn-success" style="padding: 8px 16px; font-size: 13px;" onclick="App.showAdjustSalary('${escapeHtml(staff.staffName)}', '${staffType}')">
          📈 调薪
        </button>
        ${isActive ? `
          <button class="btn" style="padding: 8px 16px; font-size: 13px; background: #FEE2E2; color: #DC2626; border: 1px solid #FECACA;" onclick="App.${leaveFn}('${escapeHtml(staff.staffName)}')">
            🚪 办理离职
          </button>
        ` : ''}
      </div>
    `;
    
    infoDiv.innerHTML = html;
    infoDiv.className = 'info-box';
    infoDiv.style.display = 'block';
    infoDiv.style.background = 'white';
    infoDiv.style.border = '1px solid #E5E7EB';
    infoDiv.style.borderRadius = '12px';
    infoDiv.style.padding = '16px';
  }

  function hideStaffInfoCard() {
    const infoDiv = document.getElementById('staff-info-card');
    if (infoDiv) infoDiv.style.display = 'none';
  }

  function showCurrentDebtInfo(staff) {
    const debtDiv = document.getElementById('current-debt-info');
    if (!debtDiv) return;
    
    const monthlyDed = Number(staff.monthlyDeduction) || 0;
    const totalDebt = Number(staff.totalDebt) || 0;
    const debtPaid = Number(staff.debtPaid) || 0;
    const debtRemaining = totalDebt - debtPaid;
    
    if (monthlyDed === 0 && totalDebt === 0) {
      debtDiv.style.display = 'none';
      return;
    }
    
    const monthlyEl = document.getElementById('current-monthly-ded');
    const remainingEl = document.getElementById('current-debt-remaining');
    const progressEl = document.getElementById('current-debt-progress');
    const reasonEl = document.getElementById('current-debt-reason');
    
    if (monthlyEl) monthlyEl.textContent = 'RM ' + monthlyDed.toFixed(0);
    if (remainingEl) remainingEl.textContent = 'RM ' + debtRemaining.toFixed(0);
    if (progressEl) progressEl.textContent = 'RM ' + debtPaid.toFixed(0) + ' / RM ' + totalDebt.toFixed(0);
    if (reasonEl) reasonEl.textContent = staff.debtReason || '-';
    
    debtDiv.style.display = 'block';
  }

  function hideCurrentDebtInfo() {
    const debtDiv = document.getElementById('current-debt-info');
    if (debtDiv) debtDiv.style.display = 'none';
  }

  function onDeductionTypeChange() {
    const typeInput = document.querySelector('input[name="deduction-type"]:checked');
    const type = typeInput ? typeInput.value : 'none';
    
    // 更新手动扣款输入框状态
    const deductionInput = document.getElementById('salary-deduction');
    if (deductionInput) {
      if (type === 'none') {
        deductionInput.value = '0';
        deductionInput.disabled = true;
        deductionInput.style.background = '#F3F4F6';
      } else {
        deductionInput.disabled = false;
        deductionInput.style.background = '';
      }
    }
    
    previewSalary();
  }

  function previewSalary() {
    const staffName = document.getElementById('salary-staff').value;
    const month = document.getElementById('salary-month').value.trim();
    const list = _currentUser.role === 'ADMIN' ? _managerList : _employeeList;
    const staff = list.find(x => x.staffName === staffName);
    
    const previewDiv = document.getElementById('salary-preview');
    if (!staff || !month) {
      if (previewDiv) previewDiv.style.display = 'none';
      return;
    }
    
    const baseSalary = Number(staff.salary) || 0;
    const monthlyDed = Number(staff.monthlyDeduction) || 0;
    const debtRemaining = Number(staff.debtRemaining) || 0;
    const manualDeduction = Number(document.getElementById('salary-deduction').value) || 0;
    const lastMonthNet = Number(staff.lastMonthNet) || 0;
    
    let calculatedSalary = Number(document.getElementById('salary-basic').value) || baseSalary;
    let proRataText = '';
    let autoDeduction = 0;
    
    // 检查按比例计算（入职日期在当前月）
    const joinDate = staff.joinDate;
    if (joinDate && joinDate.startsWith(month)) {
      const dayOfMonth = parseInt(joinDate.split('-')[2], 10);
      const [year, mon] = month.split('-').map(Number);
      const daysInMonth = new Date(year, mon, 0).getDate();
      const workingDays = daysInMonth - dayOfMonth + 1;
      calculatedSalary = (baseSalary / daysInMonth) * workingDays;
      proRataText = `入职日 ${joinDate}，本月工作 ${workingDays}/${daysInMonth} 天`;
    }
    
    // 检查自动扣款
    if (monthlyDed > 0 && debtRemaining > 0) {
      autoDeduction = Math.min(monthlyDed, debtRemaining);
    }
    
    const netSalary = calculatedSalary - autoDeduction - manualDeduction;
    const totalDeduction = autoDeduction + manualDeduction;
    
    // 更新预览
    const previewSalaryEl = document.getElementById('preview-salary');
    const previewBasicEl = document.getElementById('preview-basic');
    const previewAutoEl = document.getElementById('preview-auto-ded');
    const previewManualEl = document.getElementById('preview-manual-ded');
    const previewNetEl = document.getElementById('preview-net');
    const deductionsDiv = document.getElementById('preview-deductions');
    const noDeductionDiv = document.getElementById('preview-no-deduction');
    const compareDiv = document.getElementById('preview-compare');
    const compareTextEl = document.getElementById('preview-compare-text');
    
    if (previewSalaryEl) previewSalaryEl.textContent = 'RM ' + baseSalary.toLocaleString();
    if (previewBasicEl) previewBasicEl.textContent = 'RM ' + calculatedSalary.toLocaleString();
    if (previewAutoEl) previewAutoEl.textContent = autoDeduction > 0 ? '-RM ' + autoDeduction.toLocaleString() : '-';
    if (previewManualEl) previewManualEl.textContent = manualDeduction > 0 ? '-RM ' + manualDeduction.toLocaleString() : '-';
    if (previewNetEl) previewNetEl.textContent = 'RM ' + netSalary.toLocaleString();
    
    // 显示/隐藏扣款明细
    if (deductionsDiv && noDeductionDiv) {
      if (totalDeduction > 0) {
        deductionsDiv.style.display = 'block';
        noDeductionDiv.style.display = 'none';
      } else {
        deductionsDiv.style.display = 'none';
        noDeductionDiv.style.display = 'flex';
      }
    }
    
    // 显示与上月对比
    if (compareDiv && compareTextEl && lastMonthNet > 0) {
      const diff = netSalary - lastMonthNet;
      if (diff === 0) {
        compareTextEl.innerHTML = '<span style="color: #6B7280;">同额</span>';
      } else if (diff > 0) {
        compareTextEl.innerHTML = `<span style="color: #059669;">+RM ${diff.toLocaleString()}</span>`;
      } else {
        compareTextEl.innerHTML = `<span style="color: #DC2626;">-RM ${Math.abs(diff).toLocaleString()}</span>`;
      }
      compareDiv.style.display = 'block';
    } else if (compareDiv) {
      compareDiv.style.display = 'none';
    }
    
    const proRataDiv = document.getElementById('preview-prorata');
    const proRataTextEl = document.getElementById('preview-prorata-text');
    if (proRataDiv && proRataTextEl) {
      if (proRataText) {
        proRataTextEl.textContent = proRataText;
        proRataDiv.style.display = 'flex';
      } else {
        proRataDiv.style.display = 'none';
      }
    }
    
    const debtDiv = document.getElementById('preview-debt');
    const debtTextEl = document.getElementById('preview-debt-text');
    if (debtDiv && debtTextEl) {
      if (autoDeduction > 0) {
        debtTextEl.textContent = `自动扣除 RM ${autoDeduction.toLocaleString()}，剩余欠款 RM ${(debtRemaining - autoDeduction).toLocaleString()}`;
        debtDiv.style.display = 'flex';
      } else {
        debtDiv.style.display = 'none';
      }
    }
    
    if (previewDiv) previewDiv.style.display = 'block';
  }

  function handleAddSalary() {
    if (!validateSalaryForm()) return;
    
    const month = document.getElementById('salary-month').value.trim();
    const date = document.getElementById('salary-date').value;
    const staffName = document.getElementById('salary-staff').value;
    const basic = Number(document.getElementById('salary-basic').value);
    const deduction = Number(document.getElementById('salary-deduction').value) || 0;
    const remark = document.getElementById('salary-remark').value.trim();
    const deductionTypeInput = document.querySelector('input[name="deduction-type"]:checked');
    const deductionType = deductionTypeInput ? deductionTypeInput.value : 'none';
    
    const list = _currentUser.role === 'ADMIN' ? _managerList : _employeeList;
    const staff = list.find(x => x.staffName === staffName);
    const isManager = _currentUser.role === 'ADMIN';
    
    // 计算自动扣款
    let autoDeduction = 0;
    if (staff) {
      const monthlyDed = Number(staff.monthlyDeduction) || 0;
      const debtRemaining = Number(staff.debtRemaining) || 0;
      if (monthlyDed > 0 && debtRemaining > 0) {
        autoDeduction = Math.min(monthlyDed, debtRemaining);
      }
    }
    
    const totalDeduction = deduction + autoDeduction;
    const netSalary = basic - totalDeduction;
    
    const record = {
      month: month,
      date: date,
      staffName: staffName,
      basicSalary: basic,
      deduction: deduction,
      autoDeduction: autoDeduction,
      netSalary: netSalary,
      remark: remark,
      isManager: isManager
    };
    
    setBtnLoading('btn-add-salary', true);
    google.script.run
      .withSuccessHandler(function(r) {
        setBtnLoading('btn-add-salary', false);
        if (!r.success) {
          showMessage('salary-message', r.message || '保存失败', 'error');
          return;
        }
        showToast('工资记录已保存为草稿', 'success');
        clearSalaryForm();
        loadStaffList(); // 刷新以更新欠款信息
      })
      .withFailureHandler(function(e) {
        setBtnLoading('btn-add-salary', false);
        showError(e, '保存工资');
      })
      .addSalaryRecord(_currentUser, record);
  }

  function handleBatchSalary() {
    const monthEl = document.getElementById('salary-month');
    const month = monthEl ? monthEl.value.trim() : '';
    
    if (!month || !/^\d{4}-\d{2}$/.test(month)) {
      showToast('请先填写正确的月份', 'error');
      return;
    }
    
    const list = _currentUser.role === 'ADMIN' ? _managerList : _employeeList;
    if (list.length === 0) {
      showToast('没有可录入的员工/主管', 'warning');
      return;
    }
    
    showConfirm({
      type: 'info',
      title: '一键批量录入',
      message: `将为 ${list.length} 位${_currentUser.role === 'ADMIN' ? '主管' : '员工'}创建 ${month} 的工资草稿，使用各自的月薪作为基本工资。`,
      okText: '开始录入',
      cancelText: '取消'
    }).then(function(confirmed) {
      if (!confirmed) return;
      
      setBtnLoading('btn-batch-salary', true);
      const isManager = _currentUser.role === 'ADMIN';
      
      google.script.run
        .withSuccessHandler(function(r) {
          setBtnLoading('btn-batch-salary', false);
          if (!r.success) {
            showToast(r.message || '批量录入失败', 'error');
            return;
          }
          showToast(`成功创建 ${r.count} 条草稿`, 'success');
          loadStaffList();
        })
        .withFailureHandler(function(e) {
          setBtnLoading('btn-batch-salary', false);
          showError(e, '批量录入');
        })
        .batchCreateSalaryDrafts(_currentUser, month, isManager);
    });
  }

  function clearSalaryForm() {
    const fields = ['salary-staff', 'salary-basic', 'salary-deduction', 'salary-remark',
                    'salary-basic', 'salary-deduction', 'salary-remark'];
    fields.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = id === 'salary-deduction' ? '0' : '';
    });
    
    const noDeduction = document.querySelector('input[name="deduction-type"][value="none"]');
    if (noDeduction) noDeduction.checked = true;
    onDeductionTypeChange();
    hideStaffInfoCard();
    hideCurrentDebtInfo();
    
    const previewDiv = document.getElementById('salary-preview');
    if (previewDiv) previewDiv.style.display = 'none';
  }

  // ========== 草稿管理 ==========
  function loadDrafts() {
    const monthEl = document.getElementById('draft-month');
    const month = monthEl ? monthEl.value.trim() || getCurrentMonth() : getCurrentMonth();
    const isManager = _currentUser.role === 'ADMIN';
    
    showLoading('加载草稿...');
    google.script.run
      .withSuccessHandler(function(r) {
        hideLoading();
        if (!r.success) {
          showToast(r.message || '加载失败', 'error');
          return;
        }
        _draftList = r.drafts || [];
        renderDrafts(_draftList);
        updateDraftBadge(_draftList.length);
      })
      .withFailureHandler(function(e) {
        hideLoading();
        showError(e, '加载草稿');
      })
      .getDrafts(_currentUser, month, isManager);
  }

  function renderDrafts(drafts) {
    const tbody = document.getElementById('drafts-tbody');
    const empty = document.getElementById('drafts-empty');
    
    if (!drafts || drafts.length === 0) {
      if (tbody) tbody.innerHTML = '';
      if (empty) empty.style.display = 'block';
      return;
    }
    
    if (empty) empty.style.display = 'none';
    if (tbody) {
      tbody.innerHTML = drafts.map(function(d, index) {
        const net = (Number(d.basicSalary) || 0) - (Number(d.deduction) || 0) - (Number(d.autoDeduction) || 0);
        const hasDeduction = (Number(d.deduction) || 0) > 0 || (Number(d.autoDeduction) || 0) > 0;
        const rowIndex = d.rowIndex || index;
        return `
          <tr data-row="${rowIndex}">
            <td><input type="checkbox" class="checkbox draft-checkbox" data-row="${rowIndex}"></td>
            <td><strong>${escapeHtml(d.staffName)}</strong></td>
            <td>${escapeHtml(d.month)}</td>
            <td class="td-mono">RM ${Number(d.basicSalary).toFixed(2)}</td>
            <td class="td-mono" style="color: ${hasDeduction ? 'var(--error)' : 'inherit'};">
              ${hasDeduction ? '- RM ' + ((Number(d.deduction) || 0) + (Number(d.autoDeduction) || 0)).toFixed(2) : '-'}
            </td>
            <td class="td-mono" style="color: #059669; font-weight: 600;">RM ${net.toFixed(2)}</td>
            <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(d.remark || '-')}</td>
            <td><span class="badge badge-draft">📝 草稿</span></td>
            <td>
              <button class="btn btn-ghost btn-xs" onclick="App.openEditDraft(${rowIndex})">✏️</button>
              <button class="btn btn-ghost btn-xs" onclick="App.deleteDraft(${rowIndex})" style="color: var(--error);">🗑️</button>
            </td>
          </tr>
        `;
      }).join('');
    }
  }

  function updateDraftBadge(count) {
    const badge = document.getElementById('draft-badge');
    if (badge) {
      badge.textContent = count;
      badge.style.display = count > 0 ? 'inline-flex' : 'none';
    }
  }

  function toggleDraftSelectAll() {
    const selectAll = document.getElementById('draft-select-all');
    if (!selectAll) return;
    document.querySelectorAll('.draft-checkbox').forEach(cb => cb.checked = selectAll.checked);
  }

  function openEditDraft(rowIndex) {
    const draft = _draftList.find(d => (d.rowIndex || 0) === rowIndex);
    if (!draft) {
      showToast('找不到该草稿', 'error');
      return;
    }
    
    const rowEl = document.getElementById('edit-row-index');
    const nameEl = document.getElementById('edit-salary-staff-name');
    const monthEl = document.getElementById('edit-month');
    const basicEl = document.getElementById('edit-basic-salary');
    const dedEl = document.getElementById('edit-deduction');
    const remarkEl = document.getElementById('edit-remark');
    const netEl = document.getElementById('edit-net-salary');
    
    if (rowEl) rowEl.value = rowIndex;
    if (nameEl) nameEl.value = draft.staffName;
    if (monthEl) monthEl.value = draft.month;
    if (basicEl) basicEl.value = draft.basicSalary;
    if (dedEl) dedEl.value = draft.deduction || 0;
    if (remarkEl) remarkEl.value = draft.remark || '';
    
    const net = (Number(draft.basicSalary) || 0) - (Number(draft.deduction) || 0);
    if (netEl) netEl.value = 'RM ' + net.toFixed(2);
    
    // 添加实时计算
    if (basicEl) basicEl.oninput = updateEditNetSalary;
    if (dedEl) dedEl.oninput = updateEditNetSalary;
    
    showModal('edit-draft-modal');
  }

  function updateEditNetSalary() {
    const basicEl = document.getElementById('edit-basic-salary');
    const dedEl = document.getElementById('edit-deduction');
    const netEl = document.getElementById('edit-net-salary');
    
    const basic = basicEl ? Number(basicEl.value) || 0 : 0;
    const deduction = dedEl ? Number(dedEl.value) || 0 : 0;
    const net = basic - deduction;
    if (netEl) netEl.value = 'RM ' + net.toFixed(2);
  }

  function closeEditModal() {
    closeModal('edit-draft-modal');
  }

  function saveDraftEdit() {
    const rowEl = document.getElementById('edit-row-index');
    const basicEl = document.getElementById('edit-basic-salary');
    const dedEl = document.getElementById('edit-deduction');
    const remarkEl = document.getElementById('edit-remark');
    
    const rowIndex = rowEl ? parseInt(rowEl.value, 10) : 0;
    const basic = basicEl ? Number(basicEl.value) : 0;
    const deduction = dedEl ? Number(dedEl.value) || 0 : 0;
    const remark = remarkEl ? remarkEl.value.trim() : '';
    
    if (!basic || basic < 0) {
      showToast('基本工资不合理', 'error');
      return;
    }
    
    const isManager = _currentUser.role === 'ADMIN';
    
    setBtnLoading('btn-save-draft', true);
    google.script.run
      .withSuccessHandler(function(r) {
        setBtnLoading('btn-save-draft', false);
        if (!r.success) {
          showToast(r.message || '保存失败', 'error');
          return;
        }
        showToast('草稿已更新', 'success');
        closeEditModal();
        loadDrafts();
      })
      .withFailureHandler(function(e) {
        setBtnLoading('btn-save-draft', false);
        showError(e, '保存草稿');
      })
      .updateDraft(_currentUser, rowIndex, basic, deduction, remark, isManager);
  }

  async function deleteDraft(rowIndex) {
    const confirmed = await showConfirm({
      type: 'danger',
      title: '删除草稿',
      message: '确定要删除这条草稿吗？此操作无法撤销。',
      okText: '删除',
      cancelText: '取消'
    });
    if (!confirmed) return;
    
    const isManager = _currentUser.role === 'ADMIN';
    
    showLoading('删除中...');
    google.script.run
      .withSuccessHandler(function(r) {
        hideLoading();
        if (!r.success) {
          showToast(r.message || '删除失败', 'error');
          return;
        }
        showToast('草稿已删除', 'success');
        loadDrafts();
      })
      .withFailureHandler(function(e) {
        hideLoading();
        showError(e, '删除草稿');
      })
      .deleteDraft(_currentUser, rowIndex, isManager);
  }

  async function deleteSelectedDrafts() {
    const selected = Array.from(document.querySelectorAll('.draft-checkbox:checked')).map(cb => parseInt(cb.dataset.row, 10));
    if (selected.length === 0) {
      showToast('请先选择要删除的草稿', 'warning');
      return;
    }
    
    const confirmed = await showConfirm({
      type: 'danger',
      title: '批量删除',
      message: `确定要删除选中的 ${selected.length} 条草稿吗？`,
      okText: '删除',
      cancelText: '取消'
    });
    if (!confirmed) return;
    
    const isManager = _currentUser.role === 'ADMIN';
    
    showLoading('删除中...');
    google.script.run
      .withSuccessHandler(function(r) {
        hideLoading();
        if (!r.success) {
          showToast(r.message || '删除失败', 'error');
          return;
        }
        showToast(`已删除 ${r.count} 条草稿`, 'success');
        loadDrafts();
      })
      .withFailureHandler(function(e) {
        hideLoading();
        showError(e, '批量删除');
      })
      .deleteMultipleDrafts(_currentUser, selected, isManager);
  }

  async function submitAllDrafts() {
    if (_draftList.length === 0) {
      showToast('没有可提交的草稿', 'warning');
      return;
    }
    
    const confirmed = await showConfirm({
      type: 'submit',
      title: '提交全部草稿',
      message: `确定要提交所有 ${_draftList.length} 条草稿吗？提交后会计可以看到并进行发放。`,
      okText: '提交',
      cancelText: '取消'
    });
    if (!confirmed) return;
    
    const monthEl = document.getElementById('draft-month');
    const month = monthEl ? monthEl.value.trim() || getCurrentMonth() : getCurrentMonth();
    const isManager = _currentUser.role === 'ADMIN';
    
    showLoading('提交中...');
    google.script.run
      .withSuccessHandler(function(r) {
        hideLoading();
        if (!r.success) {
          showToast(r.message || '提交失败', 'error');
          return;
        }
        showToast(`已提交 ${r.count} 条记录`, 'success');
        loadDrafts();
      })
      .withFailureHandler(function(e) {
        hideLoading();
        showError(e, '提交草稿');
      })
      .submitAllDrafts(_currentUser, month, isManager);
  }
  // ========== 员工出粮 ==========
  
  function loadEmployeePayments() {
    const monthEl = document.getElementById('emp-payment-month');
    const month = monthEl ? monthEl.value.trim() || getCurrentMonth() : getCurrentMonth();
    
    showLoading('加载待发工资...');
    
    // 所有角色都只加载员工数据
    google.script.run
      .withSuccessHandler(function(r) {
        hideLoading();
        if (!r.success) {
          showToast(r.message || '加载失败', 'error');
          return;
        }
        _employeePendingData = r.pending || [];
        initCompanyFilter(); // 初始化公司筛选
        renderEmployeePayments(_employeePendingData);
        updateEmployeeStats();
      })
      .withFailureHandler(function(e) {
        hideLoading();
        showError(e, '加载员工待发');
      })
      .getEmployeePending(_currentUser, month);
  }
  
  // 渲染单个工资卡片
  function renderSalaryCard(d, isManager) {
    const net = (Number(d.basicSalary) || 0) - (Number(d.deduction) || 0) - (Number(d.autoDeduction) || 0);
    const totalDed = (Number(d.deduction) || 0) + (Number(d.autoDeduction) || 0);
    const diff = d.lastMonthNet ? net - d.lastMonthNet : 0;
    const diffText = diff === 0 ? '同额' : (diff > 0 ? '+RM ' + diff.toFixed(0) : '-RM ' + Math.abs(diff).toFixed(0));
    const diffColor = diff > 0 ? '#059669' : (diff < 0 ? '#EF4444' : '#6B7280');
    const diffBg = diff > 0 ? '#D1FAE5' : (diff < 0 ? '#FEE2E2' : '#F3F4F6');
    
    const color = isManager 
      ? 'linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%)' 
      : getAvatarColor(d.staffName);
    
    // 构建扣款明细HTML
    let deductionHtml = '';
    if (totalDed > 0) {
      const details = [];
      if (Number(d.deduction) > 0) {
        details.push(`<div style="display: flex; justify-content: space-between;"><span>手动扣款</span><span style="color: #EF4444;">-RM ${Number(d.deduction).toFixed(0)}</span></div>`);
      }
      if (Number(d.autoDeduction) > 0) {
        details.push(`<div style="display: flex; justify-content: space-between;"><span>欠款扣除</span><span style="color: #EF4444;">-RM ${Number(d.autoDeduction).toFixed(0)}</span></div>`);
      }
      if (d.deductionReason) {
        details.push(`<div style="font-size: 11px; color: #6B7280; margin-top: 4px;">📝 ${escapeHtml(d.deductionReason)}</div>`);
      }
      if (d.debtReason) {
        details.push(`<div style="font-size: 11px; color: #6B7280;">💳 欠款原因: ${escapeHtml(d.debtReason)}</div>`);
      }
      
      deductionHtml = `
        <div style="background: #FEF2F2; border-radius: 8px; padding: 10px; margin-top: 10px;">
          <div style="font-size: 12px; color: #991B1B; font-weight: 600; margin-bottom: 6px;">📉 扣款明细</div>
          <div style="font-size: 12px; color: #374151;">
            ${details.join('')}
          </div>
        </div>
      `;
    }
    
    // 底部标签
    const footerLabel = isManager 
      ? `<div style="background: linear-gradient(135deg, #EDE9FE 0%, #DDD6FE 100%); padding: 6px 12px; border-radius: 6px; margin-top: 10px; display: flex; align-items: center; gap: 8px;">
          <span>👔</span>
          <span style="color: #7C3AED; font-size: 12px; font-weight: 600;">主管</span>
        </div>`
      : `<div style="background: #EDE9FE; padding: 6px 12px; border-radius: 6px; margin-top: 10px; display: flex; align-items: center; gap: 8px;">
          <span>📋</span>
          <span style="color: #7C3AED; font-size: 12px;">所属书记: <strong>${escapeHtml(d.secretary || d.createdBy || '-')}</strong></span>
        </div>`;
    
    // 快速发放按钮
    const quickPayBtn = d.paymentMethod === 'CASH' 
      ? `<button class="btn btn-purple btn-sm" onclick="App.quickMarkPaid(${d.rowIndex}, ${isManager}, 'CASH')" style="padding: 6px 12px; font-size: 12px;">💵 现金</button>`
      : `<button class="btn btn-success btn-sm" onclick="App.quickMarkPaid(${d.rowIndex}, ${isManager}, 'BANK')" style="padding: 6px 12px; font-size: 12px;">🏦 汇款</button>`;
    
    return `
      <div class="staff-card salary-card-item" data-row="${d.rowIndex}" data-manager="${isManager}" style="border: ${d.bankChanged ? '2px solid #F59E0B' : (isManager ? '2px solid #8B5CF6' : '1px solid #E5E7EB')}; position: relative;">
        <!-- 快速操作区 -->
        <div style="position: absolute; top: 12px; right: 12px; z-index: 10; display: flex; align-items: center; gap: 8px;">
          ${quickPayBtn}
          <label style="display: flex; align-items: center; justify-content: center; width: 24px; height: 24px; background: white; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;">
            <input type="checkbox" class="checkbox salary-card-checkbox" data-row="${d.rowIndex}" data-manager="${isManager}" data-amount="${d.netSalary || 0}" onchange="App.updateSelectedCount()">
          </label>
        </div>
        
        <div class="staff-card-header">
          <div class="staff-avatar" style="background: ${color};">
            ${(d.staffName || '?').charAt(0).toUpperCase()}
          </div>
          <div class="staff-info">
            <div class="staff-name">
              ${escapeHtml(d.staffName)}
              ${isManager ? '<span style="margin-left: 6px; font-size: 10px; background: #8B5CF6; color: white; padding: 2px 6px; border-radius: 4px;">主管</span>' : ''}
            </div>
            <div class="staff-company">${escapeHtml(d.companyName || d.secretary || '-')}</div>
          </div>
          <span class="badge" style="background: ${diffBg}; color: ${diffColor}; margin-right: 120px;">${diffText}</span>
        </div>
        
        <div class="staff-details">
          <div class="staff-info-row">
            <span class="staff-info-icon">💰</span>
            <div class="staff-info-content">
              <span class="staff-info-label">基本工资</span>
              <span class="staff-info-value">RM ${Number(d.basicSalary).toLocaleString()}</span>
            </div>
          </div>
          ${totalDed > 0 ? `
            <div class="staff-info-row">
              <span class="staff-info-icon">📉</span>
              <div class="staff-info-content">
                <span class="staff-info-label">总扣款</span>
                <span class="staff-info-value" style="color: #EF4444;">- RM ${totalDed.toLocaleString()}</span>
              </div>
            </div>
          ` : ''}
          <div class="staff-info-row">
            <span class="staff-info-icon">✅</span>
            <div class="staff-info-content">
              <span class="staff-info-label">实发工资</span>
              <span class="staff-info-value" style="color: #059669; font-weight: 700; font-size: 16px;">RM ${net.toLocaleString()}</span>
            </div>
          </div>
          <div class="staff-info-row">
            <span class="staff-info-icon">💳</span>
            <div class="staff-info-content">
              <span class="staff-info-label">付款方式</span>
              <span class="staff-info-value">${d.paymentMethod === 'CASH' ? '💵 现金' : '🏦 银行汇款'}</span>
            </div>
          </div>
        </div>
        
        ${d.paymentMethod === 'BANK' && d.bankType ? `
          <div class="staff-bank-info">
            <span class="staff-bank-icon">🏦</span>
            <div class="staff-bank-details">
              <div class="staff-bank-name">${escapeHtml(d.bankType)}</div>
              <div style="font-size: 12px; color: #374151;">户名: ${escapeHtml(d.bankHolder || '-')}</div>
              <div class="staff-bank-account">${escapeHtml(d.bankAccount || '-')}</div>
            </div>
            ${d.bankChanged ? '<span class="badge badge-warning">⚠️ 已变更</span>' : ''}
          </div>
        ` : ''}
        
        ${deductionHtml}
        
        ${footerLabel}
      </div>
    `;
  }

  function renderEmployeePayments(data) {
    const cardView = document.getElementById('emp-card-view');
    const empty = document.getElementById('emp-payments-empty');
    
    // 更新副标题
    const cardSubtitle = document.getElementById('emp-card-subtitle');
    if (cardSubtitle) cardSubtitle.textContent = `共 ${data.length} 人待发放`;
    
    // 显示批量操作栏
    const batchActions = document.getElementById('accountant-batch-actions');
    if (batchActions) batchActions.style.display = 'block';
    
    // 显示卡片视图
    if (cardView) cardView.style.display = 'grid';
    
    if (!data || data.length === 0) {
      if (cardView) cardView.innerHTML = '';
      if (empty) empty.style.display = 'block';
      return;
    }
    
    if (empty) empty.style.display = 'none';
    
    // 渲染员工卡片
    if (cardView) {
      cardView.innerHTML = data.map(d => renderSalaryCard(d, false)).join('');
    }
  }

  function updateEmployeeStats() {
    const data = _employeePendingData;
    
    let sameCount = 0, changeCount = 0, deductionCount = 0, bankCount = 0;
    let bankTotal = 0, cashTotal = 0;
    
    data.forEach(function(d) {
      const net = (Number(d.basicSalary) || 0) - (Number(d.deduction) || 0) - (Number(d.autoDeduction) || 0);
      const totalDed = (Number(d.deduction) || 0) + (Number(d.autoDeduction) || 0);
      const diff = d.lastMonthNet ? net - d.lastMonthNet : 0;
      
      if (diff === 0) sameCount++;
      else changeCount++;
      if (totalDed > 0) deductionCount++;
      if (d.bankChanged) bankCount++;
      
      if (d.paymentMethod === 'CASH') cashTotal += net;
      else bankTotal += net;
    });
    
    const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
    setEl('emp-all-count', data.length);
    setEl('emp-same-count', sameCount);
    setEl('emp-change-count', changeCount);
    setEl('emp-deduction-count', deductionCount);
    setEl('emp-bank-count', bankCount);
    setEl('emp-bank-amount', 'RM ' + bankTotal.toFixed(2));
    setEl('emp-cash-amount', 'RM ' + cashTotal.toFixed(2));
    setEl('emp-total-amount', 'RM ' + (bankTotal + cashTotal).toFixed(2));
  }

  function filterPayments(type) {
    // 如果有传入type参数且不是空字符串，更新筛选按钮样式
    if (type && type !== 'all') {
      document.querySelectorAll('#page-payments .filter-btn[data-filter]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === type);
      });
    } else if (type === 'all') {
      document.querySelectorAll('#page-payments .filter-btn[data-filter]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === 'all');
      });
    }
    
    // 获取当前活动的类型筛选
    const activeTypeBtn = document.querySelector('#page-payments .filter-btn[data-filter].active');
    const activeType = activeTypeBtn ? activeTypeBtn.dataset.filter : 'all';
    
    // 获取高级筛选条件
    const companyFilter = document.getElementById('emp-company-filter');
    const minFilter = document.getElementById('emp-amount-min');
    const maxFilter = document.getElementById('emp-amount-max');
    
    const selectedCompany = companyFilter ? companyFilter.value : '';
    const minAmount = minFilter ? (parseFloat(minFilter.value) || 0) : 0;
    const maxAmount = maxFilter ? (parseFloat(maxFilter.value) || Infinity) : Infinity;
    
    let filtered = _employeePendingData;
    
    // 类型筛选
    if (activeType === 'same') {
      filtered = filtered.filter(function(d) {
        const net = (Number(d.basicSalary) || 0) - (Number(d.deduction) || 0) - (Number(d.autoDeduction) || 0);
        return d.lastMonthNet && net === d.lastMonthNet;
      });
    } else if (activeType === 'change') {
      filtered = filtered.filter(function(d) {
        const net = (Number(d.basicSalary) || 0) - (Number(d.deduction) || 0) - (Number(d.autoDeduction) || 0);
        return !d.lastMonthNet || net !== d.lastMonthNet;
      });
    } else if (activeType === 'deduction') {
      filtered = filtered.filter(function(d) {
        return (Number(d.deduction) || 0) + (Number(d.autoDeduction) || 0) > 0;
      });
    } else if (activeType === 'bank') {
      filtered = filtered.filter(d => d.bankChanged);
    }
    
    // 公司筛选
    if (selectedCompany) {
      filtered = filtered.filter(d => (d.companyName || d.secretary || '') === selectedCompany);
    }
    
    // 金额范围筛选
    if (minAmount > 0 || maxAmount < Infinity) {
      filtered = filtered.filter(d => {
        const net = Number(d.netSalary) || 0;
        return net >= minAmount && net <= maxAmount;
      });
    }
    
    renderEmployeePayments(filtered);
  }
  
  // 初始化公司筛选下拉框
  function initCompanyFilter() {
    const companyFilter = document.getElementById('emp-company-filter');
    if (!companyFilter) return;
    
    // 收集所有公司
    const companies = new Set();
    _employeePendingData.forEach(d => {
      const company = d.companyName || d.secretary || '';
      if (company) companies.add(company);
    });
    
    // 填充下拉框
    companyFilter.innerHTML = '<option value="">🏢 全部公司</option>';
    Array.from(companies).sort().forEach(company => {
      const opt = document.createElement('option');
      opt.value = company;
      opt.textContent = company;
      companyFilter.appendChild(opt);
    });
  }

  function toggleSelectAll(prefix) {
    const selectAll = document.getElementById(prefix + '-select-all');
    if (!selectAll) return;
    document.querySelectorAll('.' + prefix + '-checkbox').forEach(cb => cb.checked = selectAll.checked);
  }

  // 会计：全选卡片
  // 员工出粮页面：全选卡片
  function toggleSelectAllCards() {
    const selectAll = document.getElementById('acc-select-all');
    if (!selectAll) return;
    document.querySelectorAll('#emp-card-view .salary-card-checkbox').forEach(cb => cb.checked = selectAll.checked);
    updateSelectedCount();
  }

  // 更新已选择数量（同时处理员工和主管页面）
  function updateSelectedCount() {
    // 员工出粮页面
    const empSelected = document.querySelectorAll('#emp-card-view .salary-card-checkbox:checked').length;
    const empCountEl = document.getElementById('acc-selected-count');
    if (empCountEl) empCountEl.textContent = empSelected;
    
    // 高亮员工卡片
    document.querySelectorAll('#emp-card-view .salary-card-item').forEach(card => {
      const checkbox = card.querySelector('.salary-card-checkbox');
      if (checkbox && checkbox.checked) {
        card.style.boxShadow = '0 0 0 3px #3B82F6';
      } else {
        card.style.boxShadow = '';
      }
    });
    
    // 主管出粮页面
    const mgrSelected = document.querySelectorAll('#mgr-card-view .salary-card-checkbox:checked').length;
    const mgrCountEl = document.getElementById('mgr-selected-count');
    if (mgrCountEl) mgrCountEl.textContent = mgrSelected;
    
    // 高亮主管卡片
    document.querySelectorAll('#mgr-card-view .salary-card-item').forEach(card => {
      const checkbox = card.querySelector('.salary-card-checkbox');
      if (checkbox && checkbox.checked) {
        card.style.boxShadow = '0 0 0 3px #8B5CF6';
      } else {
        card.style.boxShadow = '';
      }
    });
  }

  // 员工出粮页面：批量标记发放
  function markSelectedCardsPaid(method) {
    const checkboxes = document.querySelectorAll('#emp-card-view .salary-card-checkbox:checked');
    
    if (checkboxes.length === 0) {
      showToast('请先选择要发放的记录', 'warning');
      return;
    }
    
    // 分离员工和主管（会计页面可能同时有员工和主管）
    const empRows = [];
    const mgrRows = [];
    let totalAmount = 0;
    
    checkboxes.forEach(cb => {
      const rowIndex = parseInt(cb.dataset.row, 10);
      const isManager = cb.dataset.manager === 'true';
      const amount = parseFloat(cb.dataset.amount) || 0;
      totalAmount += amount;
      
      if (isManager) {
        mgrRows.push(rowIndex);
      } else {
        empRows.push(rowIndex);
      }
    });
    
    const totalCount = empRows.length + mgrRows.length;
    const empText = empRows.length > 0 ? `员工 ${empRows.length} 人` : '';
    const mgrText = mgrRows.length > 0 ? `主管 ${mgrRows.length} 人` : '';
    const summary = [empText, mgrText].filter(t => t).join(' + ');
    
    // 创建详细汇总信息
    const summaryHtml = `
      <div style="background: #F0FDF4; border-radius: 12px; padding: 16px; margin-top: 16px; text-align: left;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span style="color: #6B7280;">发放人数</span>
          <span style="font-weight: 600; color: #1F2937;">${totalCount} 人</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span style="color: #6B7280;">发放方式</span>
          <span style="font-weight: 600; color: ${method === 'BANK' ? '#059669' : '#8B5CF6'};">${method === 'BANK' ? '🏦 银行汇款' : '💵 现金'}</span>
        </div>
        <div style="border-top: 1px dashed #D1D5DB; margin: 12px 0;"></div>
        <div style="display: flex; justify-content: space-between;">
          <span style="color: #374151; font-weight: 600;">总金额</span>
          <span style="font-size: 20px; font-weight: 700; color: #059669;">RM ${totalAmount.toLocaleString()}</span>
        </div>
      </div>
    `;
    
    showConfirm({
      type: 'success',
      title: '确认批量发放',
      message: `确定要将 ${summary} 标记为已发放吗？` + summaryHtml,
      okText: '✓ 确认发放',
      cancelText: '取消'
    }).then(function(confirmed) {
      if (!confirmed) return;
      
      showLoading('批量处理中...');
      let completed = 0;
      let hasError = false;
      const totalCalls = (empRows.length > 0 ? 1 : 0) + (mgrRows.length > 0 ? 1 : 0);
      
      function checkComplete() {
        completed++;
        if (completed >= totalCalls) {
          hideLoading();
          if (!hasError) {
            showSuccessAnimation('发放成功！', `已成功处理 ${totalCount} 条记录，共 RM ${totalAmount.toLocaleString()}`);
          }
          loadEmployeePayments();
        }
      }
      
      // 标记员工
      if (empRows.length > 0) {
        google.script.run
          .withSuccessHandler(function(r) {
            if (!r.success) {
              hasError = true;
              showToast(r.message || '员工发放失败', 'error');
            }
            checkComplete();
          })
          .withFailureHandler(function(e) {
            hasError = true;
            showError(e, '员工批量发放');
            checkComplete();
          })
          .markMultiplePaid(_currentUser, 'employee', empRows, method);
      }
      
      // 标记主管
      if (mgrRows.length > 0) {
        google.script.run
          .withSuccessHandler(function(r) {
            if (!r.success) {
              hasError = true;
              showToast(r.message || '主管发放失败', 'error');
            }
            checkComplete();
          })
          .withFailureHandler(function(e) {
            hasError = true;
            showError(e, '主管批量发放');
            checkComplete();
          })
          .markMultiplePaid(_currentUser, 'manager', mgrRows, method);
      }
      
      // 如果没有任何调用
      if (totalCalls === 0) {
        hideLoading();
      }
    });
  }

  // 会计：单张卡片快速发放
  function quickMarkPaid(rowIndex, isManager, method) {
    const type = isManager ? 'manager' : 'employee';
    
    showConfirm({
      type: 'success',
      title: '确认发放',
      message: `确定要标记为已发放（${method === 'BANK' ? '银行汇款' : '现金'}）吗？`,
      okText: '确认',
      cancelText: '取消'
    }).then(function(confirmed) {
      if (!confirmed) return;
      
      showLoading('处理中...');
      google.script.run
        .withSuccessHandler(function(r) {
          hideLoading();
          if (!r.success) {
            showToast(r.message || '操作失败', 'error');
            return;
          }
          showToast('已标记发放', 'success');
          loadEmployeePayments();
        })
        .withFailureHandler(function(e) {
          hideLoading();
          showError(e, '标记发放');
        })
        .markPaid(_currentUser, type, rowIndex, method);
    });
  }

  function markPaid(type, rowIndex, method) {
    showConfirm({
      type: 'success',
      title: '确认发放',
      message: `确定要标记为已发放（${method === 'BANK' ? '银行汇款' : '现金'}）吗？`,
      okText: '确认',
      cancelText: '取消'
    }).then(function(confirmed) {
      if (!confirmed) return;
      
      showLoading('处理中...');
      google.script.run
        .withSuccessHandler(function(r) {
          hideLoading();
          if (!r.success) {
            showToast(r.message || '操作失败', 'error');
            return;
          }
          showToast('已标记发放', 'success');
          if (type === 'employee') loadEmployeePayments();
          else loadManagerPayments();
        })
        .withFailureHandler(function(e) {
          hideLoading();
          showError(e, '标记发放');
        })
        .markPaid(_currentUser, type, rowIndex, method);
    });
  }

  function markSelectedPaid(type, method) {
    const prefix = type === 'employee' ? 'emp' : 'mgr';
    const selected = Array.from(document.querySelectorAll('.' + prefix + '-checkbox:checked')).map(cb => parseInt(cb.dataset.row, 10));
    
    if (selected.length === 0) {
      showToast('请先选择要发放的记录', 'warning');
      return;
    }
    
    showConfirm({
      type: 'success',
      title: '批量发放',
      message: `确定要将选中的 ${selected.length} 条记录标记为已发放（${method === 'BANK' ? '银行汇款' : '现金'}）吗？`,
      okText: '确认',
      cancelText: '取消'
    }).then(function(confirmed) {
      if (!confirmed) return;
      
      showLoading('处理中...');
      google.script.run
        .withSuccessHandler(function(r) {
          hideLoading();
          if (!r.success) {
            showToast(r.message || '操作失败', 'error');
            return;
          }
          showToast(`已标记 ${r.count} 条为已发放`, 'success');
          if (type === 'employee') loadEmployeePayments();
          else loadManagerPayments();
        })
        .withFailureHandler(function(e) {
          hideLoading();
          showError(e, '批量发放');
        })
        .markMultiplePaid(_currentUser, type, selected, method);
    });
  }

  // ========== 主管出粮 ==========
  function loadManagerPayments() {
    const monthEl = document.getElementById('mgr-payment-month');
    const month = monthEl ? monthEl.value.trim() || getCurrentMonth() : getCurrentMonth();
    
    showLoading('加载主管待发...');
    google.script.run
      .withSuccessHandler(function(r) {
        hideLoading();
        if (!r.success) {
          showToast(r.message || '加载失败', 'error');
          return;
        }
        _managerPendingData = r.pending || [];
        renderManagerPayments(_managerPendingData);
      })
      .withFailureHandler(function(e) {
        hideLoading();
        showError(e, '加载主管待发');
      })
      .getManagerPending(_currentUser, month);
  }

  function renderManagerPayments(data) {
    const cardView = document.getElementById('mgr-card-view');
    const empty = document.getElementById('mgr-payments-empty');
    const cardSubtitle = document.getElementById('mgr-card-subtitle');
    
    if (cardSubtitle) cardSubtitle.textContent = `共 ${data.length} 人待发放`;
    
    if (!data || data.length === 0) {
      if (cardView) cardView.innerHTML = '';
      if (empty) empty.style.display = 'block';
      return;
    }
    
    if (empty) empty.style.display = 'none';
    
    // 渲染卡片视图
    if (cardView) {
      cardView.innerHTML = data.map(d => renderSalaryCard(d, true)).join('');
    }
  }

  // 主管卡片全选
  function toggleSelectAllMgrCards() {
    const selectAll = document.getElementById('mgr-select-all-cards');
    if (!selectAll) return;
    document.querySelectorAll('#mgr-card-view .salary-card-checkbox').forEach(cb => cb.checked = selectAll.checked);
    updateMgrSelectedCount();
  }

  // 主管卡片更新已选择数量
  function updateMgrSelectedCount() {
    const selected = document.querySelectorAll('#mgr-card-view .salary-card-checkbox:checked').length;
    const countEl = document.getElementById('mgr-selected-count');
    if (countEl) countEl.textContent = selected;
    
    // 高亮已选中的卡片
    document.querySelectorAll('#mgr-card-view .salary-card-item').forEach(card => {
      const checkbox = card.querySelector('.salary-card-checkbox');
      if (checkbox && checkbox.checked) {
        card.style.boxShadow = '0 0 0 3px #8B5CF6';
      } else {
        card.style.boxShadow = '';
      }
    });
  }

  // 主管卡片批量标记发放
  function markSelectedMgrCardsPaid(method) {
    const checkboxes = document.querySelectorAll('#mgr-card-view .salary-card-checkbox:checked');
    
    if (checkboxes.length === 0) {
      showToast('请先选择要发放的记录', 'warning');
      return;
    }
    
    const rows = [];
    let totalAmount = 0;
    
    checkboxes.forEach(cb => {
      rows.push(parseInt(cb.dataset.row, 10));
      totalAmount += parseFloat(cb.dataset.amount) || 0;
    });
    
    // 创建详细汇总信息
    const summaryHtml = `
      <div style="background: #F5F3FF; border-radius: 12px; padding: 16px; margin-top: 16px; text-align: left;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span style="color: #6B7280;">发放人数</span>
          <span style="font-weight: 600; color: #1F2937;">${rows.length} 位主管</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span style="color: #6B7280;">发放方式</span>
          <span style="font-weight: 600; color: ${method === 'BANK' ? '#059669' : '#8B5CF6'};">${method === 'BANK' ? '🏦 银行汇款' : '💵 现金'}</span>
        </div>
        <div style="border-top: 1px dashed #D1D5DB; margin: 12px 0;"></div>
        <div style="display: flex; justify-content: space-between;">
          <span style="color: #374151; font-weight: 600;">总金额</span>
          <span style="font-size: 20px; font-weight: 700; color: #8B5CF6;">RM ${totalAmount.toLocaleString()}</span>
        </div>
      </div>
    `;
    
    showConfirm({
      type: 'success',
      title: '确认批量发放',
      message: `确定要将 ${rows.length} 位主管标记为已发放吗？` + summaryHtml,
      okText: '✓ 确认发放',
      cancelText: '取消'
    }).then(function(confirmed) {
      if (!confirmed) return;
      
      showLoading('批量处理中...');
      google.script.run
        .withSuccessHandler(function(r) {
          hideLoading();
          if (!r.success) {
            showToast(r.message || '发放失败', 'error');
            return;
          }
          showSuccessAnimation('发放成功！', `已成功处理 ${rows.length} 位主管，共 RM ${totalAmount.toLocaleString()}`);
          loadManagerPayments();
        })
        .withFailureHandler(function(e) {
          hideLoading();
          showError(e, '批量发放');
        })
        .markMultiplePaid(_currentUser, 'manager', rows, method);
    });
  }

  // ========== 员工管理页面 ==========
  function loadStaffPage() {
    renderStaffList();
    updateStaffStats();
  }

  function renderStaffList() {
    const container = document.getElementById('staff-grid');
    const empty = document.getElementById('staff-empty');
    const emptyText = document.getElementById('staff-empty-text');
    const search = document.getElementById('staff-search');
    const searchTerm = search ? search.value.toLowerCase() : '';
    
    let list = _staffList || [];
    
    // 过滤
    if (_staffFilter === 'active') {
      list = list.filter(s => (s.status || s.Status || '') !== 'LEFT');
    } else if (_staffFilter === 'left') {
      list = list.filter(s => (s.status || s.Status || '') === 'LEFT');
    } else if (_staffFilter === 'debt') {
      list = list.filter(s => (Number(s.debtRemaining) || 0) > 0);
    }
    
    // 搜索
    if (searchTerm) {
      list = list.filter(s => 
        (s.staffName || '').toLowerCase().includes(searchTerm) ||
        (s.companyName || '').toLowerCase().includes(searchTerm)
      );
    }
    
    if (!container) return;
    
    // 排序
    list = list.slice().sort((a, b) => {
      let valA, valB;
      switch (_staffSortBy) {
        case 'salary':
          valA = Number(a.salary) || 0;
          valB = Number(b.salary) || 0;
          break;
        case 'date':
          valA = new Date(a.createdAt || 0).getTime();
          valB = new Date(b.createdAt || 0).getTime();
          break;
        default: // name
          valA = (a.staffName || '').toLowerCase();
          valB = (b.staffName || '').toLowerCase();
      }
      if (valA < valB) return _staffSortOrder === 'asc' ? -1 : 1;
      if (valA > valB) return _staffSortOrder === 'asc' ? 1 : -1;
      return 0;
    });
    
    // 分页
    const totalPages = Math.ceil(list.length / _pageSize);
    if (_staffCurrentPage > totalPages) _staffCurrentPage = totalPages || 1;
    const startIndex = (_staffCurrentPage - 1) * _pageSize;
    const paginatedList = list.slice(startIndex, startIndex + _pageSize);
    
    if (list.length === 0) {
      container.innerHTML = '';
      if (empty) {
        empty.style.display = 'block';
        if (emptyText) emptyText.textContent = searchTerm ? '没有找到匹配的员工' : '暂无员工数据';
      }
      renderPagination('staff-pagination', 1, 1, 'setStaffPage');
      return;
    }
    
    if (empty) empty.style.display = 'none';
    
    container.innerHTML = paginatedList.map(function(staff) {
      const isActive = (staff.status || staff.Status || '') !== 'LEFT';
      const color = getAvatarColor(staff.staffName);
      const daysFromJoin = calculateDaysFromJoin(staff.createdAt);
      const daysBadge = daysFromJoin !== null ? 
        `<span class="days-badge ${daysFromJoin <= 30 ? 'new' : ''}">${daysFromJoin === 0 ? '今天入职' : '入职' + daysFromJoin + '天'}</span>` : '';
      
      return `
        <div class="staff-card">
          <div class="staff-card-header">
            <div class="staff-avatar ${color}">${(staff.staffName || '?').charAt(0).toUpperCase()}</div>
            <div style="flex: 1;">
              <div class="staff-name">${escapeHtml(staff.staffName)} ${daysBadge}</div>
              <div class="staff-company">${escapeHtml(staff.companyName || '-')}</div>
            </div>
            <span class="badge ${isActive ? 'badge-active' : 'badge-left'}">${isActive ? '✓ 在职' : '已离职'}</span>
          </div>
          <div class="staff-card-info">
            <div class="staff-info-item">
              <span class="staff-info-icon">💰</span>
              <div class="staff-info-content">
                <span class="staff-info-label">月薪</span>
                <span class="staff-info-value">RM ${Number(staff.salary || 0).toLocaleString()}</span>
              </div>
            </div>
            <div class="staff-info-item">
              <span class="staff-info-icon">💳</span>
              <div class="staff-info-content">
                <span class="staff-info-label">付款方式</span>
                <span class="staff-info-value">${staff.paymentMethod === 'CASH' ? '现金' : '银行汇款'}</span>
              </div>
            </div>
          </div>
          ${staff.paymentMethod === 'BANK' && staff.bankType ? `
            <div class="staff-bank-info">
              <span class="staff-bank-icon">🏦</span>
              <div class="staff-bank-details">
                <div class="staff-bank-name">${escapeHtml(staff.bankType)}</div>
                <div style="font-size: 12px; color: #374151;">户名: ${escapeHtml(staff.bankHolder || '-')}</div>
                <div class="staff-bank-account">账号: ${escapeHtml(staff.bankAccount || '-')}</div>
              </div>
              ${staff.bankChanged ? '<span class="badge badge-error">⚠️</span>' : ''}
            </div>
          ` : ''}
          ${Number(staff.debtRemaining || 0) > 0 ? `
            <div class="staff-debt-info" style="background: #FEF3C7; padding: 8px 12px; border-radius: 6px; margin-top: 8px; display: flex; align-items: center; gap: 8px;">
              <span>💸</span>
              <span style="color: #92400E; font-size: 13px;">欠款: <strong>RM ${Number(staff.debtRemaining).toLocaleString()}</strong> (月扣 RM ${Number(staff.monthlyDeduction || 0).toLocaleString()})</span>
            </div>
          ` : ''}
        </div>
      `;
    }).join('');
    
    // 渲染分页
    renderPagination('staff-pagination', _staffCurrentPage, totalPages, 'setStaffPage');
  }

  function updateStaffStats() {
    const active = _staffList.filter(s => (s.status || s.Status || '') !== 'LEFT');
    const left = _staffList.filter(s => (s.status || s.Status || '') === 'LEFT');
    const totalSalary = active.reduce((sum, s) => sum + (Number(s.salary) || 0), 0);
    const withDebt = _staffList.filter(s => (Number(s.debtRemaining) || 0) > 0);
    
    // 使用数字滚动动画
    animateNumber('staff-total-count', active.length);
    animateNumber('staff-salary-total', totalSalary, 'RM ');
    animateNumber('staff-debt-count', withDebt.length);
    animateNumber('staff-left-count', left.length);
    
    // 筛选按钮计数（不需要动画）
    const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
    setEl('filter-all-count', _staffList.length);
    setEl('filter-active-count', active.length);
    setEl('filter-left-count', left.length);
    setEl('filter-debt-count', withDebt.length);
  }

  function filterStaffList() {
    renderStaffList();
  }

  function setStaffFilter(filter) {
    _staffFilter = filter;
    document.querySelectorAll('#page-staff .filter-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.filter === filter);
    });
    renderStaffList();
  }

  function showAddStaffModal() {
    // 清空表单
    ['new-staff-name', 'new-staff-company', 'new-staff-salary', 'new-staff-joindate', 
     'new-staff-bankholder', 'new-staff-banktype', 'new-staff-bankaccount'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
    const paymentEl = document.getElementById('new-staff-payment');
    if (paymentEl) paymentEl.value = 'BANK';
    
    showModal('add-staff-modal');
  }

  function saveNewStaff() {
    if (!validateStaffForm()) return;
    
    const data = {
      staffName: document.getElementById('new-staff-name').value.trim(),
      companyName: document.getElementById('new-staff-company').value.trim(),
      salary: Number(document.getElementById('new-staff-salary').value) || 0,
      joinDate: document.getElementById('new-staff-joindate').value,
      paymentMethod: document.getElementById('new-staff-payment').value,
      bankHolder: document.getElementById('new-staff-bankholder').value.trim(),
      bankType: document.getElementById('new-staff-banktype').value.trim(),
      bankAccount: document.getElementById('new-staff-bankaccount').value.trim(),
      status: 'ACTIVE',
      isManager: false
    };
    
    setBtnLoading('btn-save-staff', true);
    google.script.run
      .withSuccessHandler(function(r) {
        setBtnLoading('btn-save-staff', false);
        if (!r.success) {
          showToast(r.message || '添加失败', 'error');
          return;
        }
        showToast('员工添加成功', 'success');
        closeModal('add-staff-modal');
        loadStaffList();
        setTimeout(loadStaffPage, 500);
      })
      .withFailureHandler(function(e) {
        setBtnLoading('btn-save-staff', false);
        showError(e, '添加员工');
      })
      .addStaff(_currentUser, data);
  }

  function showAddManagerModal() {
    // 清空表单
    ['new-manager-name', 'new-manager-company', 'new-manager-salary', 'new-manager-joindate', 
     'new-manager-bankholder', 'new-manager-banktype', 'new-manager-bankaccount'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
    const paymentEl = document.getElementById('new-manager-payment');
    if (paymentEl) paymentEl.value = 'BANK';
    
    showModal('add-manager-modal');
  }

  function saveNewManager() {
    const nameEl = document.getElementById('new-manager-name');
    if (!nameEl || !nameEl.value.trim()) {
      showToast('请输入主管姓名', 'error');
      return;
    }
    
    const data = {
      staffName: document.getElementById('new-manager-name').value.trim(),
      companyName: document.getElementById('new-manager-company').value.trim(),
      salary: Number(document.getElementById('new-manager-salary').value) || 0,
      joinDate: document.getElementById('new-manager-joindate').value,
      paymentMethod: document.getElementById('new-manager-payment').value,
      bankHolder: document.getElementById('new-manager-bankholder').value.trim(),
      bankType: document.getElementById('new-manager-banktype').value.trim(),
      bankAccount: document.getElementById('new-manager-bankaccount').value.trim(),
      status: 'ACTIVE',
      isManager: true
    };
    
    setBtnLoading('btn-save-manager', true);
    google.script.run
      .withSuccessHandler(function(r) {
        setBtnLoading('btn-save-manager', false);
        if (!r.success) {
          showToast(r.message || '添加失败', 'error');
          return;
        }
        showToast('主管添加成功', 'success');
        closeModal('add-manager-modal');
        loadManagersPage();
      })
      .withFailureHandler(function(e) {
        setBtnLoading('btn-save-manager', false);
        showError(e, '添加主管');
      })
      .addManager(_currentUser, data);
  }

  function editStaff(name) {
    // 从员工列表中找到该员工的信息
    const staff = _staffList.find(s => s.staffName === name);
    if (!staff) {
      showToast('找不到员工信息', 'error');
      return;
    }
    
    // 填充表单
    document.getElementById('edit-staff-original-name').value = name;
    document.getElementById('edit-staff-name').value = staff.staffName || '';
    document.getElementById('edit-staff-company').value = staff.companyName || '';
    document.getElementById('edit-staff-salary').value = staff.salary || '';
    document.getElementById('edit-staff-payment').value = staff.paymentMethod || 'BANK';
    document.getElementById('edit-staff-bankholder').value = staff.bankHolder || '';
    document.getElementById('edit-staff-banktype').value = staff.bankType || '';
    document.getElementById('edit-staff-bankaccount').value = staff.bankAccount || '';
    
    showModal('edit-staff-modal');
  }
  
  function saveStaffEdit() {
    const originalName = document.getElementById('edit-staff-original-name').value;
    if (!originalName) {
      showToast('员工信息错误', 'error');
      return;
    }
    
    const updates = {
      companyName: document.getElementById('edit-staff-company').value.trim(),
      salary: Number(document.getElementById('edit-staff-salary').value) || 0,
      paymentMethod: document.getElementById('edit-staff-payment').value,
      bankHolder: document.getElementById('edit-staff-bankholder').value.trim(),
      bankType: document.getElementById('edit-staff-banktype').value.trim(),
      bankAccount: document.getElementById('edit-staff-bankaccount').value.trim()
    };
    
    setBtnLoading('btn-update-staff', true);
    google.script.run
      .withSuccessHandler(function(r) {
        setBtnLoading('btn-update-staff', false);
        if (!r.success) {
          showToast(r.message || '更新失败', 'error');
          return;
        }
        showToast('员工信息已更新', 'success');
        if (r.changeNote) {
          showToast('银行变更已记录', 'info');
        }
        closeModal('edit-staff-modal');
        loadStaffList();
        setTimeout(loadStaffPage, 500);
      })
      .withFailureHandler(function(e) {
        setBtnLoading('btn-update-staff', false);
        showError(e, '更新员工');
      })
      .updateStaffInfo(_currentUser, originalName, updates);
  }

  function setDebt(name) {
    // 从员工列表中找到该员工的信息
    const staff = _staffList.find(s => s.staffName === name);
    if (!staff) {
      showToast('找不到员工信息', 'error');
      return;
    }
    
    // 填充表单
    document.getElementById('debt-staff-name').value = name;
    document.getElementById('debt-staff-type').value = 'STAFF';
    document.getElementById('debt-display-name').textContent = name;
    document.getElementById('debt-current-total').textContent = Number(staff.totalDebt || 0).toLocaleString();
    document.getElementById('debt-current-paid').textContent = Number(staff.debtPaid || 0).toLocaleString();
    document.getElementById('debt-current-remaining').textContent = Number(staff.debtRemaining || 0).toLocaleString();
    
    document.getElementById('debt-total').value = staff.totalDebt || '';
    document.getElementById('debt-monthly').value = staff.monthlyDeduction || '';
    document.getElementById('debt-reason').value = staff.debtReason || '';
    document.getElementById('debt-reset-paid').checked = false;
    
    // 添加预览计算
    updateDebtPreview();
    
    showModal('set-debt-modal');
  }
  
  function updateDebtPreview() {
    const total = Number(document.getElementById('debt-total').value) || 0;
    const monthly = Number(document.getElementById('debt-monthly').value) || 0;
    const resetPaid = document.getElementById('debt-reset-paid').checked;
    const currentPaid = resetPaid ? 0 : Number(document.getElementById('debt-current-paid').textContent.replace(/,/g, '')) || 0;
    
    const preview = document.getElementById('debt-preview');
    const previewText = document.getElementById('debt-preview-text');
    
    if (total > 0 && monthly > 0) {
      const remaining = total - currentPaid;
      const months = Math.ceil(remaining / monthly);
      preview.style.display = 'block';
      previewText.innerHTML = `
        剩余欠款 <strong>RM ${remaining.toLocaleString()}</strong>，
        每月扣款 <strong>RM ${monthly.toLocaleString()}</strong>，
        预计 <strong>${months} 个月</strong> 还清
      `;
    } else if (total === 0) {
      preview.style.display = 'block';
      previewText.innerHTML = '欠款已清零，将不会自动扣款';
    } else {
      preview.style.display = 'none';
    }
  }
  
  function saveDebtSettings() {
    const staffName = document.getElementById('debt-staff-name').value;
    const staffType = document.getElementById('debt-staff-type').value;
    
    if (!staffName) {
      showToast('员工信息错误', 'error');
      return;
    }
    
    const totalDebt = Number(document.getElementById('debt-total').value) || 0;
    const monthlyDeduction = Number(document.getElementById('debt-monthly').value) || 0;
    const debtReason = document.getElementById('debt-reason').value.trim();
    const resetDebtPaid = document.getElementById('debt-reset-paid').checked;
    
    if (totalDebt > 0 && monthlyDeduction <= 0) {
      showToast('请设置每月扣款金额', 'error');
      return;
    }
    
    const debtInfo = {
      totalDebt: totalDebt,
      monthlyDeduction: monthlyDeduction,
      debtReason: debtReason,
      resetDebtPaid: resetDebtPaid
    };
    
    setBtnLoading('btn-save-debt', true);
    google.script.run
      .withSuccessHandler(function(r) {
        setBtnLoading('btn-save-debt', false);
        if (!r.success) {
          showToast(r.message || '保存失败', 'error');
          return;
        }
        showToast('欠款设置已保存', 'success');
        closeModal('set-debt-modal');
        loadStaffList();
        setTimeout(loadStaffPage, 500);
      })
      .withFailureHandler(function(e) {
        setBtnLoading('btn-save-debt', false);
        showError(e, '保存欠款设置');
      })
      .updateDebtSettings(_currentUser, staffName, staffType, debtInfo);
  }

  // 显示离职模态框
  function setLeave(name) {
    // 从_staffList中找到员工信息
    const staff = _staffList.find(s => s.staffName === name);
    if (!staff) {
      showToast('找不到员工信息', 'error');
      return;
    }
    
    // 填充模态框数据
    document.getElementById('leave-staff-name').value = name;
    document.getElementById('leave-staff-salary').value = staff.salary || 0;
    document.getElementById('leave-staff-type').value = 'STAFF';
    
    // 显示员工信息
    document.getElementById('leave-display-name').textContent = name;
    document.getElementById('leave-display-company').textContent = staff.companyName || '-';
    document.getElementById('leave-display-salary').textContent = Number(staff.salary || 0).toLocaleString();
    document.getElementById('leave-staff-avatar').textContent = (name || '?').charAt(0).toUpperCase();
    document.getElementById('leave-staff-avatar').style.background = getAvatarColor(name);
    
    // 银行信息
    const bankDisplay = document.getElementById('leave-display-bank');
    if (staff.paymentMethod === 'CASH') {
      bankDisplay.innerHTML = '💵 现金';
    } else if (staff.bankType) {
      bankDisplay.innerHTML = `🏦 ${escapeHtml(staff.bankType)}`;
    } else {
      bankDisplay.innerHTML = '🏦 未设置';
    }
    
    // 设置默认值
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('leave-date').value = today;
    document.getElementById('leave-salary-month').value = getCurrentMonth();
    document.getElementById('leave-deduction').value = 0;
    document.getElementById('leave-remark').value = '离职最后工资';
    document.getElementById('leave-payment-method').value = staff.paymentMethod || 'BANK';
    document.getElementById('leave-reason').value = '';
    
    // 根据日期计算工资
    calculateLeaveSalary();
    
    showModal('staff-leave-modal');
  }
  
  // 更新离职工资计算
  function updateLeaveNetSalary() {
    const basic = Number(document.getElementById('leave-basic-salary').value) || 0;
    const deduction = Number(document.getElementById('leave-deduction').value) || 0;
    const net = basic - deduction;
    document.getElementById('leave-net-salary').textContent = net.toLocaleString();
  }
  
  // 根据离职日期计算工资
  function calculateLeaveSalary() {
    const leaveDate = document.getElementById('leave-date').value;
    const salaryMonth = document.getElementById('leave-salary-month').value;
    const monthlySalary = Number(document.getElementById('leave-staff-salary').value) || 0;
    const calcInfo = document.getElementById('leave-calc-info');
    
    if (!leaveDate || !salaryMonth || !monthlySalary) {
      if (calcInfo) calcInfo.textContent = '';
      return;
    }
    
    // 解析离职日期
    const leaveDateObj = new Date(leaveDate);
    const leaveDay = leaveDateObj.getDate();
    const leaveMonth = leaveDateObj.getMonth(); // 0-11
    const leaveYear = leaveDateObj.getFullYear();
    
    // 解析工资月份
    const [salaryYear, salaryMonthNum] = salaryMonth.split('-').map(Number);
    const salaryMonthIndex = salaryMonthNum - 1; // 转为0-11
    
    // 计算该月总天数
    const daysInMonth = new Date(salaryYear, salaryMonthIndex + 1, 0).getDate();
    
    // 计算工作天数
    let workDays;
    if (leaveYear === salaryYear && leaveMonth === salaryMonthIndex) {
      // 离职日期在工资月份内
      workDays = leaveDay;
    } else if (leaveYear > salaryYear || (leaveYear === salaryYear && leaveMonth > salaryMonthIndex)) {
      // 离职日期在工资月份之后，整月工资
      workDays = daysInMonth;
    } else {
      // 离职日期在工资月份之前，不应发工资
      workDays = 0;
    }
    
    // 计算基本工资
    const calculatedSalary = Math.round((monthlySalary * workDays / daysInMonth) * 100) / 100;
    
    // 更新显示
    document.getElementById('leave-basic-salary').value = calculatedSalary;
    
    if (calcInfo) {
      if (workDays === daysInMonth) {
        calcInfo.textContent = `整月工资`;
      } else if (workDays > 0) {
        calcInfo.textContent = `${workDays}/${daysInMonth}天 = RM ${monthlySalary} × ${workDays}/${daysInMonth}`;
      } else {
        calcInfo.textContent = `无需发放`;
      }
    }
    
    // 更新实发工资
    updateLeaveNetSalary();
  }
  
  // ========== 快速起薪功能 ==========
  // ========== 调薪功能 ==========
  function showAdjustSalary(name, type) {
    // 根据类型获取人员信息
    let person;
    if (type === 'MANAGER') {
      person = _managerList.find(m => m.staffName === name);
    } else {
      person = _staffList.find(s => s.staffName === name);
    }
    
    if (!person) {
      showToast('找不到人员信息', 'error');
      return;
    }
    
    // 填充数据
    document.getElementById('adjust-salary-name').value = name;
    document.getElementById('adjust-salary-type').value = type;
    
    // 显示人员信息
    document.getElementById('adjust-salary-display-name').textContent = name + (type === 'MANAGER' ? ' (主管)' : '');
    document.getElementById('adjust-salary-display-company').textContent = person.companyName || '-';
    document.getElementById('adjust-salary-current').textContent = Number(person.salary || 0).toLocaleString();
    document.getElementById('adjust-salary-avatar').textContent = (name || '?').charAt(0).toUpperCase();
    document.getElementById('adjust-salary-avatar').style.background = type === 'MANAGER' 
      ? 'linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%)' 
      : getAvatarColor(name);
    
    // 设置默认值
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('adjust-salary-new').value = person.salary || 0;
    document.getElementById('adjust-salary-date').value = today;
    document.getElementById('adjust-salary-reason').value = '';
    
    // 隐藏调薪幅度显示
    document.getElementById('adjust-salary-diff-box').style.display = 'none';
    
    showModal('adjust-salary-modal');
  }
  
  function updateAdjustSalaryDiff() {
    const currentText = document.getElementById('adjust-salary-current').textContent;
    const current = Number(currentText.replace(/,/g, '')) || 0;
    const newSalary = Number(document.getElementById('adjust-salary-new').value) || 0;
    const diffBox = document.getElementById('adjust-salary-diff-box');
    const diffEl = document.getElementById('adjust-salary-diff');
    
    if (current === 0 || newSalary === 0) {
      diffBox.style.display = 'none';
      return;
    }
    
    const diff = newSalary - current;
    const percent = ((diff / current) * 100).toFixed(1);
    
    if (diff > 0) {
      diffEl.innerHTML = `<span style="color: #059669;">+RM ${diff.toLocaleString()} (+${percent}%)</span>`;
      diffBox.style.background = '#ECFDF5';
    } else if (diff < 0) {
      diffEl.innerHTML = `<span style="color: #DC2626;">-RM ${Math.abs(diff).toLocaleString()} (${percent}%)</span>`;
      diffBox.style.background = '#FEF2F2';
    } else {
      diffEl.innerHTML = `<span style="color: #6B7280;">无变化</span>`;
      diffBox.style.background = '#F3F4F6';
    }
    
    diffBox.style.display = 'block';
  }
  
  function saveAdjustSalary() {
    const name = document.getElementById('adjust-salary-name').value;
    const type = document.getElementById('adjust-salary-type').value;
    const newSalary = Number(document.getElementById('adjust-salary-new').value) || 0;
    const effectiveDate = document.getElementById('adjust-salary-date').value;
    const reason = document.getElementById('adjust-salary-reason').value.trim();
    
    if (!name) {
      showToast('人员信息错误', 'error');
      return;
    }
    if (newSalary <= 0) {
      showToast('请输入新月薪', 'warning');
      return;
    }
    if (!effectiveDate) {
      showToast('请选择生效日期', 'warning');
      return;
    }
    if (!reason) {
      showToast('请填写调薪原因', 'warning');
      return;
    }
    
    closeModal('adjust-salary-modal');
    showLoading('保存调薪...');
    
    google.script.run
      .withSuccessHandler(function(r) {
        hideLoading();
        if (!r.success) {
          showToast(r.message || '调薪失败', 'error');
          return;
        }
        showToast('调薪成功！', 'success');
        
        // 刷新数据
        if (type === 'MANAGER') {
          loadManagerPage();
        } else {
          loadStaffPage();
        }
      })
      .withFailureHandler(function(e) {
        hideLoading();
        showError(e, '调薪');
      })
      .adjustSalary(_currentUser, {
        staffName: name,
        staffType: type,
        newSalary: newSalary,
        effectiveDate: effectiveDate,
        reason: reason
      });
  }
  
  // 确认离职
  async function confirmLeave() {
    const staffName = document.getElementById('leave-staff-name').value;
    const staffType = document.getElementById('leave-staff-type').value;
    const leaveDate = document.getElementById('leave-date').value;
    const leaveReason = document.getElementById('leave-reason').value;
    const salaryMonth = document.getElementById('leave-salary-month').value;
    const paymentMethod = document.getElementById('leave-payment-method').value;
    const basicSalary = Number(document.getElementById('leave-basic-salary').value) || 0;
    const deduction = Number(document.getElementById('leave-deduction').value) || 0;
    const remark = document.getElementById('leave-remark').value;
    
    if (!staffName) {
      showToast('员工信息错误', 'error');
      return;
    }
    if (!leaveDate) {
      showToast('请选择离职日期', 'warning');
      return;
    }
    if (!salaryMonth) {
      showToast('请选择工资月份', 'warning');
      return;
    }
    if (basicSalary <= 0) {
      showToast('请输入基本工资', 'warning');
      return;
    }
    
    const net = basicSalary - deduction;
    const methodText = paymentMethod === 'CASH' ? '现金' : '银行汇款';
    const typeText = staffType === 'MANAGER' ? '主管' : '员工';
    
    const confirmed = await showConfirm({
      type: 'warning',
      title: '确认离职',
      message: `确定要设置${typeText} ${staffName} 离职吗？\n\n离职日期: ${leaveDate}\n最后工资: RM ${net.toLocaleString()} (${methodText})\n\n此操作将自动创建工资草稿。`,
      okText: '确认离职',
      cancelText: '取消'
    });
    
    if (!confirmed) return;
    
    closeModal('staff-leave-modal');
    showLoading('处理离职中...');
    
    google.script.run
      .withSuccessHandler(function(r) {
        hideLoading();
        if (!r.success) {
          showToast(r.message || '操作失败', 'error');
          return;
        }
        showToast('已完成离职处理，工资草稿已创建', 'success');
        
        // 根据类型刷新对应页面
        if (staffType === 'MANAGER') {
          loadManagersPage();
        } else {
          loadStaffList();
          setTimeout(loadStaffPage, 500);
        }
      })
      .withFailureHandler(function(e) {
        hideLoading();
        showError(e, '设置离职');
      })
      .processStaffLeave(_currentUser, {
        staffName: staffName,
        staffType: staffType,
        leaveDate: leaveDate,
        leaveReason: leaveReason,
        salaryMonth: salaryMonth,
        paymentMethod: paymentMethod,
        basicSalary: basicSalary,
        deduction: deduction,
        remark: remark
      });
  }

  // ========== 主管管理页面 ==========
  function loadManagersPage() {
    google.script.run
      .withSuccessHandler(function(list) {
        _managerList = list || [];
        renderManagerList();
      })
      .withFailureHandler(function(e) { showError(e, '加载主管列表'); })
      .getManagerList(_currentUser);
  }
  
  function renderManagerList() {
    const container = document.getElementById('manager-grid');
    const empty = document.getElementById('manager-empty');
    const emptyText = document.getElementById('manager-empty-text');
    
    if (!container) return;
    
    // 获取搜索关键词
    const searchInput = document.getElementById('manager-search');
    const keyword = searchInput ? searchInput.value.trim().toLowerCase() : '';
    
    // 统计数据
    let activeCount = 0;
    let leftCount = 0;
    let debtCount = 0;
    let totalSalary = 0;
    
    // 筛选后的列表
    let filteredList = _managerList.filter(function(mgr) {
      const isActive = (mgr.status || mgr.Status || '').toUpperCase() !== 'LEFT';
      const hasDebt = Number(mgr.debtRemaining || 0) > 0;
      
      // 统计
      if (isActive) {
        activeCount++;
        totalSalary += Number(mgr.salary || 0);
      } else {
        leftCount++;
      }
      if (hasDebt) debtCount++;
      
      // 搜索过滤
      if (keyword) {
        const name = (mgr.staffName || '').toLowerCase();
        const company = (mgr.companyName || '').toLowerCase();
        if (!name.includes(keyword) && !company.includes(keyword)) {
          return false;
        }
      }
      
      // 状态筛选
      if (_managerFilter === 'active' && !isActive) return false;
      if (_managerFilter === 'left' && isActive) return false;
      if (_managerFilter === 'debt' && !hasDebt) return false;
      
      return true;
    });
    
    // 更新统计卡片（带动画）
    animateNumber('manager-total-count', activeCount);
    animateNumber('manager-salary-total', totalSalary, 'RM ');
    animateNumber('manager-debt-count', debtCount);
    animateNumber('manager-left-count', leftCount);
    
    // 更新筛选按钮计数
    const allCount = document.getElementById('mgr-filter-all-count');
    const activeEl = document.getElementById('mgr-filter-active-count');
    const leftEl = document.getElementById('mgr-filter-left-count');
    const debtEl = document.getElementById('mgr-filter-debt-count');
    if (allCount) allCount.textContent = _managerList.length;
    if (activeEl) activeEl.textContent = activeCount;
    if (leftEl) leftEl.textContent = leftCount;
    if (debtEl) debtEl.textContent = debtCount;
    
    // 排序
    filteredList = filteredList.slice().sort((a, b) => {
      let valA, valB;
      switch (_managerSortBy) {
        case 'salary':
          valA = Number(a.salary) || 0;
          valB = Number(b.salary) || 0;
          break;
        case 'date':
          valA = new Date(a.createdAt || 0).getTime();
          valB = new Date(b.createdAt || 0).getTime();
          break;
        default: // name
          valA = (a.staffName || '').toLowerCase();
          valB = (b.staffName || '').toLowerCase();
      }
      if (valA < valB) return _managerSortOrder === 'asc' ? -1 : 1;
      if (valA > valB) return _managerSortOrder === 'asc' ? 1 : -1;
      return 0;
    });
    
    // 分页
    const totalPages = Math.ceil(filteredList.length / _pageSize);
    if (_managerCurrentPage > totalPages) _managerCurrentPage = totalPages || 1;
    const startIndex = (_managerCurrentPage - 1) * _pageSize;
    const paginatedList = filteredList.slice(startIndex, startIndex + _pageSize);
    
    if (filteredList.length === 0) {
      container.innerHTML = '';
      if (empty) {
        empty.style.display = 'block';
        if (emptyText) emptyText.textContent = keyword ? '没有找到匹配的主管' : '暂无主管数据';
      }
      renderPagination('manager-pagination', 1, 1, 'setManagerPage');
      return;
    }
    
    if (empty) empty.style.display = 'none';
    
    container.innerHTML = paginatedList.map(function(mgr) {
      const isActive = (mgr.status || mgr.Status || '').toUpperCase() !== 'LEFT';
      const color = getAvatarColor(mgr.staffName);
      const daysFromJoin = calculateDaysFromJoin(mgr.createdAt);
      const daysBadge = daysFromJoin !== null ? 
        `<span class="days-badge ${daysFromJoin <= 30 ? 'new' : ''}">${daysFromJoin === 0 ? '今天入职' : '入职' + daysFromJoin + '天'}</span>` : '';
      
      return `
        <div class="staff-card">
          <div class="staff-card-header">
            <div class="staff-avatar ${color}">${(mgr.staffName || '?').charAt(0).toUpperCase()}</div>
            <div style="flex: 1;">
              <div class="staff-name">${escapeHtml(mgr.staffName)} ${daysBadge}</div>
              <div class="staff-company">${escapeHtml(mgr.companyName || '-')}</div>
            </div>
            <span class="badge badge-manager">👔 主管</span>
            <span class="badge ${isActive ? 'badge-active' : 'badge-left'}" style="margin-left: 4px;">${isActive ? '✓ 在职' : '已离职'}</span>
          </div>
          <div class="staff-card-info">
            <div class="staff-info-item">
              <span class="staff-info-icon">💰</span>
              <div class="staff-info-content">
                <span class="staff-info-label">月薪</span>
                <span class="staff-info-value">RM ${Number(mgr.salary || 0).toLocaleString()}</span>
              </div>
            </div>
            <div class="staff-info-item">
              <span class="staff-info-icon">💳</span>
              <div class="staff-info-content">
                <span class="staff-info-label">付款方式</span>
                <span class="staff-info-value">${mgr.paymentMethod === 'CASH' ? '现金' : '银行汇款'}</span>
              </div>
            </div>
          </div>
          ${mgr.paymentMethod === 'BANK' && mgr.bankType ? `
            <div class="staff-bank-info">
              <span class="staff-bank-icon">🏦</span>
              <div class="staff-bank-details">
                <div class="staff-bank-name">${escapeHtml(mgr.bankType)}</div>
                <div style="font-size: 12px; color: #374151;">户名: ${escapeHtml(mgr.bankHolder || '-')}</div>
                <div class="staff-bank-account">账号: ${escapeHtml(mgr.bankAccount || '-')}</div>
              </div>
              ${mgr.bankChanged ? '<span class="badge badge-error">⚠️ 资料变更</span>' : ''}
            </div>
          ` : ''}
          ${Number(mgr.debtRemaining || 0) > 0 ? `
            <div class="staff-debt-info" style="background: #FEF3C7; padding: 8px 12px; border-radius: 6px; margin-top: 8px;">
              <span>💸 欠款: RM ${Number(mgr.debtRemaining).toLocaleString()} (月扣 RM ${Number(mgr.monthlyDeduction || 0).toLocaleString()})</span>
            </div>
          ` : ''}
        </div>
      `;
    }).join('');
    
    // 渲染分页
    renderPagination('manager-pagination', _managerCurrentPage, totalPages, 'setManagerPage');
  }
  
  function filterManagerList() {
    renderManagerList();
  }
  
  function setManagerFilter(filter) {
    _managerFilter = filter;
    document.querySelectorAll('#page-managers .filter-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.filter === filter);
    });
    renderManagerList();
  }
  
  function editManager(name) {
    // 从主管列表中找到该主管的信息
    const manager = _managerList.find(m => m.staffName === name);
    if (!manager) {
      showToast('找不到主管信息', 'error');
      return;
    }
    
    // 填充表单
    document.getElementById('edit-manager-original-name').value = name;
    document.getElementById('edit-manager-name').value = manager.staffName || '';
    document.getElementById('edit-manager-company').value = manager.companyName || '';
    document.getElementById('edit-manager-salary').value = manager.salary || '';
    document.getElementById('edit-manager-payment').value = manager.paymentMethod || 'BANK';
    document.getElementById('edit-manager-bankholder').value = manager.bankHolder || '';
    document.getElementById('edit-manager-banktype').value = manager.bankType || '';
    document.getElementById('edit-manager-bankaccount').value = manager.bankAccount || '';
    
    showModal('edit-manager-modal');
  }
  
  function saveManagerEdit() {
    const originalName = document.getElementById('edit-manager-original-name').value;
    if (!originalName) {
      showToast('主管信息错误', 'error');
      return;
    }
    
    const updates = {
      companyName: document.getElementById('edit-manager-company').value.trim(),
      salary: Number(document.getElementById('edit-manager-salary').value) || 0,
      paymentMethod: document.getElementById('edit-manager-payment').value,
      bankHolder: document.getElementById('edit-manager-bankholder').value.trim(),
      bankType: document.getElementById('edit-manager-banktype').value.trim(),
      bankAccount: document.getElementById('edit-manager-bankaccount').value.trim()
    };
    
    setBtnLoading('btn-update-manager', true);
    google.script.run
      .withSuccessHandler(function(r) {
        setBtnLoading('btn-update-manager', false);
        if (!r.success) {
          showToast(r.message || '更新失败', 'error');
          return;
        }
        showToast('主管信息已更新', 'success');
        if (r.changeNote) {
          showToast('银行变更已记录', 'info');
        }
        closeModal('edit-manager-modal');
        loadManagersPage();
      })
      .withFailureHandler(function(e) {
        setBtnLoading('btn-update-manager', false);
        showError(e, '更新主管');
      })
      .updateManagerInfo(_currentUser, originalName, updates);
  }
  
  function setManagerDebt(name) {
    // 从主管列表中找到该主管的信息
    const manager = _managerList.find(m => m.staffName === name);
    if (!manager) {
      showToast('找不到主管信息', 'error');
      return;
    }
    
    // 复用员工欠款Modal，设置type为MANAGER
    document.getElementById('debt-staff-name').value = name;
    document.getElementById('debt-staff-type').value = 'MANAGER';
    document.getElementById('debt-display-name').textContent = name + ' (主管)';
    document.getElementById('debt-current-total').textContent = Number(manager.totalDebt || 0).toLocaleString();
    document.getElementById('debt-current-paid').textContent = Number(manager.debtPaid || 0).toLocaleString();
    document.getElementById('debt-current-remaining').textContent = Number(manager.debtRemaining || 0).toLocaleString();
    
    document.getElementById('debt-total').value = manager.totalDebt || '';
    document.getElementById('debt-monthly').value = manager.monthlyDeduction || '';
    document.getElementById('debt-reason').value = manager.debtReason || '';
    document.getElementById('debt-reset-paid').checked = false;
    
    updateDebtPreview();
    showModal('set-debt-modal');
  }
  
  // 显示主管离职模态框
  function setManagerLeave(name) {
    // 从_managerList中找到主管信息
    const manager = _managerList.find(m => m.staffName === name);
    if (!manager) {
      showToast('找不到主管信息', 'error');
      return;
    }
    
    // 填充模态框数据
    document.getElementById('leave-staff-name').value = name;
    document.getElementById('leave-staff-salary').value = manager.salary || 0;
    document.getElementById('leave-staff-type').value = 'MANAGER';
    
    // 显示主管信息
    document.getElementById('leave-display-name').textContent = name + ' (主管)';
    document.getElementById('leave-display-company').textContent = manager.companyName || '-';
    document.getElementById('leave-display-salary').textContent = Number(manager.salary || 0).toLocaleString();
    document.getElementById('leave-staff-avatar').textContent = (name || '?').charAt(0).toUpperCase();
    document.getElementById('leave-staff-avatar').style.background = 'linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%)';
    
    // 银行信息
    const bankDisplay = document.getElementById('leave-display-bank');
    if (manager.paymentMethod === 'CASH') {
      bankDisplay.innerHTML = '💵 现金';
    } else if (manager.bankType) {
      bankDisplay.innerHTML = `🏦 ${escapeHtml(manager.bankType)}`;
    } else {
      bankDisplay.innerHTML = '🏦 未设置';
    }
    
    // 设置默认值
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('leave-date').value = today;
    document.getElementById('leave-salary-month').value = getCurrentMonth();
    document.getElementById('leave-deduction').value = 0;
    document.getElementById('leave-remark').value = '离职最后工资';
    document.getElementById('leave-payment-method').value = manager.paymentMethod || 'BANK';
    document.getElementById('leave-reason').value = '';
    
    // 根据日期计算工资
    calculateLeaveSalary();
    
    showModal('staff-leave-modal');
  }

  // ========== 账号管理 ==========
  function loadUsersPage() {
    google.script.run
      .withSuccessHandler(function(r) {
        if (!r.success) return;
        renderUsers(r.users || []);
      })
      .withFailureHandler(function(e) { showError(e, '加载用户列表'); })
      .getUsers(_currentUser);
  }

  function renderUsers(users) {
    const countEl = document.getElementById('user-count');
    if (countEl) countEl.textContent = users.length;
    
    const tbody = document.getElementById('users-tbody');
    if (!tbody) return;
    
    tbody.innerHTML = users.map(function(u) {
      const isCurrent = u.username === _currentUser.username;
      const isDisabled = u.status === 'DISABLED' || u.status === 'INACTIVE';
      return `
        <tr style="${isDisabled ? 'opacity: 0.6;' : ''}">
          <td>
            <div class="td-name">
              <div class="td-avatar" style="background: ${isDisabled ? '#9CA3AF' : 'var(--gradient-purple)'};">${u.username.charAt(0).toUpperCase()}</div>
              <div class="td-info">
                <div class="td-main">${escapeHtml(u.username)}</div>
              </div>
            </div>
          </td>
          <td>${escapeHtml(u.displayName || u.username)}</td>
          <td>
            <span class="badge ${u.role === 'ADMIN' ? 'badge-manager' : u.role === 'SECRETARY' ? 'badge-active' : 'badge-transfer'}">
              ${u.role === 'ADMIN' ? '管理员' : u.role === 'SECRETARY' ? '书记' : '会计'}
            </span>
          </td>
          <td>
            ${isDisabled 
              ? '<span class="badge badge-danger">已停用</span>' 
              : '<span class="badge badge-success">启用</span>'}
            ${isCurrent ? '<span class="badge badge-info" style="margin-left: 4px;">当前</span>' : ''}
          </td>
          <td>
            <div class="btn-group">
              <button class="btn btn-secondary btn-xs" onclick="App.resetUserPassword('${escapeHtml(u.username)}')">🔑 重置密码</button>
              ${!isCurrent ? (isDisabled 
                ? `<button class="btn btn-success btn-xs" onclick="App.enableUser('${escapeHtml(u.username)}')">✅ 启用</button>`
                : `<button class="btn btn-danger btn-xs" onclick="App.disableUser('${escapeHtml(u.username)}')">🚫 停用</button>`
              ) : ''}
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  function showAddUserModal() {
    // 清空表单
    ['user-username', 'user-password', 'user-display'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
    const roleEl = document.getElementById('new-user-role');
    if (roleEl) roleEl.value = 'SECRETARY';
    const reqPwdEl = document.getElementById('user-require-pwd-change');
    if (reqPwdEl) reqPwdEl.checked = true;
    
    showModal('add-user-modal');
  }

  function handleAddUser() {
    if (!validateUserForm()) return;
    
    const data = {
      username: document.getElementById('user-username').value.trim(),
      password: document.getElementById('user-password').value.trim(),
      displayName: document.getElementById('user-display').value.trim() || document.getElementById('user-username').value.trim(),
      role: document.getElementById('new-user-role').value,
      mustChangePassword: document.getElementById('user-require-pwd-change').checked
    };
    
    showLoading('创建账号...');
    google.script.run
      .withSuccessHandler(function(r) {
        hideLoading();
        if (!r.success) {
          showMessage('user-message', r.message || '创建失败', 'error');
          return;
        }
        showToast('账号创建成功', 'success');
        closeModal('add-user-modal');
        loadUsersPage();
      })
      .withFailureHandler(function(e) {
        hideLoading();
        showError(e, '创建账号');
      })
      .createUser(_currentUser, data);
  }

  function resetUserPassword(username) {
    // 打开重置密码Modal
    document.getElementById('reset-password-username').value = username;
    document.getElementById('reset-password-display').textContent = username;
    document.getElementById('new-password').value = '';
    document.getElementById('confirm-password').value = '';
    showModal('reset-password-modal');
  }
  
  function confirmResetPassword() {
    const username = document.getElementById('reset-password-username').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    
    if (!username) {
      showToast('用户信息错误', 'error');
      return;
    }
    
    if (!newPassword || newPassword.length < 6) {
      showToast('密码至少需要6位', 'error');
      return;
    }
    
    if (newPassword !== confirmPassword) {
      showToast('两次输入的密码不一致', 'error');
      return;
    }
    
    setBtnLoading('btn-reset-password', true);
    google.script.run
      .withSuccessHandler(function(r) {
        setBtnLoading('btn-reset-password', false);
        if (!r.success) {
          showToast(r.message || '重置失败', 'error');
          return;
        }
        showToast('密码已重置', 'success');
        closeModal('reset-password-modal');
      })
      .withFailureHandler(function(e) {
        setBtnLoading('btn-reset-password', false);
        showError(e, '重置密码');
      })
      .adminResetPassword(_currentUser, username, newPassword);
  }

  function disableUser(username) {
    showConfirm({
      type: 'danger',
      title: '停用账号',
      message: `确定要停用 ${username} 的账号吗？停用后该用户将无法登录。`,
      okText: '确认停用',
      cancelText: '取消'
    }).then(function(confirmed) {
      if (!confirmed) return;
      
      showLoading('处理中...');
      google.script.run
        .withSuccessHandler(function(r) {
          hideLoading();
          if (!r.success) {
            showToast(r.message || '操作失败', 'error');
            return;
          }
          showToast('账号已停用', 'success');
          loadUsersPage();
        })
        .withFailureHandler(function(e) {
          hideLoading();
          showError(e, '停用账号');
        })
        .disableUserAccount(_currentUser, username);
    });
  }
  
  function enableUser(username) {
    showConfirm({
      type: 'info',
      title: '启用账号',
      message: `确定要重新启用 ${username} 的账号吗？`,
      okText: '确认启用',
      cancelText: '取消'
    }).then(function(confirmed) {
      if (!confirmed) return;
      
      showLoading('处理中...');
      google.script.run
        .withSuccessHandler(function(r) {
          hideLoading();
          if (!r.success) {
            showToast(r.message || '操作失败', 'error');
            return;
          }
          showToast('账号已启用', 'success');
          loadUsersPage();
        })
        .withFailureHandler(function(e) {
          hideLoading();
          showError(e, '启用账号');
        })
        .enableUserAccount(_currentUser, username);
    });
  }

  // ========== 历史记录 ==========
  let _historyList = [];
  
  function loadHistory() {
    const actionFilter = document.getElementById('history-action-filter');
    const searchEl = document.getElementById('history-search');
    
    const action = actionFilter ? actionFilter.value : '';
    const search = searchEl ? searchEl.value.trim() : '';
    
    showLoading('加载历史记录...');
    google.script.run
      .withSuccessHandler(function(r) {
        hideLoading();
        if (!r.success) {
          showToast(r.message || '加载失败', 'error');
          return;
        }
        _historyList = r.logs || [];
        renderHistory(_historyList);
      })
      .withFailureHandler(function(e) {
        hideLoading();
        showError(e, '加载历史记录');
      })
      .getMyHistory(_currentUser, action, search);
  }
  
  function renderHistory(logs) {
    const list = document.getElementById('history-list');
    const empty = document.getElementById('history-empty');
    
    if (!logs || logs.length === 0) {
      if (list) list.innerHTML = '';
      if (empty) empty.style.display = 'block';
      return;
    }
    
    if (empty) empty.style.display = 'none';
    
    if (list) {
      list.innerHTML = logs.map(function(log, index) {
        const icon = getActionIcon(log.action);
        const color = getActionColor(log.action);
        const badgeColor = getActionBadgeColor(log.action);
        const formattedTime = formatHistoryTime(log.timestamp);
        const formattedDetails = formatHistoryDetails(log.action, log.details);
        
        return `
          <div class="history-item" style="display: flex; align-items: flex-start; padding: 16px 20px; border-bottom: 1px solid #f0f0f0; background: #fff; transition: all 0.2s;" 
               onmouseover="this.style.background='#f8fafc'; this.style.transform='translateX(4px)';" 
               onmouseout="this.style.background='#fff'; this.style.transform='';">
            <div style="width: 44px; height: 44px; border-radius: 12px; background: ${color}; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 16px; flex-shrink: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              ${icon}
            </div>
            <div style="flex: 1; min-width: 0;">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px; flex-wrap: wrap;">
                <span style="font-weight: 600; font-size: 15px; color: #1F2937;">${escapeHtml(formatActionName(log.action))}</span>
                ${log.target ? `<span style="color: #9CA3AF;">→</span><span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 600;">${escapeHtml(log.target)}</span>` : ''}
                <span style="padding: 2px 8px; border-radius: 4px; font-size: 11px; background: ${badgeColor.bg}; color: ${badgeColor.text};">${getActionCategory(log.action)}</span>
              </div>
              <div style="font-size: 13px; color: #4B5563; margin-bottom: 8px; line-height: 1.5;">
                ${formattedDetails}
              </div>
              <div style="display: flex; align-items: center; gap: 16px; font-size: 12px; color: #9CA3AF;">
                <span style="display: flex; align-items: center; gap: 4px;">
                  <span style="opacity: 0.7;">🕐</span>
                  <span>${formattedTime.relative}</span>
                </span>
                <span style="display: flex; align-items: center; gap: 4px;">
                  <span style="opacity: 0.7;">📅</span>
                  <span>${formattedTime.full}</span>
                </span>
                <span style="display: flex; align-items: center; gap: 4px;">
                  <span style="opacity: 0.7;">👤</span>
                  <span style="color: #6B7280; font-weight: 500;">${escapeHtml(log.operator)}</span>
                </span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
  }
  
  // 格式化时间显示
  function formatHistoryTime(timestamp) {
    if (!timestamp) return { relative: '未知', full: '-' };
    
    let date;
    if (typeof timestamp === 'string') {
      // 尝试解析各种格式
      if (timestamp.includes('GMT') || timestamp.includes('T')) {
        date = new Date(timestamp);
      } else if (timestamp.match(/^\d{4}-\d{2}-\d{2}/)) {
        date = new Date(timestamp);
      } else {
        date = new Date(timestamp);
      }
    } else {
      date = new Date(timestamp);
    }
    
    if (isNaN(date.getTime())) {
      return { relative: '未知时间', full: String(timestamp).substring(0, 19) };
    }
    
    const now = new Date();
    const diff = now - date;
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    let relative;
    if (seconds < 60) {
      relative = '刚刚';
    } else if (minutes < 60) {
      relative = minutes + ' 分钟前';
    } else if (hours < 24) {
      relative = hours + ' 小时前';
    } else if (days === 1) {
      relative = '昨天';
    } else if (days < 7) {
      relative = days + ' 天前';
    } else if (days < 30) {
      relative = Math.floor(days / 7) + ' 周前';
    } else {
      relative = Math.floor(days / 30) + ' 个月前';
    }
    
    // 格式化完整时间
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hour = String(date.getHours()).padStart(2, '0');
    const minute = String(date.getMinutes()).padStart(2, '0');
    
    const isToday = date.toDateString() === now.toDateString();
    const isYesterday = new Date(now - 86400000).toDateString() === date.toDateString();
    
    let full;
    if (isToday) {
      full = '今天 ' + hour + ':' + minute;
    } else if (isYesterday) {
      full = '昨天 ' + hour + ':' + minute;
    } else if (year === now.getFullYear()) {
      full = month + '-' + day + ' ' + hour + ':' + minute;
    } else {
      full = year + '-' + month + '-' + day + ' ' + hour + ':' + minute;
    }
    
    return { relative: relative, full: full };
  }
  
  // 格式化详情内容
  function formatHistoryDetails(action, details) {
    if (!details || details === '无详细信息') {
      return '<span style="color: #9CA3AF; font-style: italic;">无详细信息</span>';
    }
    
    // 尝试解析特定格式
    const parts = [];
    
    // 解析 key: value; 格式
    const kvPairs = String(details).split(';').filter(p => p.trim());
    
    for (const pair of kvPairs) {
      const colonIndex = pair.indexOf(':');
      if (colonIndex > 0) {
        let key = pair.substring(0, colonIndex).trim();
        let value = pair.substring(colonIndex + 1).trim();
        
        // 翻译常见的 key
        const keyMap = {
          'changes': '变更内容',
          'changeNote': '变更说明',
          'salary': '月薪',
          'companyName': '公司',
          'bankHolder': '银行户名',
          'bankType': '银行类型',
          'bankAccount': '银行账号',
          'paymentMethod': '付款方式',
          'role': '角色',
          'targetUsername': '目标用户',
          'resetBy': '重置者',
          'month': '月份',
          'basicSalary': '基本工资',
          'deduction': '扣款',
          'netSalary': '实发工资',
          'staffName': '姓名',
          'totalDebt': '欠款总额',
          'monthlyDeduction': '月扣金额',
          'debtReason': '欠款原因',
          'leaveDate': '离职日期',
          'status': '状态'
        };
        
        const displayKey = keyMap[key] || key;
        
        // 尝试解析 JSON 值
        if (value.startsWith('{') || value.startsWith('[')) {
          try {
            const parsed = JSON.parse(value);
            const formattedParts = [];
            for (const [k, v] of Object.entries(parsed)) {
              const dk = keyMap[k] || k;
              if (v !== null && v !== undefined && v !== '') {
                formattedParts.push('<span style="color: #6B7280;">' + escapeHtml(dk) + ':</span> <span style="color: #1F2937; font-weight: 500;">' + escapeHtml(String(v)) + '</span>');
              }
            }
            if (formattedParts.length > 0) {
              parts.push('<div style="display: flex; flex-wrap: wrap; gap: 8px 16px; margin-top: 4px;">' + formattedParts.join('') + '</div>');
            }
            continue;
          } catch (e) {
            // 不是有效 JSON，继续正常处理
          }
        }
        
        // 处理箭头格式 (如 "银行: BCA → CIMB")
        if (value.includes('→')) {
          const arrowParts = value.split('→').map(p => p.trim());
          parts.push('<span style="color: #6B7280;">' + escapeHtml(displayKey) + ':</span> <span style="color: #EF4444; text-decoration: line-through;">' + escapeHtml(arrowParts[0]) + '</span> <span style="color: #9CA3AF;">→</span> <span style="color: #10B981; font-weight: 500;">' + escapeHtml(arrowParts[1] || '') + '</span>');
        } else {
          // 普通 key: value
          parts.push('<span style="color: #6B7280;">' + escapeHtml(displayKey) + ':</span> <span style="color: #1F2937; font-weight: 500;">' + escapeHtml(value) + '</span>');
        }
      } else if (pair.trim()) {
        parts.push(escapeHtml(pair.trim()));
      }
    }
    
    if (parts.length === 0) {
      return escapeHtml(details);
    }
    
    return '<div style="display: flex; flex-wrap: wrap; gap: 6px 16px;">' + parts.join('') + '</div>';
  }
  
  // 获取操作类别
  function getActionCategory(action) {
    const categories = {
      'LOGIN': '系统',
      'LOGOUT': '系统',
      'CHANGE_PASSWORD': '系统',
      'RESET_PASSWORD': '系统',
      'CREATE_USER': '系统',
      'DISABLE_USER': '系统',
      'ENABLE_USER': '系统',
      'ADD_SALARY': '工资',
      'UPDATE_DRAFT': '工资',
      'DELETE_DRAFT': '工资',
      'SUBMIT_DRAFTS': '工资',
      'BATCH_SUBMIT': '工资',
      'MARK_PAID': '发放',
      'ADD_STAFF': '人员',
      'ADD_MANAGER': '人员',
      'UPDATE_STAFF': '人员',
      'UPDATE_MANAGER': '人员',
      'LEAVE_STAFF': '人员',
      'LEAVE_MANAGER': '人员',
      'SET_LEAVE': '人员',
      'UPDATE_DEBT': '财务'
    };
    return categories[action] || '其他';
  }
  
  // 获取操作类别徽章颜色
  function getActionBadgeColor(action) {
    const category = getActionCategory(action);
    const colors = {
      '系统': { bg: '#EDE9FE', text: '#7C3AED' },
      '工资': { bg: '#DBEAFE', text: '#2563EB' },
      '发放': { bg: '#D1FAE5', text: '#059669' },
      '人员': { bg: '#FEF3C7', text: '#D97706' },
      '财务': { bg: '#FCE7F3', text: '#DB2777' },
      '其他': { bg: '#F3F4F6', text: '#6B7280' }
    };
    return colors[category] || colors['其他'];
  }
  
  function getActionIcon(action) {
    const icons = {
      'LOGIN': '🔑',
      'LOGOUT': '🚪',
      'ADD_SALARY': '💰',
      'UPDATE_DRAFT': '✏️',
      'DELETE_DRAFT': '🗑️',
      'SUBMIT_DRAFTS': '📤',
      'BATCH_SUBMIT': '📦',
      'MARK_PAID': '✅',
      'ADD_STAFF': '👤',
      'ADD_MANAGER': '👔',
      'UPDATE_STAFF': '✏️',
      'UPDATE_MANAGER': '✏️',
      'LEAVE_STAFF': '🚪',
      'LEAVE_MANAGER': '🚪',
      'SET_LEAVE': '🚪',
      'UPDATE_DEBT': '💸',
      'CHANGE_PASSWORD': '🔐',
      'RESET_PASSWORD': '🔑',
      'CREATE_USER': '➕',
      'DISABLE_USER': '🚫',
      'ENABLE_USER': '✅'
    };
    return icons[action] || '📝';
  }
  
  function getActionColor(action) {
    const colors = {
      'LOGIN': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
      'LOGOUT': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
      'ADD_SALARY': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
      'UPDATE_DRAFT': 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
      'DELETE_DRAFT': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
      'SUBMIT_DRAFTS': 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
      'BATCH_SUBMIT': 'linear-gradient(135deg, #d299c2 0%, #fef9d7 100%)',
      'MARK_PAID': 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
      'ADD_STAFF': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
      'ADD_MANAGER': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
      'UPDATE_STAFF': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
      'UPDATE_MANAGER': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
      'SET_LEAVE': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
      'UPDATE_DEBT': 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
      'CHANGE_PASSWORD': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
      'RESET_PASSWORD': 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
    };
    return colors[action] || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
  }
  
  function formatActionName(action) {
    const names = {
      'LOGIN': '登录系统',
      'LOGOUT': '登出系统',
      'ADD_SALARY': '录入工资',
      'UPDATE_DRAFT': '编辑草稿',
      'DELETE_DRAFT': '删除草稿',
      'SUBMIT_DRAFTS': '提交草稿',
      'BATCH_SUBMIT': '批量提交',
      'MARK_PAID': '标记已发放',
      'ADD_STAFF': '添加员工',
      'ADD_MANAGER': '添加主管',
      'UPDATE_STAFF': '编辑员工',
      'UPDATE_MANAGER': '编辑主管',
      'LEAVE_STAFF': '员工离职',
      'LEAVE_MANAGER': '主管离职',
      'SET_LEAVE': '设置离职',
      'UPDATE_DEBT': '设置欠款',
      'CHANGE_PASSWORD': '修改密码',
      'RESET_PASSWORD': '重置密码',
      'CREATE_USER': '创建账号',
      'DISABLE_USER': '停用账号',
      'ENABLE_USER': '启用账号'
    };
    return names[action] || action;
  }

  // ========== 操作日志 ==========
  function loadLogs() {
    const actionFilter = document.getElementById('log-action-filter');
    const searchEl = document.getElementById('log-search');
    
    const action = actionFilter ? actionFilter.value : '';
    const search = searchEl ? searchEl.value.trim() : '';
    
    showLoading('加载日志...');
    google.script.run
      .withSuccessHandler(function(r) {
        hideLoading();
        if (!r.success) {
          showToast(r.message || '加载失败', 'error');
          return;
        }
        _logList = r.logs || [];
        renderLogs(_logList);
      })
      .withFailureHandler(function(e) {
        hideLoading();
        showError(e, '加载日志');
      })
      .getLogs(_currentUser, action, search);
  }

  function renderLogs(logs) {
    const tbody = document.getElementById('logs-tbody');
    const empty = document.getElementById('logs-empty');
    
    if (!logs || logs.length === 0) {
      if (tbody) tbody.innerHTML = '';
      if (empty) empty.style.display = 'block';
      return;
    }
    
    if (empty) empty.style.display = 'none';
    if (tbody) {
      tbody.innerHTML = logs.map(function(log) {
        return `
          <tr>
            <td style="font-size: 12px; color: var(--text-muted); white-space: nowrap;">${escapeHtml(log.timestamp)}</td>
            <td><span class="badge badge-info">${escapeHtml(log.action)}</span></td>
            <td>${escapeHtml(log.operator)}</td>
            <td>${escapeHtml(log.target || '-')}</td>
            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(log.details || '-')}</td>
          </tr>
        `;
      }).join('');
    }
  }

  // ========== 密码管理 ==========
  function openPasswordModal(isForced) {
    _isFirstLoginPasswordChange = isForced || false;
    
    const title = document.getElementById('password-modal-title');
    const oldPwdGroup = document.getElementById('old-password-group');
    const cancelBtn = document.getElementById('password-cancel-btn');
    const closeBtn = document.getElementById('password-modal-close');
    
    if (isForced) {
      if (title) title.textContent = '🔐 首次登录请更换密码';
      if (oldPwdGroup) oldPwdGroup.style.display = 'none';
      if (cancelBtn) cancelBtn.style.display = 'none';
      if (closeBtn) closeBtn.style.display = 'none';
    } else {
      if (title) title.textContent = '🔐 更换密码';
      if (oldPwdGroup) oldPwdGroup.style.display = 'block';
      if (cancelBtn) cancelBtn.style.display = 'inline-flex';
      if (closeBtn) closeBtn.style.display = 'flex';
    }
    
    // 清空表单
    ['change-old-password', 'change-new-password', 'change-confirm-password'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
    
    const bar = document.getElementById('password-strength-bar');
    const text = document.getElementById('password-strength-text');
    if (bar) bar.className = 'password-strength-bar';
    if (text) text.textContent = '';
    
    showModal('password-modal');
  }

  function closePasswordModal() {
    if (_isFirstLoginPasswordChange) return;
    closeModal('password-modal');
  }

  function checkPasswordStrength() {
    const pwdEl = document.getElementById('change-new-password');
    const bar = document.getElementById('password-strength-bar');
    const text = document.getElementById('password-strength-text');
    
    const pwd = pwdEl ? pwdEl.value : '';
    
    if (!pwd) {
      if (bar) bar.className = 'password-strength-bar';
      if (text) text.textContent = '';
      return;
    }
    
    let score = 0;
    if (pwd.length >= 6) score++;
    if (pwd.length >= 10) score++;
    if (/[A-Z]/.test(pwd)) score++;
    if (/[0-9]/.test(pwd)) score++;
    if (/[^A-Za-z0-9]/.test(pwd)) score++;
    
    if (score <= 2) {
      if (bar) bar.className = 'password-strength-bar weak';
      if (text) { text.textContent = '密码强度：弱'; text.style.color = 'var(--error)'; }
    } else if (score <= 3) {
      if (bar) bar.className = 'password-strength-bar medium';
      if (text) { text.textContent = '密码强度：中'; text.style.color = 'var(--warning)'; }
    } else {
      if (bar) bar.className = 'password-strength-bar strong';
      if (text) { text.textContent = '密码强度：强'; text.style.color = 'var(--success)'; }
    }
  }

  function handleChangePassword() {
    const oldPwd = document.getElementById('change-old-password').value;
    const newPwd = document.getElementById('change-new-password').value;
    const confirmPwd = document.getElementById('change-confirm-password').value;
    
    if (!_isFirstLoginPasswordChange && !oldPwd) {
      showMessage('password-change-message', '请输入当前密码', 'error');
      return;
    }
    if (!newPwd || newPwd.length < 6) {
      showMessage('password-change-message', '新密码至少6个字符', 'error');
      return;
    }
    if (newPwd !== confirmPwd) {
      showMessage('password-change-message', '两次输入的密码不一致', 'error');
      return;
    }
    
    showLoading('更换密码...');
    google.script.run
      .withSuccessHandler(function(r) {
        hideLoading();
        if (!r.success) {
          showMessage('password-change-message', r.message || '更换失败', 'error');
          return;
        }
        showToast('密码已更换', 'success');
        _isFirstLoginPasswordChange = false;
        closeModal('password-modal');
      })
      .withFailureHandler(function(e) {
        hideLoading();
        showError(e, '更换密码');
      })
      .changePassword(_currentUser, oldPwd, newPwd, _isFirstLoginPasswordChange);
  }

  // ========== 银行汇款汇总 ==========
  function showBankSummary() {
    const month = getCurrentMonth();
    
    showLoading('生成汇款汇总...');
    google.script.run
      .withSuccessHandler(function(r) {
        hideLoading();
        if (!r.success) {
          showToast(r.message || '生成失败', 'error');
          return;
        }
        
        const titleEl = document.getElementById('bank-summary-title');
        if (titleEl) titleEl.textContent = `📋 ${month} 银行汇款汇总`;
        
        const content = document.getElementById('bank-summary-content');
        let html = '';
        
        if (!r.groups || r.groups.length === 0) {
          html = '<div class="empty-state"><div class="empty-icon">📭</div><div class="empty-text">没有待汇款记录</div></div>';
        } else {
          r.groups.forEach(function(group) {
            html += `
              <div class="bank-group">
                <div class="bank-group-header">
                  <div class="bank-group-title">🏦 ${escapeHtml(group.bankType)}</div>
                  <div class="bank-group-total">RM ${group.total.toFixed(2)}</div>
                </div>
                <div class="bank-group-body">
            `;
            
            group.items.forEach(function(item) {
              html += `
                <div class="bank-item">
                  <div class="bank-item-info">
                    <div class="bank-item-name">${escapeHtml(item.name)} ${item.isManager ? '<span class="badge badge-manager" style="font-size: 10px; padding: 1px 4px;">主管</span>' : ''}</div>
                    <div class="bank-item-account">${escapeHtml(item.bankHolder)} · ${escapeHtml(item.bankAccount)}</div>
                  </div>
                  <div class="bank-item-amount">RM ${item.amount.toFixed(2)}</div>
                </div>
              `;
            });
            
            html += '</div></div>';
          });
          
          html += `
            <div style="margin-top: 20px; padding: 16px; background: var(--gradient-green-soft); border-radius: var(--radius-md);">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: 600;">总计汇款金额</span>
                <span style="font-size: 20px; font-weight: 800; color: #059669; font-family: 'JetBrains Mono', monospace;">RM ${r.grandTotal.toFixed(2)}</span>
              </div>
            </div>
          `;
        }
        
        if (content) content.innerHTML = html;
        showModal('bank-summary-modal');
      })
      .withFailureHandler(function(e) {
        hideLoading();
        showError(e, '生成汇总');
      })
      .getBankSummary(_currentUser, month);
  }

  function closeBankSummaryModal() {
    closeModal('bank-summary-modal');
  }

  function copyBankSummary() {
    const content = document.getElementById('bank-summary-content');
    const text = content ? content.innerText : '';
    
    navigator.clipboard.writeText(text).then(function() {
      showToast('已复制到剪贴板', 'success');
    }).catch(function() {
      showToast('复制失败，请手动选择复制', 'error');
    });
  }

  // ========== 银行变更详情 ==========
  function showBankChangeDetail(index) {
    const alert = _bankChangeAlerts[index];
    if (!alert) return;
    
    const content = document.getElementById('bank-change-detail-content');
    if (content) {
      content.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">
          <div style="width: 48px; height: 48px; border-radius: 12px; background: var(--gradient-${alert.type === 'MANAGER' ? 'purple' : 'blue'}-soft); display: flex; align-items: center; justify-content: center; font-size: 20px;">
            ${alert.type === 'MANAGER' ? '👔' : '👤'}
          </div>
          <div>
            <div style="font-size: 18px; font-weight: 700;">${escapeHtml(alert.name)}</div>
            <div style="color: var(--text-muted); font-size: 13px;">${alert.type === 'MANAGER' ? '主管' : '员工'} · 变更于 ${escapeHtml(alert.changedAt || '-')}</div>
          </div>
        </div>
        
        <div class="grid grid-2" style="gap: 20px;">
          <div class="info-box" style="background: var(--error-bg); border-color: rgba(239, 68, 68, 0.2);">
            <div class="info-box-title" style="color: var(--error);">❌ 原银行资料</div>
            <div class="info-item" style="background: white; margin-bottom: 8px;">
              <div class="info-label">银行户名</div>
              <div class="info-value">${escapeHtml(alert.oldBankHolder || '-')}</div>
            </div>
            <div class="info-item" style="background: white; margin-bottom: 8px;">
              <div class="info-label">银行类型</div>
              <div class="info-value">${escapeHtml(alert.oldBankType || '-')}</div>
            </div>
            <div class="info-item" style="background: white;">
              <div class="info-label">银行账号</div>
              <div class="info-value mono">${escapeHtml(alert.oldBankAccount || '-')}</div>
            </div>
          </div>
          
          <div class="info-box" style="background: var(--success-bg); border-color: rgba(16, 185, 129, 0.2);">
            <div class="info-box-title" style="color: var(--success);">✓ 新银行资料</div>
            <div class="info-item" style="background: white; margin-bottom: 8px;">
              <div class="info-label">银行户名</div>
              <div class="info-value">${escapeHtml(alert.bankHolder || '-')}</div>
            </div>
            <div class="info-item" style="background: white; margin-bottom: 8px;">
              <div class="info-label">银行类型</div>
              <div class="info-value">${escapeHtml(alert.bankType || '-')}</div>
            </div>
            <div class="info-item" style="background: white;">
              <div class="info-label">银行账号</div>
              <div class="info-value mono">${escapeHtml(alert.bankAccount || '-')}</div>
            </div>
          </div>
        </div>
      `;
    }
    
    showModal('bank-change-detail-modal');
  }

  function closeBankChangeDetailModal() {
    closeModal('bank-change-detail-modal');
  }

  // 显示提醒详情
  function showAlertDetail(type) {
    const modal = document.getElementById('alert-detail-modal');
    const header = document.getElementById('alert-detail-header');
    const title = document.getElementById('alert-detail-title');
    const content = document.getElementById('alert-detail-content');
    
    if (!modal || !content) return;
    
    let headerBg = '';
    let titleText = '';
    let contentHtml = '';
    
    switch (type) {
      case 'bank-change':
        // 银行变更使用原来的专用模态框
        showModal('bank-change-detail-modal');
        renderBankChangeDetailList();
        return;
        
      case 'debt':
        headerBg = 'linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%)';
        titleText = '💸 欠款待扣详情';
        contentHtml = renderDebtDetailList();
        break;
        
      case 'new-staff':
        headerBg = 'linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%)';
        titleText = '🆕 新员工详情';
        contentHtml = renderNewStaffDetailList();
        break;
        
      case 'left-staff':
        headerBg = 'linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%)';
        titleText = '👋 离职员工详情';
        contentHtml = renderLeftStaffDetailList();
        break;
        
      case 'salary-adjust':
        headerBg = 'linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%)';
        titleText = '📈 加薪详情';
        contentHtml = renderSalaryAdjustDetailList();
        break;
        
      default:
        return;
    }
    
    header.style.background = headerBg;
    title.textContent = titleText;
    content.innerHTML = contentHtml;
    
    showModal('alert-detail-modal');
  }
  
  // 渲染银行变更详情列表
  function renderBankChangeDetailList() {
    const content = document.getElementById('bank-change-detail-content');
    if (!content || !_bankChangeAlerts || _bankChangeAlerts.length === 0) {
      if (content) content.innerHTML = '<div class="empty-state"><div class="empty-icon">✅</div><div class="empty-text">没有银行变更记录</div></div>';
      return;
    }
    
    content.innerHTML = _bankChangeAlerts.map((item, index) => `
      <div class="detail-card" style="background: #FFF7ED; border-left: 4px solid #F97316; padding: 16px; margin-bottom: 12px; border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 48px; height: 48px; border-radius: 50%; background: ${item.isManager ? 'linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%)' : getAvatarColor(item.staffName)}; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 600;">
              ${(item.staffName || '?').charAt(0).toUpperCase()}
            </div>
            <div>
              <div style="font-weight: 600; font-size: 16px;">${escapeHtml(item.staffName)} ${item.isManager ? '<span style="font-size:11px;background:#8B5CF6;color:white;padding:2px 6px;border-radius:4px;margin-left:6px;">主管</span>' : ''}</div>
              <div style="font-size: 13px; color: #6B7280;">${escapeHtml(item.companyName || '-')}</div>
            </div>
          </div>
          <span style="background: #FEF3C7; color: #92400E; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">${item.daysAgo === 0 ? '今天' : item.daysAgo + '天前'}</span>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div style="background: #FEE2E2; padding: 12px; border-radius: 8px;">
            <div style="font-size: 11px; color: #991B1B; margin-bottom: 4px;">旧银行资料</div>
            <div style="font-weight: 600;">${escapeHtml(item.oldBankType || '-')}</div>
            <div style="font-size: 13px; color: #6B7280;">${escapeHtml(item.oldBankHolder || '-')}</div>
            <div style="font-size: 13px; font-family: monospace;">${escapeHtml(item.oldBankAccount || '-')}</div>
          </div>
          <div style="background: #D1FAE5; padding: 12px; border-radius: 8px;">
            <div style="font-size: 11px; color: #065F46; margin-bottom: 4px;">新银行资料</div>
            <div style="font-weight: 600;">${escapeHtml(item.bankType || '-')}</div>
            <div style="font-size: 13px; color: #6B7280;">${escapeHtml(item.bankHolder || '-')}</div>
            <div style="font-size: 13px; font-family: monospace;">${escapeHtml(item.bankAccount || '-')}</div>
          </div>
        </div>
        ${item.changeNote ? `<div style="margin-top: 12px; padding: 8px 12px; background: #F3F4F6; border-radius: 6px; font-size: 13px; color: #4B5563;">📝 ${escapeHtml(item.changeNote)}</div>` : ''}
      </div>
    `).join('');
  }
  
  // 渲染欠款详情列表
  function renderDebtDetailList() {
    if (!_debtAlerts || _debtAlerts.length === 0) {
      return '<div class="empty-state"><div class="empty-icon">✅</div><div class="empty-text">没有欠款待扣</div></div>';
    }
    
    return _debtAlerts.map(item => `
      <div class="detail-card" style="background: #FFFBEB; border-left: 4px solid #F59E0B; padding: 16px; margin-bottom: 12px; border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 48px; height: 48px; border-radius: 50%; background: ${item.type === 'MANAGER' ? 'linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%)' : getAvatarColor(item.name)}; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 600;">
              ${(item.name || '?').charAt(0).toUpperCase()}
            </div>
            <div>
              <div style="font-weight: 600; font-size: 16px;">${escapeHtml(item.name)} ${item.type === 'MANAGER' ? '<span style="font-size:11px;background:#8B5CF6;color:white;padding:2px 6px;border-radius:4px;margin-left:6px;">主管</span>' : ''}</div>
            </div>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px;">
          <div style="background: #FEF2F2; padding: 10px; border-radius: 8px; text-align: center;">
            <div style="font-size: 11px; color: #991B1B;">总欠款</div>
            <div style="font-size: 18px; font-weight: 700; color: #DC2626;">RM ${Number(item.totalDebt || 0).toLocaleString()}</div>
          </div>
          <div style="background: #D1FAE5; padding: 10px; border-radius: 8px; text-align: center;">
            <div style="font-size: 11px; color: #065F46;">已还</div>
            <div style="font-size: 18px; font-weight: 700; color: #059669;">RM ${Number(item.debtPaid || 0).toLocaleString()}</div>
          </div>
          <div style="background: #FEF3C7; padding: 10px; border-radius: 8px; text-align: center;">
            <div style="font-size: 11px; color: #92400E;">剩余</div>
            <div style="font-size: 18px; font-weight: 700; color: #D97706;">RM ${Number(item.remaining || 0).toLocaleString()}</div>
          </div>
        </div>
        <div style="margin-top: 12px; display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #F3F4F6; border-radius: 6px;">
          <span style="font-size: 13px; color: #4B5563;">每月扣款</span>
          <span style="font-weight: 600; color: #1F2937;">RM ${Number(item.monthlyDeduction || 0).toLocaleString()}</span>
        </div>
        ${item.reason ? `<div style="margin-top: 8px; padding: 8px 12px; background: #FEF3C7; border-radius: 6px; font-size: 13px; color: #92400E;">📝 ${escapeHtml(item.reason)}</div>` : ''}
      </div>
    `).join('');
  }
  
  // 渲染新员工详情列表
  function renderNewStaffDetailList() {
    if (!_newStaffAlerts || _newStaffAlerts.length === 0) {
      return '<div class="empty-state"><div class="empty-icon">📭</div><div class="empty-text">没有新员工</div></div>';
    }
    
    return _newStaffAlerts.map(item => `
      <div class="detail-card" style="background: #ECFDF5; border-left: 4px solid #10B981; padding: 16px; margin-bottom: 12px; border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 48px; height: 48px; border-radius: 50%; background: ${item.type === 'MANAGER' ? 'linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%)' : getAvatarColor(item.name)}; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 600;">
              ${(item.name || '?').charAt(0).toUpperCase()}
            </div>
            <div>
              <div style="font-weight: 600; font-size: 16px;">${escapeHtml(item.name)} ${item.type === 'MANAGER' ? '<span style="font-size:11px;background:#8B5CF6;color:white;padding:2px 6px;border-radius:4px;margin-left:6px;">主管</span>' : ''}</div>
              <div style="font-size: 13px; color: #6B7280;">${escapeHtml(item.company || '-')}</div>
            </div>
          </div>
          <span style="background: #D1FAE5; color: #065F46; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">${item.daysAgo === 0 ? '今天入职' : item.daysAgo + '天前入职'}</span>
        </div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 16px;">
          <div style="background: white; padding: 10px; border-radius: 8px;">
            <div style="font-size: 11px; color: #6B7280;">入职日期</div>
            <div style="font-weight: 600;">${escapeHtml(item.createdAt || '-')}</div>
          </div>
          <div style="background: white; padding: 10px; border-radius: 8px;">
            <div style="font-size: 11px; color: #6B7280;">月薪</div>
            <div style="font-weight: 600; color: #059669;">RM ${Number(item.salary || 0).toLocaleString()}</div>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 8px;">
          <div style="background: white; padding: 10px; border-radius: 8px;">
            <div style="font-size: 11px; color: #6B7280;">银行</div>
            <div style="font-weight: 500;">${escapeHtml(item.bankType || '-')}</div>
            <div style="font-size: 12px; color: #374151;">户名: ${escapeHtml(item.bankHolder || '-')}</div>
            <div style="font-size: 12px; font-family: monospace; color: #6B7280;">账号: ${escapeHtml(item.bankAccount || '-')}</div>
          </div>
          <div style="background: white; padding: 10px; border-radius: 8px;">
            <div style="font-size: 11px; color: #6B7280;">发薪方式</div>
            <div style="font-weight: 500;">${item.paymentMethod === 'CASH' ? '💵 现金' : '🏦 银行汇款'}</div>
          </div>
        </div>
      </div>
    `).join('');
  }
  
  // 渲染离职员工详情列表
  function renderLeftStaffDetailList() {
    if (!_leftStaffAlerts || _leftStaffAlerts.length === 0) {
      return '<div class="empty-state"><div class="empty-icon">📭</div><div class="empty-text">没有离职员工</div></div>';
    }
    
    return _leftStaffAlerts.map(item => `
      <div class="detail-card" style="background: #FEF2F2; border-left: 4px solid #EF4444; padding: 16px; margin-bottom: 12px; border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 48px; height: 48px; border-radius: 50%; background: #9CA3AF; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 600;">
              ${(item.name || '?').charAt(0).toUpperCase()}
            </div>
            <div>
              <div style="font-weight: 600; font-size: 16px; text-decoration: line-through; color: #6B7280;">${escapeHtml(item.name)} ${item.type === 'MANAGER' ? '<span style="font-size:11px;background:#8B5CF6;color:white;padding:2px 6px;border-radius:4px;margin-left:6px;">主管</span>' : ''}</div>
              <div style="font-size: 13px; color: #9CA3AF;">${escapeHtml(item.company || '-')}</div>
            </div>
          </div>
          <span style="background: #FEE2E2; color: #991B1B; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">${item.daysAgo === 0 ? '今天离职' : item.daysAgo + '天前离职'}</span>
        </div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 16px;">
          <div style="background: white; padding: 10px; border-radius: 8px;">
            <div style="font-size: 11px; color: #6B7280;">离职日期</div>
            <div style="font-weight: 600; color: #DC2626;">${escapeHtml(item.leftAt || '-')}</div>
          </div>
          <div style="background: white; padding: 10px; border-radius: 8px;">
            <div style="font-size: 11px; color: #6B7280;">原月薪</div>
            <div style="font-weight: 600;">RM ${Number(item.salary || 0).toLocaleString()}</div>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 8px;">
          <div style="background: white; padding: 10px; border-radius: 8px;">
            <div style="font-size: 11px; color: #6B7280;">银行</div>
            <div style="font-weight: 500;">${escapeHtml(item.bankType || '-')}</div>
            <div style="font-size: 12px; color: #374151;">户名: ${escapeHtml(item.bankHolder || '-')}</div>
            <div style="font-size: 12px; font-family: monospace; color: #6B7280;">账号: ${escapeHtml(item.bankAccount || '-')}</div>
          </div>
          <div style="background: white; padding: 10px; border-radius: 8px;">
            <div style="font-size: 11px; color: #6B7280;">发薪方式</div>
            <div style="font-weight: 500;">${item.paymentMethod === 'CASH' ? '💵 现金' : '🏦 银行汇款'}</div>
          </div>
        </div>
      </div>
    `).join('');
  }
  
  // 渲染加薪详情列表
  function renderSalaryAdjustDetailList() {
    if (!_salaryAdjustAlerts || _salaryAdjustAlerts.length === 0) {
      return '<div class="empty-state"><div class="empty-icon">📭</div><div class="empty-text">近30天暂无调薪</div></div>';
    }
    
    return _salaryAdjustAlerts.map(item => {
      const diffColor = item.diff > 0 ? '#059669' : '#DC2626';
      const diffBg = item.diff > 0 ? '#D1FAE5' : '#FEE2E2';
      const diffSign = item.diff > 0 ? '+' : '';
      
      return `
        <div class="detail-card" style="background: #EFF6FF; border-left: 4px solid #3B82F6; padding: 16px; margin-bottom: 12px; border-radius: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="width: 48px; height: 48px; border-radius: 50%; background: ${item.isManager ? 'linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%)' : getAvatarColor(item.staffName)}; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 600;">
                ${(item.staffName || '?').charAt(0).toUpperCase()}
              </div>
              <div>
                <div style="font-weight: 600; font-size: 16px;">${escapeHtml(item.staffName)} ${item.isManager ? '<span style="font-size:11px;background:#8B5CF6;color:white;padding:2px 6px;border-radius:4px;margin-left:6px;">主管</span>' : ''}</div>
                <div style="font-size: 13px; color: #6B7280;">生效日期: ${escapeHtml(item.changeDate || '-')}</div>
              </div>
            </div>
            <span style="background: ${diffBg}; color: ${diffColor}; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">${item.daysAgo === 0 ? '今天' : item.daysAgo + '天前'}</span>
          </div>
          <div style="display: flex; align-items: center; justify-content: center; gap: 16px; margin-top: 16px; padding: 16px; background: white; border-radius: 8px;">
            <div style="text-align: center;">
              <div style="font-size: 11px; color: #6B7280;">旧月薪</div>
              <div style="font-size: 20px; font-weight: 600; color: #6B7280;">RM ${Number(item.oldSalary || 0).toLocaleString()}</div>
            </div>
            <div style="font-size: 24px; color: #9CA3AF;">→</div>
            <div style="text-align: center;">
              <div style="font-size: 11px; color: #6B7280;">新月薪</div>
              <div style="font-size: 20px; font-weight: 700; color: ${diffColor};">RM ${Number(item.newSalary || 0).toLocaleString()}</div>
            </div>
          </div>
          <div style="margin-top: 12px; display: flex; justify-content: center; gap: 16px;">
            <span style="background: ${diffBg}; color: ${diffColor}; padding: 6px 16px; border-radius: 20px; font-weight: 600;">
              ${diffSign}RM ${Math.abs(item.diff || 0).toLocaleString()} (${diffSign}${item.percent}%)
            </span>
          </div>
          ${item.changeNote ? `<div style="margin-top: 12px; padding: 10px 12px; background: #F3F4F6; border-radius: 6px; font-size: 13px; color: #4B5563; text-align: center;">📝 ${escapeHtml(item.changeNote)}</div>` : ''}
        </div>
      `;
    }).join('');
  }

  // ========== 公开 API ==========
  return {
    init,
    handleLogin,
    handleLogout,
    navigateTo,
    showModal,
    closeModal,
    
    // 工资录入
    onStaffSelect,
    onDeductionTypeChange,
    handleAddSalary,
    handleBatchSalary,
    
    // 草稿管理
    loadDrafts,
    toggleDraftSelectAll,
    openEditDraft,
    closeEditModal,
    saveDraftEdit,
    deleteDraft,
    deleteSelectedDrafts,
    submitAllDrafts,
    
    // 员工出粮
    loadEmployeePayments,
    filterPayments,
    toggleSelectAll,
    toggleSelectAllCards,
    updateSelectedCount,
    markSelectedCardsPaid,
    quickMarkPaid,
    markPaid,
    markSelectedPaid,
    
    // 主管出粮
    loadManagerPayments,
    toggleSelectAllMgrCards,
    updateMgrSelectedCount,
    markSelectedMgrCardsPaid,
    
    // 员工管理
    loadStaffPage,
    filterStaffList,
    setStaffFilter,
    showAddStaffModal,
    saveNewStaff,
    editStaff,
    saveStaffEdit,
    setDebt,
    saveDebtSettings,
    setLeave,
    confirmLeave,
    updateLeaveNetSalary,
    calculateLeaveSalary,
    showAdjustSalary,
    updateAdjustSalaryDiff,
    saveAdjustSalary,
    
    // 主管管理
    loadManagersPage,
    showAddManagerModal,
    saveNewManager,
    editManager,
    saveManagerEdit,
    setManagerDebt,
    setManagerLeave,
    filterManagerList,
    setManagerFilter,
    
    // 可搜索下拉框
    openStaffDropdown,
    filterStaffDropdown,
    selectStaffOption,
    
    // 账号管理
    loadUsersPage,
    showAddUserModal,
    handleAddUser,
    resetUserPassword,
    confirmResetPassword,
    disableUser,
    enableUser,
    
    // 日志
    loadLogs,
    
    // 历史记录
    loadHistory,
    
    // 密码
    openPasswordModal,
    closePasswordModal,
    checkPasswordStrength,
    handleChangePassword,
    
    // 汇款汇总
    showBankSummary,
    closeBankSummaryModal,
    copyBankSummary,
    
    // 书记详情
    showSecretaryDetail,
    closeSecretaryDetailModal,
    filterStaffBySecretary,
    
    // 银行变更详情
    showBankChangeDetail,
    closeBankChangeDetailModal,
    showAlertDetail,
    
    // 排序和分页
    sortStaffList,
    sortManagerList,
    setStaffPage,
    setManagerPage,
    
    // 仪表板刷新
    refreshDashboard,
    
    // 快捷金额和验证
    addQuickAmount,
    setQuickAmount,
    validateSalaryInput,
    
    // 出粮筛选
    clearPaymentFilters,
    
    // 工具
    showToast,
    showLoading,
    hideLoading,
    showSuccessAnimation,
  };
})();

// ========== 页面加载后初始化 ==========
window.addEventListener('load', App.init);
</script>
</body>
</html>
